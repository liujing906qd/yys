[General]
SyntaxVersion=2
BeginHotkey=121
BeginHotkeyMod=0
PauseHotkey=0
PauseHotkeyMod=0
StopHotkey=123
StopHotkeyMod=0
RunOnce=1
EnableWindow=
MacroID=ca1aef41-2838-41fe-88d3-d83ddba4350a
Description=阴阳师_自动备份_自动备份_自动备份_自动备份_自动备份
Enable=1
AutoRun=0
[Repeat]
Type=1
Number=1
[SetupUI]
Type=1
QUI=主窗体
[Relative]
SetupOCXFile=
[Comment]

[UIPackage]
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


[Script]
Dim Hwnd//窗口句柄
Dim XY
Dim FILE_PATH
FILE_PATH = "C:\阴阳师脚本\"
LogStart FILE_PATH+"my.log"

PutAttachment "C:\阴阳师脚本","AE.dll"
Private Declare Function AeStartup Lib "C:\阴阳师脚本\AE.dll" () As Long//免注册功能
If (AeStartup() = 0) Then
    Call MsgBox("AE免注册初始化失败！", vbCritical, "VBdemo")
    EndScript
End If
Set ae_obj = CreateObject("AE.AeSoft")
Delay 500
hwnd = ae_obj.GetMousePointWindow()
result = ae_obj.BindWindow(hwnd, "ogl1", "windows3", "windows", 0)
If (result = 1) Then 
    call log("绑定成功，句柄为："&hwnd)
Else 
    Call MsgBox("绑定错误", vbCritical, "VBdemo")
    Set ae_obj = Nothing
    EndScript
End If
Delay 500
ae_obj.SetPath ("E:\Program Files (x86)\按键精灵\按键精灵2014\Resource")


//If (主窗体.自动剧情副本.Value And 主窗体.自动剧情错误次数.Value + 1 <= StoryFailCount )Then 
//    Call StoryMission()
//End If
//
//If (主窗体.自动探索副本.Value)Then 
//    Call MonsterMission()
//End If
//
//If (主窗体.自动组队副本.Value)Then 
//    Call PVETeamMession()
//End If


//Call MonsterMission()
//Call StoryMission()

//Call FindNPCToFight()
//Call FindBossBox()

//Call TestAEPlugin()
//Call 测试组队()

//PVE的关卡进入
Function PVETeamMession()
    ToolSetCheckBox("主界面-卷轴")
    ToolFindPicWhile10Sec("主界面-组队")
    Delay 500
    If ToolFindPic("御魂-未勾选") = False Then 
        Call ToolDragMove(230, 400, 230, 140)
        Delay 500
    End If
    ToolSetCheckBox("御魂")
    ToolSetCheckBox("第2层")
    ToolFindPicWhile10Sec ("创建队伍")
    Rem 创建
    ToolFindPicWhile10Sec ("创建")
    result = ToolFindPicWhile120Sec("开始战斗-已勾选")
    If (result) Then 
        Call PVEFight()
    Else 
        Log("错误，组队等待超时")
        Log("错误，组队等待超时")
        Log ("错误，组队等待超时")
        Goto 创建
    End If
End Function

//PVE的战斗
Function PVEFight()
    Do
        ToolFindPicWhile20Sec("战斗准备")
        resultForZuduiFight = FindFightEnd()
        If (resultForZuduiFight) Then 
            ToolFindPicWhile10Sec ("确定")
            call PVEFight()
        End If
        Delay 500
    Loop While resultForZuduiFight = false
End Function

//自动探索副本
Function MonsterMission()
    Call ToolMoveToClick(522,120)
        For 100
            result = ToolFindPicWhile10Sec("怪物-关卡-"&(主窗体.目标探索关卡.ListIndex+1))
            If result Then 
                Delay 3000
                result = ToolFindPicWhile10Sec("经验-探索")
                If result = true Then 
                    If FindNPCToFight() Then 
                    	Call ToolFindPicByRectWhile10Sec("怪物-地图-返回(新)|怪物-地图-返回(新)2|怪物-地图-返回(新)|怪物-地图-返回(新)3|怪物-地图-返回(新)|怪物-地图-返回(新)4|怪物-地图-返回(新)5",55,5,90,40)
                    End If
                End If
            End If
        Next
End Function


//剧情任务
Function StoryMission()
    Log("开始剧情副本")
    主窗体.当前战斗失败次数.Caption = 0
    StoryMission = False
    secend = 5 * 60
    loopStoryMission = False
    Do While loopStoryMission = False
        secend = secend - 1
        ToolFindPicClick("剧情-跳过")
        ToolFindPicClick("剧情-对话")
        ToolFindPicClick("剧情-快进")
        ToolFindPicClick("剧情-眼")
        ToolFindPicClick("剧情-问号")
        ToolFindPicClick("可攻击怪物标志")
        ToolFindPicClick("可攻击怪物标志2")
        result = ToolFindPicClick("战斗准备")
        If result = true Then 
            If (FindFightEnd()) Then //进入战斗
            	
            Else 
                主窗体.当前战斗失败次数.Caption = StoryFailCount
                If (主窗体.自动剧情错误次数.Value + 1 <= StoryFailCount) Then 
                    Exit Function
                End If
            End If
        End If
        result = ToolFindPicClick("剧情-终止")
        If result = true Then 
            Log("剧情终止，退出剧情任务")
            loopStoryMission = True
            StoryMission =True
        End If
        If secend = 0 Then 
            Log("超时，剧情终止，退出剧情任务")
            Log("超时，剧情终止，退出剧情任务")
            Log("超时，剧情终止，退出剧情任务")
            loopStoryMission = True
            StoryMission = False
        End If
        Delay 500
        Call GotoRightSide()
        //        Call ToolMoveToClick(100,100)//避免新NPC出现卡住
    Loop  
End Function

//搜寻可战斗的NPC
Function FindNPCToFight()
    loopForFindNPCToFight = False
    notCheckResult = False
    isCheckResult = False
    gotoRightSideCount = 5
    gotoLeftSideCount = 0
    
    Call ToolSetCheckBox("战斗锁定出战")
    
    Do While loopForFindNPCToFight = False
        resultForFoundBoss = ToolFindPicClick("可攻击BOSS标志")
        If resultForFoundBoss = true Then 
            fightBossResult = FindFightEnd()//战斗
        End If
        resultForFoundNPC = ToolFindPicClick("可攻击怪物标志")
        If resultForFoundNPC = true Then 
            fightNPCResult = FindFightEnd()//战斗
            Call Log("攻击小怪成功后，判断当前页面是否还有小怪或者BOSS")
            If (fightNPCResult And (resultForFoundBoss = False OR resultForFoundNPC = False)) Then 
                Call Log("没有，则向右移动")
                Call GotoRightSide()//向右移动
                If FindBossBox() Then //找BOSS宝箱
                    Exit Function
                End If
            End If
        ElseIf fightBossResult Then
            Call Log("BOSS战结束后，检查当前是否有宝箱")
            
            If FindBossBox() Then //找BOSS宝箱
                Exit Function
            End If
        End If
        If resultForFoundBoss = False And resultForFoundNPC = False Then 
            Call Log("没有搜索到小怪和BOSS，向右移动")
            Call GotoRightSide()//向右移动
        End If
        If FindBossBox() Then //找BOSS宝箱
            Exit Function
        End If
        Delay 3000
    Loop
    FindNPCToFight = result
End Function

//查找BOSS宝箱
Function FindBossBox()
    FindBossBox = False//至少找到过一次（隐含逻辑是这个副本将会结束）
    Do
        result = ToolFindPicClick("经验-结束宝箱")
        If result = true Then 
            Delay 1500
            Log("开启宝箱，点击左上角退出宝箱界面")
            Call ToolMoveToClick(70, 70)
            FindBossBox = True
            Delay 1500
        Else 
            Log ("没有找到宝箱")
        End If
    Loop While result = True
End Function

//向右移动，如果网游次数超过10次，则向左移动
Function GotoRightSide()
    Log(gotoRightSideCount)
    If (gotoRightSideCount > 0) Then 
        Call ToolDragMove(900,400,100,400)
        gotoRightSideCount = gotoRightSideCount - 1
    Elseif(gotoLeftSideCount > 0)
        Call ToolDragMove(100,400,900,400)
        gotoLeftSideCount = gotoLeftSideCount - 1
    Else 
        gotoLeftSideCount = 5
        gotoRightSideCount = 5
    End If
End Function

//等待战斗结束
Function FindFightEnd()
    Log("进入战斗")
    loopFindFightEndRepeatCount = 5 * 60
    loopFindFightEnd = False
    
    Call ToolSetCheckBox("战斗模式自动")
    
    Do While loopFindFightEnd = False
        loopFindFightEndRepeatCount = loopFindFightEndRepeatCount - 1
        loopFindFightEnd = ToolFindPicClick("战斗结束-胜利1")
        If loopFindFightEnd = true  Then 
            Log("战斗胜利")
            Delay 3000
            ToolFindPicWhile10Sec("战斗结束-胜利2")
            Delay 3000
            ToolFindPicWhile10Sec("战斗结束-胜利3")
            FindFightEnd = True
        Else 
            loopFindFightEnd = ToolFindPicClick("战斗结束-失败")
            If loopFindFightEnd = true Then 
                Log("战斗失败")
                FindFightEnd = False
            End If
            If loopFindFightEndRepeatCount = 0 Then 
                loopFindFightEnd = True
                FindFightEnd = True
                Log("战斗结束，但是因为超时！")
                Log("战斗结束，但是因为超时！")
                Log("战斗结束，但是因为超时！")
                Log("战斗结束，但是因为超时！")
            End If
        End If
        Delay 1000
    Loop  
End Function

















//设置选中框，尝试10次，成功设置返回true
Function ToolSetCheckBox(bpmSrc)
    notCheckResult = False
    isCheckResult = False
    ToolSetCheckBox = False
    repeatCount = 10
    Do While (repeatCount <> 0)
        repeatCount = repeatCount  - 1
        ToolFindPicClick (bpmSrc & "-未勾选")//先找到未勾选然后直接点
        Delay 500
        isCheckResult = ToolFindPic(bpmSrc&"-已勾选")//再获取是否已勾选状态
        notCheckResult = ToolFindPicClick(bpmSrc & "-未勾选")//最后在获取是不是未勾选
        If notCheckResult = False And isCheckResult = True Then 
            repeatCount = 0
            ToolSetCheckBox = True
        End If
    Loop
End Function

//查找图片工具
Function ToolFindPicClick(bmpSrc)
    If ToolFindPic(bmpSrc) Then 
        ToolFindPicClick = ToolPicClick(bmpSrc)
    Else 
        ToolFindPicClick = False
    End If
End Function

Function ToolFindPic(bmpSrc)
    Call ae_obj.FindPic(0, 0, 1088, 700, bmpSrc + ".bmp", "050505", 0.7, 0, intX, intY)
    ToolFindPic = intX > 0 And intY > 0
    If intX > 0 And intY > 0 Then 
        //        TracePrint("找到了：" & bmpSrc & " X:" & intX & " Y:" & intY)
        Log("找到了：" & bmpSrc & " X:" & intX & " Y:" & intY)
    Else 
        //        TracePrint("没找到：" & bmpSrc)
        Log("没找到：" & bmpSrc)
    End If
End Function

Function ToolFindPicClickByRect(bmpSrc,xStart,yStart,xEnd,yEnd)
    Call ae_obj.FindPic(xStart, yStart, xEnd, yEnd, bmpSrc + ".bmp", "050505", 0.7, 0, intX, intY)
    If intX > 0 And intY > 0 Then 
        ToolFindPicClickByRect = ToolPicClick(bmpSrc)
        Log("找到了：" & bmpSrc & " X:" & intX & " Y:" & intY)
    Else 
        Log("没找到：" & bmpSrc)
    End If
End Function

Function ToolPicClick(bmpSrc)
    Delay 50
    Call ae_obj.MoveTo(intX, intY)
    Delay 50
    call ae_obj.LeftClick()
    ToolPicClick = True
    Delay 1000
End Function

//移动并点击XY
Function ToolMoveToClick(X, Y)
    Call ae_obj.MoveTo(X, Y)
    Call ae_obj.LeftClick()
End Function

//在10秒内尝试查找图片
Function ToolFindPicWhile10Sec(bmpSrc)
    ToolFindPicWhile10Sec = ToolFindPicWhileSec(bmpSrc, 10)
End Function

//在20秒内尝试查找图片
Function ToolFindPicWhile20Sec(bmpSrc)
    ToolFindPicWhile30Sec = ToolFindPicWhileSec(bmpSrc, 20)
End Function


//在10秒内尝试查找图片
Function ToolFindPicWhile120Sec(bmpSrc)
    ToolFindPicWhile120Sec = ToolFindPicWhileSec(bmpSrc, 120)
End Function


//根据对应时间尝试查找图片
Function ToolFindPicWhileSec(bmpSrc, secend)
    result = ToolFindPicClick(bmpSrc)
    If result = false Then 
        secend = secend - 1
        If secend <> 0 Then 
            Delay 1000
            ToolFindPicWhileSec = ToolFindPicWhileSec(bmpSrc, secend)
        End If
    Else 
        ToolFindPicWhileSec = True
    End If
End Function

//在10秒内尝试查找图片
Function ToolFindPicByRectWhile10Sec(bmpSrc,xStart,yStart,xEnd,yEnd)
    ToolFindPicByRectWhile10Sec = ToolFindPicByRectWhileSec(bmpSrc,xStart,yStart,xEnd,yEnd,10)
End Function

//根据对应时间尝试查找图片，在矩形内
Function ToolFindPicByRectWhileSec(bmpSrc,xStart,yStart,xEnd,yEnd,secend)
    result = ToolFindPicClickByRect(bmpSrc,xStart,yStart,xEnd,yEnd)
    If result = false Then 
        secend = secend - 1
        If secend <> 0 Then 
            Delay 1000
            ToolFindPicByRectWhileSec = ToolFindPicByRectWhileSec(bmpSrc,xStart,yStart,xEnd,yEnd,secend)
        End If
    Else 
        ToolFindPicByRectWhileSec = True
    End If
End Function

//根据对应时间尝试查找图片,这个方法只给测试用，性能很差
Function ToolFindPicWhileSecOnlyFor(bmpSrc, secend)
    result = ToolFindPic(bmpSrc)
    If result = false Then 
        secend = secend - 1
        If secend <> 0 Then 
            Delay 1
            ToolFindPicWhileSecOnlyFor = ToolFindPicWhileSecOnlyFor(bmpSrc, secend)
        End If
    Else 
        ToolFindPicWhileSecOnlyFor = True
    End If
End Function

Function ToolDragMove(formX, formY, toX, toY)
    setpX = 0
    setpY = 0
    allSetp = 0
    offsetX = formX - toX
    offsetY = formY - toY
    Call ae_obj.MoveTo(formX, formY)
    Delay 5
    Call ae_obj.LeftDown()
    If offsetX > offsetY Then 
        allSetp = offsetX
    Else 
        allSetp = offsetY
    End If
    For allSetp
        If (setpX < offsetX) Then 
            If (formX > toX) Then 
                finalX= formX - setpX 
            Else 
                finalX= formX + setpX 
            End If
        End If
        If (setpY < offsetY) Then 
            If (formY > toY) Then 
                finalY= formY - setpY
            Else 
                finalY= formY + setpY
            End If
        End If
        Call ae_obj.MoveTo(finalX, finalY)
        setpX = setpX + 1
        setpY = setpY + 1
        Delay 1
    Next
    Delay 5
    Call ae_obj.LeftUp()
    Delay 5
End Function

Function Log(text)
    TracePrint text
    主窗体.日志框.Text = text & vbcrlf & 主窗体.日志框.Text
End Function

//释放对象
Sub OnScriptExit()
    Set ae_obj = Nothing
    LogStop
End Sub

Function TestAEPlugin()
    result = ae_obj.Capture(0, 0, 2000, 2000, "screen.bmp")
    If (result = 1) Then
        RunApp "E:\Program Files (x86)\按键精灵\按键精灵2014\Resource\screen.bmp"
    End If
End Function

Function TestGotoSereach()
    gotoRightSideCount = 5
    gotoLeftSideCount = 5
    Do While True
        Call GotoRightSide()
    Loop
End Function

Function 测试组队
    ToolSetCheckBox ("觉醒业火轮")
    ToolSetCheckBox ("觉醒风转轮")
    ToolSetCheckBox ("觉醒水灵轮")
    ToolSetCheckBox ("觉醒天雷轮")
    ToolSetCheckBox ("御魂")
    index = 1
    For 10
        ToolSetCheckBox ("第"&index&"层")
        index = index +1
    Next
End Function

Event 主窗体.自动剧情错误次数.Slide
    主窗体.自动剧情错误次数LB.Caption = 主窗体.自动剧情错误次数.Value + 1
End Event
Event 主窗体.LoadOver
    主窗体.自动剧情错误次数LB.Caption = 主窗体.自动剧情错误次数.Value + 1
    Call Log("窗体内容加载完毕")
End Event

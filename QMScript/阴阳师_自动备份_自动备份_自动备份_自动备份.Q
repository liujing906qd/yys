[General]
SyntaxVersion=2
BeginHotkey=121
BeginHotkeyMod=0
PauseHotkey=0
PauseHotkeyMod=0
StopHotkey=123
StopHotkeyMod=0
RunOnce=1
EnableWindow=
MacroID=ca1aef41-2838-41fe-88d3-d83ddba4350a
Description=阴阳师_自动备份_自动备份_自动备份_自动备份
Enable=1
AutoRun=0
[Repeat]
Type=1
Number=1
[SetupUI]
Type=1
QUI=主窗体
[Relative]
SetupOCXFile=
[Comment]

[UIPackage]
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


[Script]
Dim Hwnd//窗口句柄
Dim XY
Dim FILE_PATH
FILE_PATH = "C:\阴阳师脚本\"
LogStart FILE_PATH+"my.log"

PutAttachment "C:\阴阳师脚本","AE.dll"
Private Declare Function AeStartup Lib "C:\阴阳师脚本\AE.dll" () As Long//免注册功能
If (AeStartup() = 0) Then
    Call MsgBox("AE免注册初始化失败！", vbCritical, "VBdemo")
    EndScript
End If
Set ae_obj = CreateObject("AE.AeSoft")
Delay 500
hwnd = ae_obj.GetMousePointWindow()
result = ae_obj.BindWindow(hwnd, "ogl1", "windows3", "windows", 0)
If (result = 1) Then 
    call log("绑定成功，句柄为："&hwnd)
Else 
    Call MsgBox("绑定错误", vbCritical, "VBdemo")
    Set ae_obj = Nothing
    EndScript
End If
Delay 500
ae_obj.SetPath ("E:\Program Files (x86)\按键精灵\按键精灵2014\Resource")




//Call StoryMission()
//
//Call MonsterMission()
//
//Call PVETeamMession()


//Call MonsterMission()
//Call StoryMission()

//Call FindNPCToFight()
//Call FindBossBox()

//Call TestAEPlugin()
//Call 测试组队()

//PVE的关卡进入
Function PVETeamMession()
    If (主窗体.自动组队副本.Value =false)Then 
        Exit Function
    End If
    ToolSetCheckBox("主界面-卷轴")
    ToolFindPicWhile10Sec("主界面-组队")
    Delay 500
    If ToolFindPic("御魂-未勾选") = False Then 
        Call ToolDragMove(230, 400, 230, 140)
        Delay 500
    End If
    ToolSetCheckBox("御魂")
    ToolSetCheckBox("第2层")
    ToolFindPicWhile10Sec ("创建队伍")
    Rem 创建
    ToolFindPicWhile10Sec ("创建")
    result = ToolFindPicWhile120Sec("开始战斗-已勾选")
    If (result) Then 
        Call PVEFight()
    Else 
        Log("错误，组队等待超时")
        Log("错误，组队等待超时")
        Log ("错误，组队等待超时")
        Goto 创建
    End If
End Function

//PVE的战斗
Function PVEFight()
    Do
        ToolFindPicWhile20Sec("战斗准备")
        resultForZuduiFight = FindFightEnd()
        If (resultForZuduiFight) Then 
            ToolFindPicWhile10Sec ("确定")
            call PVEFight()
        End If
        Delay 500
    Loop While resultForZuduiFight = false
End Function

//自动探索副本
Function MonsterMission()
    If (主窗体.自动探索副本.Value = false)Then 
        Exit Function
    End If
    Call ToolMoveToClick(522,120)
    For 100
        result = ToolFindPicWhile10Sec("怪物-关卡-"&(主窗体.目标探索关卡.ListIndex+1))
        If result Then 
            Delay 3000
            result = ToolFindPicWhile10Sec("经验-探索")
            If result = true Then 
                If FindNPCToFight() Then
                    If 主窗体.探索副本是否优先剧情副本.Value Then 
                        Log("当前是否有剧情副本")
                        If ToolFindPicByRectWhile10Sec("怪物-地图-返回(新)|怪物-地图-返回(新)2|怪物-地图-返回(新)|怪物-地图-返回(新)3|怪物-地图-返回(新)|怪物-地图-返回(新)4|怪物-地图-返回(新)5", 55, 5, 90, 40) Then 
                            Log("有剧情副本，退出到主界面。等待自动副本开始")
                            Exit Function
                        Else 
                            Log("没有，继续探索副本")
                        End If
                    End If
                End If
            End If
        End If
    Next
End Function


//剧情任务
Function StoryMission()
    If (主窗体.自动剧情副本.Value = False or 主窗体.自动剧情错误次数.Value + 1 > StoryFailCount)Then 
        Exit Function
    End If
    Log("开始剧情副本")
    主窗体.当前战斗失败次数.Caption = 0
    StoryMission = False
    secend = 5 * 60
    loopStoryMission = False
    Do While loopStoryMission = False
        secend = secend - 1
        ToolFindPicClick("剧情-跳过")
        ToolFindPicClick("剧情-对话")
        ToolFindPicClick("剧情-快进")
        ToolFindPicClick("剧情-眼")
        ToolFindPicClick("剧情-问号")
        ToolFindPicClick("可攻击怪物标志")
        ToolFindPicClick("可攻击怪物标志2")
        result = ToolFindPicClick("战斗准备")
        If result = true Then 
            If (FindFightEnd()) Then //进入战斗
            	
            Else 
                主窗体.当前战斗失败次数.Caption = StoryFailCount
                If (主窗体.自动剧情错误次数.Value + 1 <= StoryFailCount) Then 
                    Exit Function
                End If
            End If
        End If
        result = ToolFindPicClick("剧情-终止")
        If result = true Then 
            Log("剧情终止，退出剧情任务")
            loopStoryMission = True
            StoryMission =True
        End If
        If secend = 0 Then 
            Log("超时，剧情终止，退出剧情任务")
            Log("超时，剧情终止，退出剧情任务")
            Log("超时，剧情终止，退出剧情任务")
            loopStoryMission = True
            StoryMission = False
        End If
        Delay 500
        Call GotoRightSide()
        //        Call ToolMoveToClick(100,100)//避免新NPC出现卡住
    Loop  
End Function

//搜寻可战斗的NPC
Function FindNPCToFight()
    loopForFindNPCToFight = False
    notCheckResult = False
    isCheckResult = False
    gotoRightSideCount = 5
    gotoLeftSideCount = 0
    
    Log("开始搜索可战斗的怪物")
    
    Call ToolSetCheckBox("战斗锁定出战")
    
    Do While loopForFindNPCToFight = False
        resultForFoundBoss = ToolFindPicClick("可攻击BOSS标志")
        If resultForFoundBoss = true Then 
            fightBossResult = FindFightEnd()//战斗
        End If
        resultForFoundNPC = ToolFindPicClick("可攻击怪物标志")
        If resultForFoundNPC = true Then 
            fightNPCResult = FindFightEnd()//战斗
            Call Log("攻击小怪成功后，判断当前页面是否还有小怪或者BOSS")
            If (fightNPCResult And (resultForFoundBoss = False OR resultForFoundNPC = False)) Then 
                Call Log("没有，则向右移动")
                Call GotoRightSide()//向右移动
                Exit Do
            End If
        ElseIf fightBossResult Then
            Call Log("BOSS战结束后，检查当前是否有宝箱")
            Exit Do
        End If
        If resultForFoundBoss = False And resultForFoundNPC = False Then 
            Call Log("没有搜索到小怪和BOSS，向右移动")
            Call GotoRightSide()//向右移动
        End If
        If FindBossBox() Then //找BOSS宝箱
            FindNPCToFight = True
            Exit Function
        End If
        Delay 3000
    Loop
    If FindBossBox() Then //找BOSS宝箱
        FindNPCToFight = True
        Exit Function
    End If
    
End Function

//查找BOSS宝箱
Function FindBossBox()
    FindBossBox = False//至少找到过一次（隐含逻辑是这个副本将会结束）
    Do
        result = ToolFindPicClick("经验-结束宝箱")
        If result = true Then 
            Delay 1500
            Log("开启宝箱，点击左上角退出宝箱界面")
            Call ToolMoveToClick(70, 70)
            FindBossBox = True
            Delay 1500
        Else 
            Log ("没有找到宝箱")
        End If
    Loop While result = True
End Function

//向右移动，如果网游次数超过10次，则向左移动
Function GotoRightSide()
    Log(gotoRightSideCount)
    If (gotoRightSideCount > 0) Then 
        Call ToolDragMove(900,400,100,400)
        gotoRightSideCount = gotoRightSideCount - 1
    Elseif(gotoLeftSideCount > 0)
        Call ToolDragMove(100,400,900,400)
        gotoLeftSideCount = gotoLeftSideCount - 1
    Else 
        gotoLeftSideCount = 5
        gotoRightSideCount = 5
    End If
End Function

//等待战斗结束
Function FindFightEnd()
    Log("进入战斗")
    loopFindFightEndRepeatCount = 5 * 60
    loopFindFightEnd = False
    
    Call ToolSetCheckBox("战斗模式自动")
    
    Do While loopFindFightEnd = False
        loopFindFightEndRepeatCount = loopFindFightEndRepeatCount - 1
        loopFindFightEnd = ToolFindPicClick("战斗结束-胜利1")
        If loopFindFightEnd = true  Then 
            Log("战斗胜利")
            Delay 3000
            ToolFindPicWhile10Sec("战斗结束-胜利2")
            Delay 3000
            ToolFindPicWhile10Sec("战斗结束-胜利3")
            FindFightEnd = True
        Else 
            loopFindFightEnd = ToolFindPicClick("战斗结束-失败")
            If loopFindFightEnd = true Then 
                Log("战斗失败")
                FindFightEnd = False
            End If
            If loopFindFightEndRepeatCount = 0 Then 
                loopFindFightEnd = True
                FindFightEnd = True
                Log("战斗结束，但是因为超时！")
                Log("战斗结束，但是因为超时！")
                Log("战斗结束，但是因为超时！")
                Log("战斗结束，但是因为超时！")
            End If
        End If
        Delay 1000
    Loop  
End Function

















//设置选中框，尝试10次，成功设置返回true
Function ToolSetCheckBox(bpmSrc)
    notCheckResult = False
    isCheckResult = False
    ToolSetCheckBox = False
    repeatCount = 10
    Do While (repeatCount <> 0)
        repeatCount = repeatCount  - 1
        ToolFindPicClick (bpmSrc & "-未勾选")//先找到未勾选然后直接点
        Delay 500
        isCheckResult = ToolFindPic(bpmSrc&"-已勾选")//再获取是否已勾选状态
        notCheckResult = ToolFindPicClick(bpmSrc & "-未勾选")//最后在获取是不是未勾选
        If notCheckResult = False And isCheckResult = True Then 
            repeatCount = 0
            ToolSetCheckBox = True
        End If
    Loop
End Function

//查找图片工具
Function ToolFindPicClick(bmpSrc)
    If ToolFindPic(bmpSrc) Then 
        ToolFindPicClick = ToolPicClick(bmpSrc)
    Else 
        ToolFindPicClick = False
    End If
End Function

Function ToolFindPic(bmpSrc)
    Call ae_obj.FindPic(0, 0, 1088, 700, bmpSrc + ".bmp", "050505", 0.7, 0, intX, intY)
    ToolFindPic = intX > 0 And intY > 0
    If intX > 0 And intY > 0 Then 
        //        TracePrint("找到了：" & bmpSrc & " X:" & intX & " Y:" & intY)
        Log("找到了：" & bmpSrc & " X:" & intX & " Y:" & intY)
    Else 
        //        TracePrint("没找到：" & bmpSrc)
        Log("没找到：" & bmpSrc)
    End If
End Function

Function ToolFindPicClickByRect(bmpSrc,xStart,yStart,xEnd,yEnd)
    Call ae_obj.FindPic(xStart, yStart, xEnd, yEnd, bmpSrc + ".bmp", "050505", 0.7, 0, intX, intY)
    If intX > 0 And intY > 0 Then 
        ToolFindPicClickByRect = ToolPicClick(bmpSrc)
        Log("找到了：" & bmpSrc & " X:" & intX & " Y:" & intY)
    Else 
        Log("没找到：" & bmpSrc)
    End If
End Function

Function ToolPicClick(bmpSrc)
    Delay 50
    Call ae_obj.MoveTo(intX, intY)
    Delay 50
    call ae_obj.LeftClick()
    ToolPicClick = True
    Delay 1000
End Function

//移动并点击XY
Function ToolMoveToClick(X, Y)
    Call ae_obj.MoveTo(X, Y)
    Call ae_obj.LeftClick()
End Function

//在10秒内尝试查找图片
Function ToolFindPicWhile10Sec(bmpSrc)
    ToolFindPicWhile10Sec = ToolFindPicWhileSec(bmpSrc, 10)
End Function

//在20秒内尝试查找图片
Function ToolFindPicWhile20Sec(bmpSrc)
    ToolFindPicWhile30Sec = ToolFindPicWhileSec(bmpSrc, 20)
End Function


//在10秒内尝试查找图片
Function ToolFindPicWhile120Sec(bmpSrc)
    ToolFindPicWhile120Sec = ToolFindPicWhileSec(bmpSrc, 120)
End Function


//根据对应时间尝试查找图片
Function ToolFindPicWhileSec(bmpSrc, secend)
    result = ToolFindPicClick(bmpSrc)
    If result = false Then 
        secend = secend - 1
        If secend <> 0 Then 
            Delay 1000
            ToolFindPicWhileSec = ToolFindPicWhileSec(bmpSrc, secend)
        End If
    Else 
        ToolFindPicWhileSec = True
    End If
End Function

//在10秒内尝试查找图片
Function ToolFindPicByRectWhile10Sec(bmpSrc,xStart,yStart,xEnd,yEnd)
    ToolFindPicByRectWhile10Sec = ToolFindPicByRectWhileSec(bmpSrc,xStart,yStart,xEnd,yEnd,10)
End Function

//根据对应时间尝试查找图片，在矩形内
Function ToolFindPicByRectWhileSec(bmpSrc,xStart,yStart,xEnd,yEnd,secend)
    result = ToolFindPicClickByRect(bmpSrc,xStart,yStart,xEnd,yEnd)
    If result = false Then 
        secend = secend - 1
        If secend <> 0 Then 
            Delay 1000
            ToolFindPicByRectWhileSec = ToolFindPicByRectWhileSec(bmpSrc,xStart,yStart,xEnd,yEnd,secend)
        End If
    Else 
        ToolFindPicByRectWhileSec = True
    End If
End Function

//根据对应时间尝试查找图片,这个方法只给测试用，性能很差
Function ToolFindPicWhileSecOnlyFor(bmpSrc, secend)
    result = ToolFindPic(bmpSrc)
    If result = false Then 
        secend = secend - 1
        If secend <> 0 Then 
            Delay 1
            ToolFindPicWhileSecOnlyFor = ToolFindPicWhileSecOnlyFor(bmpSrc, secend)
        End If
    Else 
        ToolFindPicWhileSecOnlyFor = True
    End If
End Function

Function ToolDragMove(formX, formY, toX, toY)
    setpX = 0
    setpY = 0
    allSetp = 0
    offsetX = formX - toX
    offsetY = formY - toY
    Call ae_obj.MoveTo(formX, formY)
    Delay 5
    Call ae_obj.LeftDown()
    If offsetX > offsetY Then 
        allSetp = offsetX
    Else 
        allSetp = offsetY
    End If
    For allSetp
        If (setpX < offsetX) Then 
            If (formX > toX) Then 
                finalX= formX - setpX 
            Else 
                finalX= formX + setpX 
            End If
        End If
        If (setpY < offsetY) Then 
            If (formY > toY) Then 
                finalY= formY - setpY
            Else 
                finalY= formY + setpY
            End If
        End If
        Call ae_obj.MoveTo(finalX, finalY)
        setpX = setpX + 1
        setpY = setpY + 1
        Delay 1
    Next
    Delay 5
    Call ae_obj.LeftUp()
    Delay 5
End Function

Function Log(text)
    TracePrint text
    主窗体.日志框.Text = text & vbcrlf & 主窗体.日志框.Text
End Function

//释放对象
Sub OnScriptExit()
    Set ae_obj = Nothing
    LogStop
End Sub

Function TestAEPlugin()
    result = ae_obj.Capture(0, 0, 2000, 2000, "screen.bmp")
    If (result = 1) Then
        RunApp "E:\Program Files (x86)\按键精灵\按键精灵2014\Resource\screen.bmp"
    End If
End Function

Function TestGotoSereach()
    gotoRightSideCount = 5
    gotoLeftSideCount = 5
    Do While True
        Call GotoRightSide()
    Loop
End Function

Function 测试组队
    ToolSetCheckBox ("觉醒业火轮")
    ToolSetCheckBox ("觉醒风转轮")
    ToolSetCheckBox ("觉醒水灵轮")
    ToolSetCheckBox ("觉醒天雷轮")
    ToolSetCheckBox ("御魂")
    index = 1
    For 10
        ToolSetCheckBox ("第"&index&"层")
        index = index +1
    Next
End Function

Event 主窗体.自动剧情错误次数.Slide
    主窗体.自动剧情错误次数LB.Caption = 主窗体.自动剧情错误次数.Value + 1
End Event
Event 主窗体.LoadOver
    主窗体.自动剧情错误次数LB.Caption = 主窗体.自动剧情错误次数.Value + 1
    Call Log("窗体内容加载完毕")
End Event

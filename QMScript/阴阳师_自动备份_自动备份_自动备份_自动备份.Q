[General]
SyntaxVersion=2
BeginHotkey=121
BeginHotkeyMod=0
PauseHotkey=19
PauseHotkeyMod=0
StopHotkey=123
StopHotkeyMod=0
RunOnce=1
EnableWindow=
MacroID=ca1aef41-2838-41fe-88d3-d83ddba4350a
Description=阴阳师_自动备份_自动备份_自动备份_自动备份
Enable=1
AutoRun=0
[Repeat]
Type=0
Number=1
[SetupUI]
Type=1
QUI=主窗体
[Relative]
SetupOCXFile=
[Comment]

[UIPackage]
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


[Script]
Dim Hwnd//窗口句柄
Dim XY
Dim FILE_PATH
FILE_PATH = "C:\阴阳师脚本\"
LogStart FILE_PATH+"my.log"

PutAttachment "C:\阴阳师脚本","AE.dll"
Private Declare Function AeStartup Lib "C:\阴阳师脚本\AE.dll" () As Long//免注册功能
If (AeStartup() = 0) Then
    Call MsgBox("AE免注册初始化失败！", vbCritical, "VBdemo")
    EndScript
End If
Set ae_obj = CreateObject("AE.AeSoft")
Delay 500
hwnd = ae_obj.GetMousePointWindow()
result = ae_obj.BindWindow(hwnd, "ogl1", "windows3", "windows", 0)
If (result = 1) Then 
    call log("绑定成功，句柄为："&hwnd)
Else 
    Call MsgBox("绑定错误", vbCritical, "VBdemo")
    Set ae_obj = Nothing
    EndScript
End If
Delay 500
ae_obj.SetPath ("E:\Program Files (x86)\按键精灵\按键精灵2014\Resource")


//Call ToolFindPicWhile10Sec("探索10")

StoryFailCount = 0
Call StoryMission()
Call PVETeamMession()
Call MonsterMission()





//Call MonsterMission()
//Call StoryMission()

//Call FindNPCToFight()
//Call FindBossBox()

//Call TestAEPlugin()
//Call 测试组队()


//PVE的关卡进入
Function PVETeamMession()
    If (主窗体.自动组队副本.Value =false)Then 
        Exit Function
    End If
    Log("组队副本，开始")
    ToolSetCheckBox("主界面-卷轴")
    ToolFindPicWhile10Sec("主界面-组队")
    Delay 500
    If ToolFindPic("组队-" & 主窗体.组队副本关卡.ListIndex +1 & "-未勾选") = False Then 
        Call ToolDragMove(230, 400, 230, 140)
        Delay 500
    End If
    ToolSetCheckBox("组队-"&主窗体.组队副本关卡.ListIndex+1)
    ToolSetCheckBox("第" & 主窗体.组队副本层数.ListIndex+1 & "层")
    ToolFindPicWhile10Sec ("创建队伍")
    Rem 创建
    ToolFindPicWhile10Sec ("创建")
    Rem 等待队友
    Do
        result = ToolFindPic("邀请")
        Delay 500
    Loop While result
    Delay 1000//等待开始按钮变正常
    Do
    	result = ToolFindPicClick("开始战斗-已勾选")
    	Delay 500
    Loop While result
//    If (result) Then FIXME 缺少组队超时的处理。如果搜索不到邀请也搜索不到开始战斗，则认为超时。
        Do
            Do
                result = ToolFindPicWhile20Sec("战斗准备")
            Loop While result
            resultForZuduiFight = FindFightEnd()
            If (resultForZuduiFight) Then 
                Log("继续与上次队友组队")
                ToolFindPicWhile10Sec ("确定")
                Goto 等待队友
            End If
            Delay 500
        Loop While resultForZuduiFight = false
//    Else 
//        Log("错误，组队等待超时")
//        Log("错误，组队等待超时")
//        Log ("错误，组队等待超时")
//        Goto 创建
//    End If
End Function

//自动探索副本
Function MonsterMission()
    If (主窗体.自动探索副本.Value = false)Then 
        Exit Function
    End If
    Log("探索副本，开始")
    Call ToolMoveToClick(522,120)
    For 100
        result = ToolFindPicWhile10Sec("怪物-关卡-"&(主窗体.目标探索关卡.ListIndex+1))
        If result Then 
            Delay 3000
            result = ToolFindPicWhile10Sec("经验-探索")
            If result = true Then 
                If FindNPCToFight() Then
                    If 主窗体.探索副本是否优先剧情副本.Value Then 
                        Log("当前是否有剧情副本")
                        If ToolFindPicByRectWhile10Sec("怪物-地图-返回(新)|怪物-地图-返回(新)2|怪物-地图-返回(新)|怪物-地图-返回(新)3|怪物-地图-返回(新)|怪物-地图-返回(新)4|怪物-地图-返回(新)5", 55, 5, 90, 40) Then 
                            Log("有剧情副本，退出到主界面。等待自动副本开始")
                            Exit Function
                        Else 
                            Log("没有，继续探索副本")
                        End If
                    End If
                End If
            End If
        End If
    Next
End Function

Function setStoryFailCount(value)
    StoryFailCount = value
    主窗体.当前剧情战斗失败次数.Caption = StoryFailCount
End Function

//剧情任务
Function StoryMission()
    Log ("主窗体.自动剧情副本.Value:" & 主窗体.自动剧情副本.Value)
    Log("主窗体.自动剧情错误最大次数滑块.Value:"&主窗体.自动剧情错误最大次数滑块.Value)
    Log("StoryFailCount:"&StoryFailCount)
    If (主窗体.自动剧情副本.Value = False or 主窗体.自动剧情错误最大次数滑块.Value < StoryFailCount)Then 
        Call setStoryFailCount(0)
        Exit Function
    End If
    Log("剧情副本，开始")
    StoryMission = False
    secend = 5 * 60
    loopStoryMission = False
    Do While loopStoryMission = False
        secend = secend - 1
        ToolFindPicClick("剧情-跳过")
        ToolFindPicClick("剧情-对话")
        ToolFindPicClick("剧情-快进")
        ToolFindPicClick("剧情-眼")
        If (isMainSence() = false) Then 
            Call ToolFindPicClick("剧情-问号")
        End If
        ToolFindPicClick("可攻击怪物标志")
        ToolFindPicClick("可攻击怪物标志2")
        result = ToolFindPicClick("战斗准备")
        If result = true Then 
            If (FindFightEnd()) Then //进入战斗
            	
            Else //战斗失败
                If (主窗体.自动剧情错误最大次数滑块.Value < StoryFailCount) Then 
                    Log("剧情战斗失败，超过重试次数"&主窗体.自动剧情错误最大次数滑块.Value)
                    Call setStoryFailCount(0)
                    Exit Function
                Else 
                    Call setStoryFailCount(StoryFailCount + 1)
                    Log("剧情战斗失败，当前失败次数"&StoryFailCount)
                End If
            End If
        End If
        result = ToolFindPicClick("剧情-终止")
        If result = true Then 
            Log("剧情终止，退出剧情任务")
            loopStoryMission = True
            StoryMission =True
        End If
        If secend = 0 Then 
            Log("超时，剧情终止，退出剧情任务")
            Log("超时，剧情终止，退出剧情任务")
            Log("超时，剧情终止，退出剧情任务")
            loopStoryMission = True
            StoryMission = False
        End If
        Delay 500
        Call GotoRightSide()
        //        Call ToolMoveToClick(100,100)//避免新NPC出现卡住
    Loop  
End Function

Function isMainSence()
    isMainSence = ToolFindPic("主界面-卷轴-已勾选|主界面-卷轴-未勾选")
End Function

//搜寻可战斗的NPC
Function FindNPCToFight()
    loopForFindNPCToFight = False
    notCheckResult = False
    isCheckResult = False
    gotoRightSideCount = 5
    gotoLeftSideCount = 0
    
    Log("开始搜索可战斗的怪物")
    Delay 5000
    Call ToolSetCheckBox("战斗锁定出战")
    
    Do While loopForFindNPCToFight = False//只有打完BOSS才会跳出，否则死循环
        resultForFoundBoss = ToolFindPicClick("可攻击BOSS标志")
        If resultForFoundBoss = true Then 
            Log("找到BOSS")
            fightBossResult = FindFightEnd()//战斗
        End If
        resultForFoundNPC = ToolFindPicClick("可攻击怪物标志")
        If resultForFoundNPC = true Then 
            Log("找到小怪")
            fightNPCResult = FindFightEnd()//战斗
            Call Log("攻击小怪成功")
        ElseIf fightBossResult Then
            Log ("loopForFindNPCToFight:" & loopForFindNPCToFight)
            Delay 3000//等待宝箱到位
            If FindBossBox() Then //找BOSS宝箱
                FindNPCToFight = True
                Exit Function
            End If
            Exit Do
        End If
        If resultForFoundBoss = False And resultForFoundNPC = False Then 
            Call Log("没有搜索到小怪和BOSS，向右移动")
            Call GotoRightSide()//向右移动
        End If
        Delay 3000
    Loop
End Function

//查找BOSS宝箱
Function FindBossBox()
    FindBossBox = False//至少找到过一次（隐含逻辑是这个副本将会结束）
    Do
        result = ToolFindPicClick("经验-结束宝箱")
        If result = true Then
            Log("搜索到宝箱") 
            Delay 1500
            Log("开启宝箱，点击左上角退出宝箱界面")
            Call ToolMoveToClick(70, 70)
            FindBossBox = True
            Delay 1500
        Else 
            Log ("没有找到宝箱")
        End If
    Loop While result = True
End Function

//向右移动，如果网游次数超过10次，则向左移动
Function GotoRightSide()
    If (gotoRightSideCount > 0) Then 
        Call ToolDragMove(900,400,100,400)
        gotoRightSideCount = gotoRightSideCount - 1
    Elseif(gotoLeftSideCount > 0)
        Call ToolDragMove(100,400,900,400)
        gotoLeftSideCount = gotoLeftSideCount - 1
    Else 
        gotoLeftSideCount = 5
        gotoRightSideCount = 5
    End If
End Function

//等待战斗结束
Function FindFightEnd()
    Log("进入战斗")
    loopFindFightEndRepeatCount = 5 * 60
    loopFindFightEnd = False
    
    Call ToolSetCheckBox("战斗模式自动")
    
    Do While loopFindFightEnd = False
        loopFindFightEndRepeatCount = loopFindFightEndRepeatCount - 1
        loopFindFightEnd = ToolFindPicClick("战斗结束-胜利1")
        If loopFindFightEnd = true  Then 
            Log("战斗胜利")
            Delay 3000
            ToolFindPicWhile10Sec("战斗结束-胜利2")
            Delay 3000
            ToolFindPicWhile10Sec("战斗结束-胜利3")
            FindFightEnd = True
        Else 
            loopFindFightEnd = ToolFindPicClick("战斗结束-失败")
            If loopFindFightEnd = true Then 
                Log("战斗失败")
                FindFightEnd = False
            End If
            If loopFindFightEndRepeatCount = 0 Then 
                loopFindFightEnd = True
                FindFightEnd = True
                Log("战斗结束，但是因为超时！")
                Log("战斗结束，但是因为超时！")
                Log("战斗结束，但是因为超时！")
                Log("战斗结束，但是因为超时！")
            End If
        End If
        Delay 1000
    Loop  
End Function

















//设置选中框，尝试10次，成功设置返回true
Function ToolSetCheckBox(bpmSrc)
    notCheckResult = False
    isCheckResult = False
    ToolSetCheckBox = False
    repeatCount = 10
    Do While (repeatCount <> 0)
        repeatCount = repeatCount  - 1
        ToolFindPicClick (bpmSrc & "-未勾选")//先找到未勾选然后直接点
        Delay 500
        isCheckResult = ToolFindPic(bpmSrc&"-已勾选")//再获取是否已勾选状态
        notCheckResult = ToolFindPicClick(bpmSrc & "-未勾选")//最后在获取是不是未勾选
        If notCheckResult = False And isCheckResult = True Then 
            repeatCount = 0
            ToolSetCheckBox = True
        End If
    Loop
End Function

//查找图片工具
Function ToolFindPicClick(bmpSrc)
    If ToolFindPic(bmpSrc) Then 
        ToolFindPicClick = ToolPicClick()
    Else 
        ToolFindPicClick = False
    End If
End Function

//查找图片
Function ToolFindPic(bmpSrc)
    Call ae_obj.FindPic(0, 0, 1088, 700, bmpSrc + ".bmp", "050505", 0.7, 0, intX, intY)
    ToolFindPic = intX > 0 And intY > 0
    If intX > 0 And intY > 0 Then 
        //        TracePrint("找到了：" & bmpSrc & " X:" & intX & " Y:" & intY)
        Log("找到了：" & bmpSrc & " X:" & intX & " Y:" & intY)
    Else 
        //        TracePrint("没找到：" & bmpSrc)
        Log("没找到：" & bmpSrc)
    End If
End Function

//在一个矩形内查找图片
Function ToolFindPicClickByRect(bmpSrc,xStart,yStart,xEnd,yEnd)
    Call ae_obj.FindPic(xStart, yStart, xEnd, yEnd, bmpSrc + ".bmp", "050505", 0.7, 0, intX, intY)
    If intX > 0 And intY > 0 Then 
        ToolFindPicClickByRect = ToolPicClick()
        Log("找到了：" & bmpSrc & " X:" & intX & " Y:" & intY)
    Else 
        Log("没找到：" & bmpSrc)
    End If
End Function

//移动后点击
Function ToolPicClick()
    Delay 50
    Call ae_obj.MoveTo(intX, intY)
    Delay 50
    call ae_obj.LeftClick()
    ToolPicClick = True
    Delay 1000
End Function

//移动并点击XY
Function ToolMoveToClick(X, Y)
    Call ae_obj.MoveTo(X, Y)
    Call ae_obj.LeftClick()
End Function

//在10秒内尝试查找图片
Function ToolFindPicWhile10Sec(bmpSrc)
    ToolFindPicWhile10Sec = ToolFindPicWhileSec(bmpSrc, 10)
End Function

//在20秒内尝试查找图片
Function ToolFindPicWhile20Sec(bmpSrc)
    ToolFindPicWhile30Sec = ToolFindPicWhileSec(bmpSrc, 20)
End Function


//在10秒内尝试查找图片
Function ToolFindPicWhile120Sec(bmpSrc)
    ToolFindPicWhile120Sec = ToolFindPicWhileSec(bmpSrc, 120)
End Function


//根据对应时间尝试查找图片
Function ToolFindPicWhileSec(bmpSrc, secend)
    result = ToolFindPicClick(bmpSrc)
    If result = false Then 
        Delay 1000//用作当前方法的延时时间
        secend = secend - 1
        If secend <> 0 Then 
            ToolFindPicWhileSec = ToolFindPicWhileSec(bmpSrc, secend)
        End If
    Else 
        ToolFindPicWhileSec = True
    End If
End Function

//在10秒内尝试查找图片
Function ToolFindPicByRectWhile10Sec(bmpSrc,xStart,yStart,xEnd,yEnd)
    ToolFindPicByRectWhile10Sec = ToolFindPicByRectWhileSec(bmpSrc,xStart,yStart,xEnd,yEnd,10)
End Function

//根据对应时间尝试查找图片，在矩形内
Function ToolFindPicByRectWhileSec(bmpSrc,xStart,yStart,xEnd,yEnd,secend)
    result = ToolFindPicClickByRect(bmpSrc,xStart,yStart,xEnd,yEnd)
    If result = false Then 
        secend = secend - 1
        If secend <> 0 Then 
            Delay 1000
            ToolFindPicByRectWhileSec = ToolFindPicByRectWhileSec(bmpSrc,xStart,yStart,xEnd,yEnd,secend)
        End If
    Else 
        ToolFindPicByRectWhileSec = True
    End If
End Function

//根据对应时间尝试查找图片,这个方法只给测试用，性能很差
Function ToolFindPicWhileSecOnlyFor(bmpSrc, secend)
    result = ToolFindPic(bmpSrc)
    If result = false Then 
        secend = secend - 1
        If secend <> 0 Then 
            Delay 1
            ToolFindPicWhileSecOnlyFor = ToolFindPicWhileSecOnlyFor(bmpSrc, secend)
        End If
    Else 
        ToolFindPicWhileSecOnlyFor = True
    End If
End Function

//拖动工具
Function ToolDragMove(formX, formY, toX, toY)
    setpX = 0
    setpY = 0
    allSetp = 0
    offsetX = formX - toX
    offsetY = formY - toY
    Call ae_obj.MoveTo(formX, formY)
    Delay 5
    Call ae_obj.LeftDown()
    If offsetX > offsetY Then 
        allSetp = offsetX
    Else 
        allSetp = offsetY
    End If
    For allSetp
        If (setpX < offsetX) Then 
            If (formX > toX) Then 
                finalX= formX - setpX 
            Else 
                finalX= formX + setpX 
            End If
        End If
        If (setpY < offsetY) Then 
            If (formY > toY) Then 
                finalY= formY - setpY
            Else 
                finalY= formY + setpY
            End If
        End If
        Call ae_obj.MoveTo(finalX, finalY)
        setpX = setpX + 1
        setpY = setpY + 1
        Delay 1
    Next
    Delay 5
    Call ae_obj.LeftUp()
    Delay 5
End Function

Function Log(text)
    TracePrint text
    主窗体.日志框.Text = text & vbcrlf & 主窗体.日志框.Text
End Function

//释放对象
Sub OnScriptExit()
    Set ae_obj = Nothing
    LogStop
End Sub

Function TestAEPlugin()
    result = ae_obj.Capture(0, 0, 2000, 2000, "screen.bmp")
    If (result = 1) Then
        RunApp "E:\Program Files (x86)\按键精灵\按键精灵2014\Resource\screen.bmp"
    End If
End Function

Function TestGotoSereach()
    gotoRightSideCount = 5
    gotoLeftSideCount = 5
    Do While True
        Call GotoRightSide()
    Loop
End Function

Function 测试组队
    ToolSetCheckBox ("觉醒业火轮")
    ToolSetCheckBox ("觉醒风转轮")
    ToolSetCheckBox ("觉醒水灵轮")
    ToolSetCheckBox ("觉醒天雷轮")
    ToolSetCheckBox ("御魂")
    index = 1
    For 10
        ToolSetCheckBox ("第"&index&"层")
        index = index +1
    Next
End Function

Event 主窗体.自动剧情错误最大次数滑块.Slide
    主窗体.自动剧情错误最大次数LB.Caption = 主窗体.自动剧情错误最大次数滑块.Value
End Event
Event 主窗体.LoadOver
    主窗体.日志框.Text = ""
    主窗体.自动剧情错误最大次数LB.Caption = 主窗体.自动剧情错误最大次数滑块.Value
    Call setStoryFailCount(0)
    Call Log("窗体内容加载完毕")
End Event
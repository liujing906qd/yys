[General]
SyntaxVersion=2
BeginHotkey=121
BeginHotkeyMod=0
PauseHotkey=19
PauseHotkeyMod=0
StopHotkey=123
StopHotkeyMod=0
RunOnce=1
EnableWindow=
MacroID=ca1aef41-2838-41fe-88d3-d83ddba4350a
Description=阴阳师_自动备份_自动备份_自动备份_自动备份
Enable=1
AutoRun=0
[Repeat]
Type=0
Number=1
[SetupUI]
Type=1
QUI=主窗体
[Relative]
SetupOCXFile=
[Comment]

[UIPackage]
UEsDBBQAAgAIAFwTQ0mhQ1ZOYRYAAAgqAQAJABEAVUlQYWNrYWdlVVQNAAfWwfFX1sHxV9bB8VftXQd4FlXWPhNagFClNylSpEjvIBKkGmpoIoIBAgRCAkmQYt1dV3/b6vbm7spmV1lkFTABMYYonYQSQlOWtbHKYkVFwHWB/5yZb8gQkvU7d05y+CTX5zz3k8zcd247977vvXOnDDghd1+Nd1esbfAeFAg3Qxm4cLEilPf8Wxia5f5Pdef/y6BduHjxovvPD6JdLA0hE86jlcU664ZGdV0OrQJaRbRwtEpoVdAqo0WgVXWqHqqh1UC7Dq0mWi20Omi10eqi1Uerh9YArSFaI7Tr0RqjNUFritYcrRlaC7SWaDegtUJrg9Ya7Ua0dmht0dqj3YTWAa0jWme0Tmhd0LqjdUXrgTYHrRdaT7TeaP3Q+qD1ReuPNsBu2wC3oEWiDUQbhDYY7Va0IWjD0IaiDUe7DW0EWhTaKLSRaKPRxqKNQRuHNh4tGm0C2mS0iWiT0G5HuwNtCtpUtGlod6JNR4tBuwttBtostJlosWhz0WajxQX6VTzG89Dmoy1AS0RLQFuIloS2CC0ZbTFaCtrdaEvRlqAtQ7sHbTnavWj3o92H9gDaD9F+YD9/Iv6XgvUxGNNNwTSXASfUwRbjtiXrO65d0/r4/Ucb5VnkM+yCsctsuF2PpiEcLMvF/3UR1zz91vs2rovv/dsgrL0oH09QyYNf7jvw3dj7t/FY3gux5kdhi1hgtwBeqAlhNn6NgN8N9r6ygZja2LVk/QP9f0DAB5QE5pSruJyHJCYt8NH94PDZtDW7PzC/3wJ/we/9fkPe1/tPZz9nfj+jyxbL/aZ+J9//hV023wu2ztx5JY06MTgKxhs+Q1X0f5XBmacEix/m8X8TcaRNRjN9guoG+S/jwR+HqDE4AxiN5RDPHHtd/x8RSDNY/LIe/PGIv9SeORjXv8XNfzlP/Q/C2Uc8WpLhk9QywC/vyX8+fiTWw0x7nsXEt+fL1RjlX6FA/c/0Wf40Pw9n4IeDM4f3hgnYKf6m7UwNQgVl/DOFl7ldkiOjm0bHJCQ3jY5NiptdTPgtX5jm6/4p6HmS0P/E2myCH8j/1g70qWDbX0VP+4/CvsfvdZe3/+qB9ILFr1Ro/4/G55iL5cAbDeth/3c5cLD4lT34A3H2v9AeA5LQEvAZeKNQHcx/RXB4ebD4ER78IZj3BH/+hz3+kb/qdyn/8Tj6zsFnoHJPMPH/bPyql9V/DJZ/Cj4DlUOkXQ/uSJDfNooObQzGn2oe/Eg7faf/BYNXSPuzakG+5hbMPdU9+H79h9/5p98wPGHh4pTIxKWm9+88dHhT1pfm+KHOX8Zjy0+x574mrc/2P+z+V8PT/sYg/lJEj7dVLH6oaoBf87L+T/pPZx/+z7KIT5A+Wb+Ia0pC/2kJwft/Gq/CA781+B/5K0n+R7pyE0b+a4Mo/7OagqNbB4tfB2T5H2nsdRn4dUGX/3nXiwT4H7v91QNZ/kfrGy0Y5V8fZPkfraE0YuA3gCv5n2nwO/6T72yGHvF2Q/4ZBrqhjDK+X/4pwP/Y/a8hyPK/GwJ9Olj8RiDL/2idsg0DvzHI8j9aK23OwG8CuvyPxmtN/tcUvPPPGBz/k2FJgIdxQ00D/GYe/JGwGEuA+GcUWgJ7DkL6J7Wndoz6b+7B1w5++Y9f/to2fa6v+xuuGO/rfr/j1/iYGYMSE1KSEuPN7h9lt/sF2AvijfUHbvtv4Wl/wxDvbmP1w/F/bYGnf9xQwP/NxD6YXIL8t6UHn0adJBs5PqA+Fb//awUF+W8X4/bn3f/QsYhripv/9mPWf2twNGCn/Zc8/6W5giT/pf1P3SB4/3+jp/73r9j3WdZKc/8T6vqX3yClf07GgaCxQWH4LT8J/aMHs/+1BVn9g3ZvdWC0/3Ygqn+Asv7BHn/bg6z+Qeppb0b5dwBZ/YP2evZl4N8E+fqHBv/tCLL8t08gT8HidwK5+X+o6x9lIHx3Zs7ZV9au3RR+5OT6A/aPTSd2nKQfQeD7nb9r7/8S0D8s2kMdyWh/nUFW/6C93/0Z+F1AV/+g53X1j+GITWWebIgfgfmn/Axg5J/mio0Dv6PttTfHB8eWkP7RHbzjL81+OSvul4cGiN8LnD38weL3uAI/2fgJGhnkvyd4+V8KznrijRlIhAF+L7h69J9GPu/3q//QPCDiyMH1L7k+nxx6xNastR/RsLDxTYcb1Upfu2MNXXEoc/2G7OfXHEvbm32erqzu3rbxua3HMk/uOhbmpueOKuD+gzu60NBUz/1r9o4NXxzYtm+nd8SJcK9cdzz7PF1dx32+tE/3fnXks7SvCD0qkqDKRw2MHBxFHTrws2uYNwV6fuvS37rk39GZflbCp3DbP82C4gIKbMyl/TDfHZoatL/ehfS/YYhNOvBcpi820V/6XNb/8v2fof7Fxu8Ll8+/nTJ31N9ZzBGhCfp/932mYPFp7GkTII52K0x91c5KYc0sY3XWyf81xxmUuGBGoo/9NwV7GjeU6g9+53+k/3U1vp/0P9rPQAxmaBHXuLrfs3C8WPS/8cDTH2i+qrn/hebKEYHfEvofvZMYxej/g0B2/8soZvnfCrL6zzBw3t8MFn8wyO9/iWbgF4f+M5mBPwRk9R96T3YsA38oyOo/9D7uCAb+MNDVf4aDrP4zLlCnweKP8ODT+8iPov0W7Y8G+KX7b/zpT+WhfPrRvIxDmzHasMKOdl6wo5w37GjvSTvanHloc3E8v8T+F3rffQKj/d0GsvoPpTeGgR8FuvoPjdeC+g8bn8br9oHfGvrPaE/5a+w/GAOy+w8mAW/+MxZ09x+MA7n3P7T3z/h9/qiYGbHxPu4vqP9w79fmr8Ox9ZEHNGt9ZvtPoqHg/pNuxs/v3X8ytYhrXN5ZXPyTsOdC8OMPtfhyl/xfyfNPGqvd+a8E/6QzbGIY+Z8IsvyTzs6Zx8CfBLL8k+bQUxj4k0H3/Qs6l2ghyIQtWWl7M7et3ZSXkbUq+7VNezLeIzn7cFpubs7+nLO2vJ2btevAFtdPZp7LzV2RWqVSlUo53+Qd3Hli47evHHp1y7qMfR+nH6dr0rdmrEldnbUr7+DGtP0r9m3e8mH6VleXpLsK4mu/v0jvEtF+rm5hTrlygzZ/0dh/cgfI6g/UAmYz+t9UkNUfaNY8nYF/J+jqD9NAVn+YE6jTYPGng+j7F3b7i2Pg3wWy/JPSi2Xgx4Au/6Txut9V4n+0z8/QDoPmxs6c72P9rOBSMzdovH8zE7zzH6ffJWMvpD7IfQaT9ddZl/X/xYiXiN4nDpabzf/Z+LFQkP9099H/LYvmHXSWY1Hr9SXBf+5j+D/qy5rrbzReSa6/UXtNZuR/LuiePxbnwQ/19XO//s9vkOAP5I/obFaTQSDC5/NL8F86Xzae0f7ngTz/vZeBP99TblL85x4GfjzI8p+FgbYTLP4CkOU/dObwIgZ+Aujyn0SQ5T/LAmUaLP5CkH3//IGA/wgWfxGU7v+XCqG+f0yC/1LPXcJof0mgy39prtbvUv+ba3vA+Uarn47+vDjgU4LFT4Erx79xRrtfzfjXYtDdf343ePlXyfPPJSC//vwgo/6Xguz6Mzf/y+D7s/4roZ8wXve6IoQ6fxpjay50Agr5P7P3b7jtbzkU1D96GD+/d/33oSKuKQn94+eM/k9cQVP/IK4kqX88Bs4ewmDx7wNd/eN+kF3/fRqc76kEi/8AyPPfnzHwH/TU/7X2/Y9Su9yyVm0/7Y6BGuOPX/2MzhK9CxxOe4/B/drvQX5f1v9/yvA/PwBZ/ethjH/CwP8hyOpfT2D8CAP/R6Crfz0EsvrXU4E8BYv/Y5DVv36J8S8Y+A+D7Pr//2H8JAP/EdDVP+h5Xf2jVD/zF0KePwvoX48H+nSw7e9R0NW/HgNd/etx0NW/ngB5/etXjPp/EnT1r5+A9/zXktc/noKC+kdP4/5L+ge9T/sO2u+KuKYk9I/nGPVPfFlz//tPwTmDn4KE/vEsxn9i5P9nILv/fQXGKxn4P/fg+33/pfCjSYK/P9T1004+79fevy6hf/0e498w2t8vQPf9h1962o3G/vdfgSz/fQbjvzDK/9cgy3//jPEfGPi/AV3++1uQ5b9/DaQZLP7vQH7/+/MM/N978E+AMx6cQTP5jG1l0A2l+9f9BQn9g86NSGW0v2dAV/8gX6X5/Yk/gu7+9z+B7v73Z6Eg/+nlo/7z139XF4lX/PznFUb7p/m6Jv+h8bq8kP/wyx/s+80/PxDy/CFtb+rqPTkvnyEOtTV1RWqntL2b9mTvWJex7+3D2/FP21870z1tb9H3++UPEvx3HcZrGe0/FWT578sYv8rA/wvIrv//HeNVDPy/gi7/oXleq8BvDf7zPMjynxcxXs8o/5Ugy3/SMH6Jgf830OU/qzz596sfnANHzzplOeMKN2h/v/1a5w8S/HcDxi8w2v8LIM9/NzLwV4Ps+u8ajNMZ+H8HXf5D/lKT/7wEuvxnDejyn7VQkP/09lH/lkXjyR60ojYw/y/+ox1E+IP557tDnj94D6RP+zw9k3u/FP/NZvg/4gua/Jf4guT317ZivIWR/zSQ5T/bMN7NwE8HWf6ThfFrDPz1oMt/NkD+/FuD/7wCsvzndYx3Msp/I8i9/+OXP9DZWbT+QGvyqQb3S+lYpiHU+YME/92O8RuM9vcq6PLfDJBd/9uFcSYj/6+BPP/JYeBngiz/oYOpdzDwN4Eu/6HxSpP/vA66/OcNuHq+/+Q3+OUP7tkxzidw+CHU+YMG/90MBflvZ+N9VBGe9b/cIq4pifW/Ywz/R1xBk/9shfzvX0vwn8MYH2LkfxvI8p8jGL/NwN8OsvxnP8Z7Gfg7QJf/7PTUv1//p80faB/vE+Ccaf+Mwf3a/vdaPP93F8jy3zyMjzL6XzbIrv+9ifEBBn4O6PKf3SDLf/6B8T5G/veAPP/5JwN/L8jyn4MYv8XA3we6/IfmSVfL+3/aITo+blZskvn9RX0zM9j7tfmDBv/dD7r8Nw901/8OwJX8x3QJi/gP6VmVsSG8X8Q1JcF/OPknf+nqtgL8h41/yG43TpDgP/8GZx99sPiHQZb/nATe96eOgCz/OY7xu4z8vwny/OcU6H5/k1P+b4Hs/PdfGH/CyP9RuHr0P7/8j84yoPd5qQ2avL8Srpx/bf4nwX8+wvgDRvv7B+jyn2Mgyn/gc4zfY+T/nyDLf74Cnv9/G2T5z4cYf8nI/zugy3/ehXz+MxJzbXx4pO0/+PjvefI/Esf+BH/41mcYf8oo//c9+H75X0Vl/+V3HNPmX37100G7HvZ1/0T75I/FJXr+yXHwzv/ibP87xOZ+i+wnIS8U7Ey0Ebb/00z/9y8PPo0+cQHWGYMWZ/uj4APxz48x/oLR/z4A7/zfLf+S+/7rh4XiR8LQEjr/5ARcyX9NXwHzrv+dK+KakuC/Fazg65/4oub5ryfB8/0LgfOTj5xcf+BaPT/Zb/79Br/8SUL/uIDxeYb/+wh0z//9GGT1j7KWc35CsPifgLz+UZ7hfz4F+e/flGPgfway+sd/MA5j4H8Osut/5IS+ZdT/KdDlv1948u9+f4q+ibDcAL8K6IbS78/4CxLrv2XwIc4y2v+XIHv+a0XED2f0/69AVv/4L9UDA/806OofX4Ps928I9BtG/Z8B3fM/z4Lu+Z/nQPf8z2/g6tH/Q/783MQFMxL98KcAd9j4ZtZKk/v9+n+p818rMfzff0D3/NdvQff81//ClfpHV2P/Y1nkz7tj+VctojEUt/7R0OLpb8QVNfWPCyD7/ZtamP/rGO3/Isiu/9dmlj85DRdf45sjTazS786YmnQI9fP3/epfY8E5v4bOJHneqP/rBr/8V0L/qoaNKILh/yxLXv9qYOnu/7megR9myepf1TG9egz8Mpas/lUH06vBwCe9VFP/KmfJ7n+vj+lVYeS/vCWrfzTG9Box8CtYsvpHTUyvLgM/3NLVP0gvcvWP4YhNZZ5siG/C/4krufP9aESPD/RBEwXGZP9xZUuO//vVP8tBpU1f5+7PS884tfmw/XPDiSOrNnxr/8x58Y2Tr5+yf+7+5PUjG7eWPfBNxkcgGUJdf/D7/FL8n9P+IixZ/t+EyX+qFPA/M2Ex9v+S239R1YM/HNHJA5qhm+l/1awr9Yduxv4vf/9FCyX9oROz/mm+pKk/0FxJUn+4EdNrwxh/a3rrX0i/XHc8+7zJ/aG+/8Nv8MtfaS8DnZ802HLOteUGCf2pLbP/XWfJ7r+4AdNrxmj/tYqBf3ZU5p/dGPi1hflnS0yvAwO/jjD/bIfptWLg11Xmn/WE+edNmF5zRv7re/CrKfu/UN+/URHKpx/Ny1h3HKP1F+xo53k7ytlqR3s/sKPt79jRmhw72rTNjrJfXHdcOf8S+kMXLK3OjPbXQFh/aI3ptWfgN1TWHxop6w+kFw0M/NbQH6635L8/ysFvKsw/uzLnP82U+WdzS+78z1DXP/yeH5e+dscaOv/Bew4z535t/qOhP7QoRH/obuz/LLs/347WS0l/oHzfyhh/iK9onv9G8/Vagd8S+sPNmF5/Rv5bWbL7HwZgekMY+K2F+WdvTK8HA7+NpXv+G+lFUrpJqH//tm6Ysx+zT5izLsQNNUA3+OVPGudftBXWH/pgepGM/tdOWH+4BdPry8Bvr6w/dBDWHwZhej0Z+b/Jkj//bTADv6Mw/+xHfIqB30mZf3b28E+/4Vo/P07k+zVdze8PxfPfuli65791tXTPf+tWCP/pYVh/xH9c7BHfwX/WtC4+/jOR4f+6K/MfmqtLfv9nDKY3mpH/nsL8ZyymN5mB38uDr71+WlA74Z5Drc0fVloOf2gS5uyr49efbpDgv7dhvocx2l9vZf5LfKFm4LcG/+krzH+iML3xjPLv58E/j/f8CGM6ReghtB+jPYL2KDhn6z0Gzvnqj6M9ifYUOOftPQ3Ovnn6bhPtPyiu9xNKQ/EGCf47DtvTSEb766/Mf28W5r8TML3hjPwPKAb+O4mBf4sH/1o/P0E7+D1/yf1+R/aODV8c2LZvJ82nOGcRSegfo7C2ohntb6Cy/hFp6X7/a5Ay/71Vmf8OLoT/9jSsf9p/PBTTS0SbWsT82+W9xcl/5zPa/xDl/cdUXpLnn8/A9GIY+R9m6Z7/NVx4/W8upjeFkf8RxcB/5jHwb/Os/4b6/mt33Ms8l5vLHfskgl/9gNZP6XvY9E247Qb31/T5/FL8N47R/qKE+e80TG82A3+k8PrfLExvOgN/lDL/GS3Mf+Zgencw8j9G+P3XBZhePAN/rPD6312YXiwDf5zy/DdacP2v9Py90A4S57/NxEK4k9H+x1u6579NsHTPf5to6Z7/NqkY9l8nMOp/sqV7/tftlu75X1MK4b+9jNtf/vpvkgH/DfX93yL7L7qZ3x/q/ElK/7if0f/vUF7/nyq8/r8U01vCyP+dwuv/yzC9Bxn404T1j2RMbyEDf7ry+i/N111/q7H+GyPMf1MwvXsZ5T/Dg7/zxMZvD+Tmbk7f6qonqasPfrkn5+Uz6ZmHz2ae2PLhitTcf+et2rM6e23Wqu2nC37rQHv/BX3LPg2tRZiZfnKdsv/9Pnz/bTm2p8WM9jdTWf+YJax/3IfpLWLkP7YY1n8fYODPFtY/7sb07mHgz1HWP+Yqr//FKa//zbPkvv9WGkI7aKz/zrdkz5/n4kuHUMb/f1BLAQIXCxQAAgAIAFwTQ0mhQ1ZOYRYAAAgqAQAJAAkAAAAAAAAAAAAAgAAAAABVSVBhY2thZ2VVVAUAB9bB8VdQSwUGAAAAAAEAAQBAAAAAmRYAAAAA


[Script]
Dim Hwnd//窗口句柄
Dim XY
Dim FILE_PATH
FILE_PATH = "C:\阴阳师脚本\"
LogStart FILE_PATH+"my.log"

PutAttachment "C:\阴阳师脚本","AE.dll"
Private Declare Function AeStartup Lib "C:\阴阳师脚本\AE.dll" () As Long//免注册功能
If (AeStartup() = 0) Then
    Call MsgBox("AE免注册初始化失败！", vbCritical, "VBdemo")
    EndScript
End If
Set ae_obj = CreateObject("AE.AeSoft")
Delay 500
hwnd = ae_obj.GetMousePointWindow()
result = ae_obj.BindWindow(hwnd, "ogl1", "windows3", "windows", 0)
If (result = 1) Then 
    call log("绑定成功，句柄为："&hwnd)
Else 
    Call MsgBox("绑定错误", vbCritical, "VBdemo")
    Set ae_obj = Nothing
    EndScript
End If
Delay 500
ae_obj.SetPath ("E:\Program Files (x86)\按键精灵\按键精灵2014\Resource")


//Call ToolFindPicWhile10Sec("探索10")

StoryFailCount = 0
Call StoryMission()
Call PVETeamMession()
Call MonsterMission()





//Call MonsterMission()
//Call StoryMission()

//Call FindNPCToFight()
//Call FindBossBox()

//Call TestAEPlugin()
//Call 测试组队()


//PVE的关卡进入
Function PVETeamMession()
    If (主窗体.自动组队副本.Value =false)Then 
        Exit Function
    End If
    Log("组队副本，开始")
    ToolSetCheckBox("主界面-卷轴")
    ToolFindPicWhile10Sec("主界面-组队")
    Delay 500
    If ToolFindPic("组队-" & 主窗体.组队副本关卡.ListIndex +1 & "-未勾选") = False Then 
        Call ToolDragMove(230, 400, 230, 140)
        Delay 500
    End If
    ToolSetCheckBox("组队-"&主窗体.组队副本关卡.ListIndex+1)
    ToolSetCheckBox("第" & 主窗体.组队副本层数.ListIndex+1 & "层")
    ToolFindPicWhile10Sec ("创建队伍")
    Rem 创建
    ToolFindPicWhile10Sec ("创建")
    Rem 等待队友
    Do
        result = ToolFindPic("邀请")
    Loop While result
    Do
    	result = ToolFindPicClick("开始战斗-已勾选")
    Loop While result
//    If (result) Then FIXME 缺少组队超时的处理。如果搜索不到邀请也搜索不到开始战斗，则认为超时。
        Do
            Do
                result = ToolFindPicWhile20Sec("战斗准备")
            Loop While result
            resultForZuduiFight = FindFightEnd()
            If (resultForZuduiFight) Then 
                Log("继续与上次队友组队")
                ToolFindPicWhile10Sec ("确定")
                Goto 等待队友
            End If
            Delay 500
        Loop While resultForZuduiFight = false
//    Else 
//        Log("错误，组队等待超时")
//        Log("错误，组队等待超时")
//        Log ("错误，组队等待超时")
//        Goto 创建
//    End If
End Function

//自动探索副本
Function MonsterMission()
    If (主窗体.自动探索副本.Value = false)Then 
        Exit Function
    End If
    Log("探索副本，开始")
    Call ToolMoveToClick(522,120)
    For 100
        result = ToolFindPicWhile10Sec("怪物-关卡-"&(主窗体.目标探索关卡.ListIndex+1))
        If result Then 
            Delay 3000
            result = ToolFindPicWhile10Sec("经验-探索")
            If result = true Then 
                If FindNPCToFight() Then
                    If 主窗体.探索副本是否优先剧情副本.Value Then 
                        Log("当前是否有剧情副本")
                        If ToolFindPicByRectWhile10Sec("怪物-地图-返回(新)|怪物-地图-返回(新)2|怪物-地图-返回(新)|怪物-地图-返回(新)3|怪物-地图-返回(新)|怪物-地图-返回(新)4|怪物-地图-返回(新)5", 55, 5, 90, 40) Then 
                            Log("有剧情副本，退出到主界面。等待自动副本开始")
                            Exit Function
                        Else 
                            Log("没有，继续探索副本")
                        End If
                    End If
                End If
            End If
        End If
    Next
End Function

Function setStoryFailCount(value)
    StoryFailCount = value
    主窗体.当前剧情战斗失败次数.Caption = StoryFailCount
End Function

//剧情任务
Function StoryMission()
    Log ("主窗体.自动剧情副本.Value:" & 主窗体.自动剧情副本.Value)
    Log("主窗体.自动剧情错误最大次数滑块.Value:"&主窗体.自动剧情错误最大次数滑块.Value)
    Log("StoryFailCount:"&StoryFailCount)
    If (主窗体.自动剧情副本.Value = False or 主窗体.自动剧情错误最大次数滑块.Value < StoryFailCount)Then 
        Call setStoryFailCount(0)
        Exit Function
    End If
    Log("剧情副本，开始")
    StoryMission = False
    secend = 5 * 60
    loopStoryMission = False
    Do While loopStoryMission = False
        secend = secend - 1
        ToolFindPicClick("剧情-跳过")
        ToolFindPicClick("剧情-对话")
        ToolFindPicClick("剧情-快进")
        ToolFindPicClick("剧情-眼")
        If (isMainSence() = false) Then 
            Call ToolFindPicClick("剧情-问号")
        End If
        ToolFindPicClick("可攻击怪物标志")
        ToolFindPicClick("可攻击怪物标志2")
        result = ToolFindPicClick("战斗准备")
        If result = true Then 
            If (FindFightEnd()) Then //进入战斗
            	
            Else //战斗失败
                If (主窗体.自动剧情错误最大次数滑块.Value < StoryFailCount) Then 
                    Log("剧情战斗失败，超过重试次数"&主窗体.自动剧情错误最大次数滑块.Value)
                    Call setStoryFailCount(0)
                    Exit Function
                Else 
                    Call setStoryFailCount(StoryFailCount + 1)
                    Log("剧情战斗失败，当前失败次数"&StoryFailCount)
                End If
            End If
        End If
        result = ToolFindPicClick("剧情-终止")
        If result = true Then 
            Log("剧情终止，退出剧情任务")
            loopStoryMission = True
            StoryMission =True
        End If
        If secend = 0 Then 
            Log("超时，剧情终止，退出剧情任务")
            Log("超时，剧情终止，退出剧情任务")
            Log("超时，剧情终止，退出剧情任务")
            loopStoryMission = True
            StoryMission = False
        End If
        Delay 500
        Call GotoRightSide()
        //        Call ToolMoveToClick(100,100)//避免新NPC出现卡住
    Loop  
End Function

Function isMainSence()
    isMainSence = ToolFindPic("主界面-卷轴-已勾选|主界面-卷轴-未勾选")
End Function

//搜寻可战斗的NPC
Function FindNPCToFight()
    loopForFindNPCToFight = False
    notCheckResult = False
    isCheckResult = False
    gotoRightSideCount = 5
    gotoLeftSideCount = 0
    
    Log("开始搜索可战斗的怪物")
    Delay 5000
    Call ToolSetCheckBox("战斗锁定出战")
    
    Do While loopForFindNPCToFight = False//只有打完BOSS才会跳出，否则死循环
        resultForFoundBoss = ToolFindPicClick("可攻击BOSS标志")
        If resultForFoundBoss = true Then 
            Log("找到BOSS")
            fightBossResult = FindFightEnd()//战斗
        End If
        resultForFoundNPC = ToolFindPicClick("可攻击怪物标志")
        If resultForFoundNPC = true Then 
            Log("找到小怪")
            fightNPCResult = FindFightEnd()//战斗
            Call Log("攻击小怪成功")
        ElseIf fightBossResult Then
            Log ("loopForFindNPCToFight:" & loopForFindNPCToFight)
            Delay 3000//等待宝箱到位
            If FindBossBox() Then //找BOSS宝箱
                FindNPCToFight = True
                Exit Function
            End If
            Exit Do
        End If
        If resultForFoundBoss = False And resultForFoundNPC = False Then 
            Call Log("没有搜索到小怪和BOSS，向右移动")
            Call GotoRightSide()//向右移动
        End If
        Delay 3000
    Loop
End Function

//查找BOSS宝箱
Function FindBossBox()
    FindBossBox = False//至少找到过一次（隐含逻辑是这个副本将会结束）
    Do
        result = ToolFindPicClick("经验-结束宝箱")
        If result = true Then
            Log("搜索到宝箱") 
            Delay 1500
            Log("开启宝箱，点击左上角退出宝箱界面")
            Call ToolMoveToClick(70, 70)
            FindBossBox = True
            Delay 1500
        Else 
            Log ("没有找到宝箱")
        End If
    Loop While result = True
End Function

//向右移动，如果网游次数超过10次，则向左移动
Function GotoRightSide()
    If (gotoRightSideCount > 0) Then 
        Call ToolDragMove(900,400,100,400)
        gotoRightSideCount = gotoRightSideCount - 1
    Elseif(gotoLeftSideCount > 0)
        Call ToolDragMove(100,400,900,400)
        gotoLeftSideCount = gotoLeftSideCount - 1
    Else 
        gotoLeftSideCount = 5
        gotoRightSideCount = 5
    End If
End Function

//等待战斗结束
Function FindFightEnd()
    Log("进入战斗")
    loopFindFightEndRepeatCount = 5 * 60
    loopFindFightEnd = False
    
    Call ToolSetCheckBox("战斗模式自动")
    
    Do While loopFindFightEnd = False
        loopFindFightEndRepeatCount = loopFindFightEndRepeatCount - 1
        loopFindFightEnd = ToolFindPicClick("战斗结束-胜利1")
        If loopFindFightEnd = true  Then 
            Log("战斗胜利")
            Delay 3000
            ToolFindPicWhile10Sec("战斗结束-胜利2")
            Delay 3000
            ToolFindPicWhile10Sec("战斗结束-胜利3")
            FindFightEnd = True
        Else 
            loopFindFightEnd = ToolFindPicClick("战斗结束-失败")
            If loopFindFightEnd = true Then 
                Log("战斗失败")
                FindFightEnd = False
            End If
            If loopFindFightEndRepeatCount = 0 Then 
                loopFindFightEnd = True
                FindFightEnd = True
                Log("战斗结束，但是因为超时！")
                Log("战斗结束，但是因为超时！")
                Log("战斗结束，但是因为超时！")
                Log("战斗结束，但是因为超时！")
            End If
        End If
        Delay 1000
    Loop  
End Function

















//设置选中框，尝试10次，成功设置返回true
Function ToolSetCheckBox(bpmSrc)
    notCheckResult = False
    isCheckResult = False
    ToolSetCheckBox = False
    repeatCount = 10
    Do While (repeatCount <> 0)
        repeatCount = repeatCount  - 1
        ToolFindPicClick (bpmSrc & "-未勾选")//先找到未勾选然后直接点
        Delay 500
        isCheckResult = ToolFindPic(bpmSrc&"-已勾选")//再获取是否已勾选状态
        notCheckResult = ToolFindPicClick(bpmSrc & "-未勾选")//最后在获取是不是未勾选
        If notCheckResult = False And isCheckResult = True Then 
            repeatCount = 0
            ToolSetCheckBox = True
        End If
    Loop
End Function

//查找图片工具
Function ToolFindPicClick(bmpSrc)
    If ToolFindPic(bmpSrc) Then 
        ToolFindPicClick = ToolPicClick()
    Else 
        ToolFindPicClick = False
    End If
End Function

//查找图片
Function ToolFindPic(bmpSrc)
    Call ae_obj.FindPic(0, 0, 1088, 700, bmpSrc + ".bmp", "050505", 0.7, 0, intX, intY)
    ToolFindPic = intX > 0 And intY > 0
    If intX > 0 And intY > 0 Then 
        //        TracePrint("找到了：" & bmpSrc & " X:" & intX & " Y:" & intY)
        Log("找到了：" & bmpSrc & " X:" & intX & " Y:" & intY)
    Else 
        //        TracePrint("没找到：" & bmpSrc)
        Log("没找到：" & bmpSrc)
    End If
End Function

//在一个矩形内查找图片
Function ToolFindPicClickByRect(bmpSrc,xStart,yStart,xEnd,yEnd)
    Call ae_obj.FindPic(xStart, yStart, xEnd, yEnd, bmpSrc + ".bmp", "050505", 0.7, 0, intX, intY)
    If intX > 0 And intY > 0 Then 
        ToolFindPicClickByRect = ToolPicClick()
        Log("找到了：" & bmpSrc & " X:" & intX & " Y:" & intY)
    Else 
        Log("没找到：" & bmpSrc)
    End If
End Function

//移动后点击
Function ToolPicClick()
    Delay 50
    Call ae_obj.MoveTo(intX, intY)
    Delay 50
    call ae_obj.LeftClick()
    ToolPicClick = True
    Delay 1000
End Function

//移动并点击XY
Function ToolMoveToClick(X, Y)
    Call ae_obj.MoveTo(X, Y)
    Call ae_obj.LeftClick()
End Function

//在10秒内尝试查找图片
Function ToolFindPicWhile10Sec(bmpSrc)
    ToolFindPicWhile10Sec = ToolFindPicWhileSec(bmpSrc, 10)
End Function

//在20秒内尝试查找图片
Function ToolFindPicWhile20Sec(bmpSrc)
    ToolFindPicWhile30Sec = ToolFindPicWhileSec(bmpSrc, 20)
End Function


//在10秒内尝试查找图片
Function ToolFindPicWhile120Sec(bmpSrc)
    ToolFindPicWhile120Sec = ToolFindPicWhileSec(bmpSrc, 120)
End Function


//根据对应时间尝试查找图片
Function ToolFindPicWhileSec(bmpSrc, secend)
    result = ToolFindPicClick(bmpSrc)
    If result = false Then 
        Delay 1000//用作当前方法的延时时间
        secend = secend - 1
        If secend <> 0 Then 
            ToolFindPicWhileSec = ToolFindPicWhileSec(bmpSrc, secend)
        End If
    Else 
        ToolFindPicWhileSec = True
    End If
End Function

//在10秒内尝试查找图片
Function ToolFindPicByRectWhile10Sec(bmpSrc,xStart,yStart,xEnd,yEnd)
    ToolFindPicByRectWhile10Sec = ToolFindPicByRectWhileSec(bmpSrc,xStart,yStart,xEnd,yEnd,10)
End Function

//根据对应时间尝试查找图片，在矩形内
Function ToolFindPicByRectWhileSec(bmpSrc,xStart,yStart,xEnd,yEnd,secend)
    result = ToolFindPicClickByRect(bmpSrc,xStart,yStart,xEnd,yEnd)
    If result = false Then 
        secend = secend - 1
        If secend <> 0 Then 
            Delay 1000
            ToolFindPicByRectWhileSec = ToolFindPicByRectWhileSec(bmpSrc,xStart,yStart,xEnd,yEnd,secend)
        End If
    Else 
        ToolFindPicByRectWhileSec = True
    End If
End Function

//根据对应时间尝试查找图片,这个方法只给测试用，性能很差
Function ToolFindPicWhileSecOnlyFor(bmpSrc, secend)
    result = ToolFindPic(bmpSrc)
    If result = false Then 
        secend = secend - 1
        If secend <> 0 Then 
            Delay 1
            ToolFindPicWhileSecOnlyFor = ToolFindPicWhileSecOnlyFor(bmpSrc, secend)
        End If
    Else 
        ToolFindPicWhileSecOnlyFor = True
    End If
End Function

//拖动工具
Function ToolDragMove(formX, formY, toX, toY)
    setpX = 0
    setpY = 0
    allSetp = 0
    offsetX = formX - toX
    offsetY = formY - toY
    Call ae_obj.MoveTo(formX, formY)
    Delay 5
    Call ae_obj.LeftDown()
    If offsetX > offsetY Then 
        allSetp = offsetX
    Else 
        allSetp = offsetY
    End If
    For allSetp
        If (setpX < offsetX) Then 
            If (formX > toX) Then 
                finalX= formX - setpX 
            Else 
                finalX= formX + setpX 
            End If
        End If
        If (setpY < offsetY) Then 
            If (formY > toY) Then 
                finalY= formY - setpY
            Else 
                finalY= formY + setpY
            End If
        End If
        Call ae_obj.MoveTo(finalX, finalY)
        setpX = setpX + 1
        setpY = setpY + 1
        Delay 1
    Next
    Delay 5
    Call ae_obj.LeftUp()
    Delay 5
End Function

Function Log(text)
    TracePrint text
    主窗体.日志框.Text = text & vbcrlf & 主窗体.日志框.Text
End Function

//释放对象
Sub OnScriptExit()
    Set ae_obj = Nothing
    LogStop
End Sub

Function TestAEPlugin()
    result = ae_obj.Capture(0, 0, 2000, 2000, "screen.bmp")
    If (result = 1) Then
        RunApp "E:\Program Files (x86)\按键精灵\按键精灵2014\Resource\screen.bmp"
    End If
End Function

Function TestGotoSereach()
    gotoRightSideCount = 5
    gotoLeftSideCount = 5
    Do While True
        Call GotoRightSide()
    Loop
End Function

Function 测试组队
    ToolSetCheckBox ("觉醒业火轮")
    ToolSetCheckBox ("觉醒风转轮")
    ToolSetCheckBox ("觉醒水灵轮")
    ToolSetCheckBox ("觉醒天雷轮")
    ToolSetCheckBox ("御魂")
    index = 1
    For 10
        ToolSetCheckBox ("第"&index&"层")
        index = index +1
    Next
End Function

Event 主窗体.自动剧情错误最大次数滑块.Slide
    主窗体.自动剧情错误最大次数LB.Caption = 主窗体.自动剧情错误最大次数滑块.Value
End Event
Event 主窗体.LoadOver
    主窗体.日志框.Text = ""
    主窗体.自动剧情错误最大次数LB.Caption = 主窗体.自动剧情错误最大次数滑块.Value
    Call setStoryFailCount(0)
    Call Log("窗体内容加载完毕")
End Event
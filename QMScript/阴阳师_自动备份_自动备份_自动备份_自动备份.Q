[General]
SyntaxVersion=2
BeginHotkey=121
BeginHotkeyMod=0
PauseHotkey=19
PauseHotkeyMod=0
StopHotkey=123
StopHotkeyMod=0
RunOnce=1
EnableWindow=
MacroID=ac940ed2-e3d6-4c56-aba5-130490286f61
Description=阴阳师_自动备份_自动备份_自动备份_自动备份
Enable=1
AutoRun=0
[Repeat]
Type=0
Number=1
[SetupUI]
Type=1
QUI=主窗体
[Relative]
SetupOCXFile=
[Comment]

[UIPackage]
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


[Script]
Dim Hwnd//窗口句柄
Dim XY
Dim FILE_PATH
FILE_PATH = "C:\阴阳师脚本\"
LogStart FILE_PATH+"my.log"

PutAttachment "C:\阴阳师脚本","AE.dll"
Private Declare Function AeStartup Lib "C:\阴阳师脚本\AE.dll" () As Long//免注册功能
If (AeStartup() = 0) Then
    Call MsgBox("AE免注册初始化失败！", vbCritical, "VBdemo")
    EndScript
End If
Set ae_obj = CreateObject("AE.AeSoft")
Delay 500
hwnd = ae_obj.GetMousePointWindow()
result = ae_obj.BindWindow(hwnd, "ogl1", "windows3", "windows", 0)
If (result = 1) Then 
    call LogD("绑定成功，句柄为："&hwnd)
Else 
    Call MsgBox("绑定错误", vbCritical, "VBdemo")
    Set ae_obj = Nothing
    EndScript
End If
Delay 500
ae_obj.SetPath ("E:\Program Files (x86)\按键精灵\按键精灵2014\Resource")


//Call ToolFindPicWhile10Sec("探索10")

StoryFailCount = 0
Call StoryMission()
Call PVETeamMession()
Call MonsterMission()



//Call FindNPCToFight()
//Call FindBossBox()

//Call TestAEPlugin()
//Call 测试组队()


//PVE的关卡进入
Function PVETeamMession()
    If (主窗体.自动组队副本.Value =false)Then 
        Exit Function
    End If
    LogI("组队副本，开始")
    ToolSetCheckBox("主界面-卷轴")
    ToolFindPicWhile10Sec("主界面-组队")
    Delay 500
    If ToolFindPic("组队-" & (主窗体.组队副本关卡.ListIndex +1) & "-未勾选") = False Then 
        Call ToolDragMove(230, 400, 230, 140)
        Delay 500
    End If
    ToolSetCheckBox("组队-"&主窗体.组队副本关卡.ListIndex+1)
    ToolSetCheckBox("第" & 主窗体.组队副本层数.ListIndex+1 & "层")
    ToolFindPicWhile10Sec ("创建队伍")
    Rem 创建
    ToolFindPicWhile10Sec ("创建")
    Rem 等待队友
    if ToolNotFindPicUntilFindInSec120Sec("邀请") = false Then
        PVETeamMession = false
        LogE("无法等到队友")
        Exit Function
    End If
    
    Delay 1000//等待开始按钮变正常

    if ToolFindPicClickWithOutFind("开始战斗-已勾选") = false Then
        PVETeamMession = false
        LogE("无法找到开始战斗按钮")
        Exit Function
    End If
    
    //    If (result) Then FIXME 缺少组队超时的处理。如果搜索不到邀请也搜索不到开始战斗，则认为超时。
    Do
        Do
            result = ToolFindPicWhile20Sec("战斗准备")
        Loop While result
        resultForZuduiFight = FindFightEnd()
        If (resultForZuduiFight) Then 
            LogI("继续与上次队友组队")
            ToolFindPicWhile10Sec("确定")
            Delay 5000//等待队伍重新创建
            Goto 等待队友
        End If
        Delay 500
    Loop While resultForZuduiFight = false
    //    Else 
    //        LogE("错误，组队等待超时")
    //        LogE("错误，组队等待超时")
    //        Log ("错误，组队等待超时")
    //        Goto 创建
    //    End If
End Function


Function ToolFindPicClickWithOutFind(bmpSrc)
    result = ToolFindPicWhile20Sec(bmpSrc)
    If(result = false) Then
        LogD("没有找到"&bmpSrc)
        ToolFindPicClickWithOutFind = False
    Else
        LogD("找到"&bmpSrc&",检测点击后5秒内是否消失")
        ToolFindPicClickWithOutFind = ToolNotFindPicUntilFindInSec5Sec(bmpSrc)
    End If
End Function

//自动探索副本
Function MonsterMission()
    If (主窗体.自动探索副本.Value = false)Then 
        Exit Function
    End If
    LogI("探索副本，开始")
    Call ToolMoveToClick(522,120)
    For 100
        result = ToolFindPicWhile10Sec("怪物-关卡-"&(主窗体.目标探索关卡.ListIndex+1))
        If result Then 
            Delay 3000
            result = ToolFindPicWhile10Sec("经验-探索")
            If result = true Then 
                If FindNPCToFight() Then
                    If 主窗体.探索副本是否优先剧情副本.Value Then 
                        LogI("当前是否有剧情副本")
                        If ToolFindPicByRectWhile10Sec("怪物-地图-返回(新)|怪物-地图-返回(新)2|怪物-地图-返回(新)|怪物-地图-返回(新)3|怪物-地图-返回(新)|怪物-地图-返回(新)4|怪物-地图-返回(新)5", 55, 5, 90, 40) Then 
                            LogI("有剧情副本，退出到主界面。等待自动副本开始")
                            Exit Function
                        Else 
                            LogI("没有，继续探索副本")
                        End If
                    End If
                End If
            End If
        End If
    Next
End Function

Function setStoryFailCount(value)
    StoryFailCount = value
    主窗体.当前剧情战斗失败次数.Caption = StoryFailCount
End Function

//剧情任务
Function StoryMission()
    Log ("主窗体.自动剧情副本.Value:" & 主窗体.自动剧情副本.Value)
    LogD("主窗体.自动剧情错误最大次数滑块.Value:"&主窗体.自动剧情错误最大次数滑块.Value)
    LogD("StoryFailCount:"&StoryFailCount)
    If (主窗体.自动剧情副本.Value = False or 主窗体.自动剧情错误最大次数滑块.Value < StoryFailCount)Then 
        Call setStoryFailCount(0)
        Exit Function
    End If
    LogI("剧情副本，开始")
    StoryMission = False
    secend = 5 * 60
    loopStoryMission = False
    Do While loopStoryMission = False
        secend = secend - 1
        ToolFindPicClick("剧情-跳过")
        ToolFindPicClick("剧情-对话")
        ToolFindPicClick("剧情-快进")
        ToolFindPicClick("剧情-眼")
        If (isMainSence() = false) Then 
            Call ToolFindPicClick("剧情-问号")
        End If
        ToolFindPicClick("可攻击怪物标志")
        ToolFindPicClick("可攻击怪物标志2")
        result = ToolFindPicClick("战斗准备")
        If result = true Then 
            If (FindFightEnd()) Then //进入战斗
            	
            Else //战斗失败
                If (主窗体.自动剧情错误最大次数滑块.Value < StoryFailCount) Then 
                    LogI("剧情战斗失败，超过重试次数"&主窗体.自动剧情错误最大次数滑块.Value)
                    Call setStoryFailCount(0)
                    Exit Function
                Else 
                    Call setStoryFailCount(StoryFailCount + 1)
                    LogI("剧情战斗失败，当前失败次数"&StoryFailCount)
                End If
            End If
        End If
        result = ToolFindPicClick("剧情-终止")
        If result = true Then 
            LogI("剧情终止，退出剧情任务")
            loopStoryMission = True
            StoryMission =True
        End If
        If secend = 0 Then 
            LogE("超时，剧情终止，退出剧情任务")
            LogE("超时，剧情终止，退出剧情任务")
            LogE("超时，剧情终止，退出剧情任务")
            loopStoryMission = True
            StoryMission = False
        End If
        Delay 500
        Call GotoRightSide()
        //        Call ToolMoveToClick(100,100)//避免新NPC出现卡住
    Loop  
End Function

Function isMainSence()
    isMainSence = ToolFindPic("主界面-卷轴-已勾选|主界面-卷轴-未勾选")
End Function

//搜寻可战斗的NPC
Function FindNPCToFight()
    loopForFindNPCToFight = False
    notCheckResult = False
    isCheckResult = False
    gotoRightSideCount = 5
    gotoLeftSideCount = 0
    
    LogI("开始搜索可战斗的怪物")
    Delay 5000
    Call ToolSetCheckBox("战斗锁定出战")
    
    Do While loopForFindNPCToFight = False//只有打完BOSS才会跳出，否则死循环
        resultForFoundBoss = ToolFindPicClick("可攻击BOSS标志")
        If resultForFoundBoss = true Then 
            LogI("找到BOSS")
            fightBossResult = FindFightEnd()//战斗
        End If
        resultForFoundNPC = ToolFindPicClick("可攻击怪物标志")
        If resultForFoundNPC = true Then 
            LogI("找到小怪")
            fightNPCResult = FindFightEnd()//战斗
            LogI("攻击小怪成功")
        ElseIf fightBossResult Then
            Log ("loopForFindNPCToFight:" & loopForFindNPCToFight)
            Delay 3000//等待宝箱到位
            If FindBossBox() Then //找BOSS宝箱
                FindNPCToFight = True
                Exit Function
            End If
            Exit Do
        End If
        If resultForFoundBoss = False And resultForFoundNPC = False Then 
            LogI("没有搜索到小怪和BOSS，向右移动")
            Call GotoRightSide()//向右移动
        End If
        Delay 3000
    Loop
End Function

//查找BOSS宝箱
Function FindBossBox()
    FindBossBox = False//至少找到过一次（隐含逻辑是这个副本将会结束）
    Do
        result = ToolFindPicClick("经验-结束宝箱")
        If result = true Then
            LogI("搜索到宝箱") 
            Delay 1500
            LogI("开启宝箱，点击左上角退出宝箱界面")
            Call ToolMoveToClick(70, 70)
            FindBossBox = True
            Delay 1500
        Else 
            Log ("没有找到宝箱")
        End If
    Loop While result = True
End Function

//向右移动，如果网游次数超过10次，则向左移动
Function GotoRightSide()
    If (gotoRightSideCount > 0) Then 
        Call ToolDragMove(900,400,100,400)
        gotoRightSideCount = gotoRightSideCount - 1
    Elseif(gotoLeftSideCount > 0)
        Call ToolDragMove(100,400,900,400)
        gotoLeftSideCount = gotoLeftSideCount - 1
    Else 
        gotoLeftSideCount = 5
        gotoRightSideCount = 5
    End If
End Function

//等待战斗结束
Function FindFightEnd()
    LogI("进入战斗")
    loopFindFightEndRepeatCount = 5 * 60
    loopFindFightEnd = False
    
    Call ToolSetCheckBox("战斗模式自动")
    
    Do While loopFindFightEnd = False
        loopFindFightEndRepeatCount = loopFindFightEndRepeatCount - 1
        loopFindFightEnd = ToolFindPicClick("战斗结束-胜利1")
        If loopFindFightEnd = true  Then 
            LogI("战斗胜利")
            Delay 3000
            ToolFindPicWhile10Sec("战斗结束-胜利2")
            Delay 3000
            ToolFindPicWhile10Sec("战斗结束-胜利3")
            FindFightEnd = True
        Else 
            loopFindFightEnd = ToolFindPicClick("战斗结束-失败")
            If loopFindFightEnd = true Then 
                LogI("战斗失败")
                FindFightEnd = False
            End If
            If loopFindFightEndRepeatCount = 0 Then 
                loopFindFightEnd = True
                FindFightEnd = True
                LogE("战斗结束，但是因为超时！")
                LogE("战斗结束，但是因为超时！")
                LogE("战斗结束，但是因为超时！")
                LogE("战斗结束，但是因为超时！")
            End If
        End If
        Delay 1000
    Loop  
End Function

















//设置选中框，尝试10次，成功设置返回true
Function ToolSetCheckBox(bpmSrc)
    notCheckResult = False
    isCheckResult = False
    ToolSetCheckBox = False
    repeatCount = 10
    Do While (repeatCount <> 0)
        repeatCount = repeatCount  - 1
        ToolFindPicClick (bpmSrc & "-未勾选")//先找到未勾选然后直接点
        Delay 500
        isCheckResult = ToolFindPic(bpmSrc&"-已勾选")//再获取是否已勾选状态
        notCheckResult = ToolFindPicClick(bpmSrc & "-未勾选")//最后在获取是不是未勾选
        If notCheckResult = False And isCheckResult = True Then 
            repeatCount = 0
            ToolSetCheckBox = True
        End If
    Loop
End Function

//查找图片工具
Function ToolFindPicClick(bmpSrc)
    If ToolFindPic(bmpSrc) Then 
        ToolFindPicClick = ToolPicClick()
    Else 
        ToolFindPicClick = False
    End If
End Function

//查找图片
Function ToolFindPic(bmpSrc)
    Call ae_obj.FindPic(0, 0, 1088, 700, bmpSrc + ".bmp", "000000", 0.7, 0, intX, intY)
    ToolFindPic = intX > 0 And intY > 0
    If intX > 0 And intY > 0 Then 
        //        TracePrint("找到了：" & bmpSrc & " X:" & intX & " Y:" & intY)
        LogD("找到了：" & bmpSrc & " X:" & intX & " Y:" & intY)
    Else 
        //        TracePrint("没找到：" & bmpSrc)
        LogD("没找到：" & bmpSrc)
    End If
End Function

//在一个矩形内查找图片
Function ToolFindPicClickByRect(bmpSrc,xStart,yStart,xEnd,yEnd)
    Call ae_obj.FindPic(xStart, yStart, xEnd, yEnd, bmpSrc + ".bmp", "050505", 0.7, 0, intX, intY)
    If intX > 0 And intY > 0 Then 
        ToolFindPicClickByRect = ToolPicClick()
        LogD("找到了：" & bmpSrc & " X:" & intX & " Y:" & intY)
    Else 
        LogD("没找到：" & bmpSrc)
    End If
End Function

//移动后点击
Function ToolPicClick()
    Delay 50
    Call ae_obj.MoveTo(intX, intY)
    Delay 50
    call ae_obj.LeftClick()
    ToolPicClick = True
    Delay 1000
End Function

//移动并点击XY
Function ToolMoveToClick(X, Y)
    Call ae_obj.MoveTo(X, Y)
    Call ae_obj.LeftClick()
End Function

//查找图片并点击，保持10秒尝试
Function ToolFindPicWhile10Sec(bmpSrc)
    ToolFindPicWhile10Sec = ToolFindPicWhileSec(bmpSrc, 10)
End Function

//查找图片并点击，保持20秒尝试
Function ToolFindPicWhile20Sec(bmpSrc)
    ToolFindPicWhile20Sec = ToolFindPicWhileSec(bmpSrc, 20)
End Function


//查找图片并点击，保持120秒尝试
Function ToolFindPicWhile120Sec(bmpSrc)
    ToolFindPicWhile120Sec = ToolFindPicWhileSec(bmpSrc, 120)
End Function


//查找图片并点击，保持secend秒尝试
Function ToolFindPicWhileSec(bmpSrc, secend)
    ToolFindPicWhileSec = False
    result = ToolFindPicClick(bmpSrc)
    If result = false Then 
        Delay 1000//用作当前方法的延时时间
        secend = secend - 1
        If secend <> 0 Then 
            ToolFindPicWhileSec = ToolFindPicWhileSec(bmpSrc, secend)
        End If
    Else 
        ToolFindPicWhileSec = True
        LogD("成功找到了"&bmpSrc&" 剩余时间:"&secend&"秒")
    End If
End Function

//在10秒内尝试查找图片
Function ToolNotFindPicWhile5Sec(bmpSrc)
    ToolNotFindPicWhile5Sec = ToolNotFindPicWhileSec(bmpSrc, 5)
End Function

//在20秒内尝试查找图片
Function ToolNotFindPicWhile10Sec(bmpSrc)
    ToolNotFindPicWhile10Sec = ToolNotFindPicWhileSec(bmpSrc, 10)
End Function

//在120秒内尝试查找图片
Function ToolNotFindPicWhile120Sec(bmpSrc)
    ToolNotFindPicWhile120Sec = ToolNotFindPicWhileSec(bmpSrc, 120)
End Function

//确定在时间内，一直找不到该图片
Function ToolNotFindPicWhileSec(bmpSrc, secend)
    result = ToolFindPic(bmpSrc)
    If (result) Then 
        ToolNotFindPicWhileSec = false//找到了，认为方法失败
    Else 
        ToolNotFindPicWhileSec = True//没找到，认为方法成功
    End If
    If result = false Then 
        Delay 1000//用作当前方法的延时时间
        secend = secend - 1
        If secend <> 0 Then 
            ToolNotFindPicWhileSec = ToolNotFindPicWhileSec(bmpSrc, secend)
        End If
    Else 
        ToolNotFindPicWhileSec = ToolNotFindPicWhileSec(bmpSrc, secend)
    End If
End Function

//在10秒内尝试查找图片
Function ToolNotFindPicUntilFindInSec5Sec(bmpSrc)
    ToolNotFindPicUntilFindInSec5Sec = ToolNotFindPicUntilFindInSec(bmpSrc, 5)
End Function

//在20秒内尝试查找图片
Function ToolNotFindPicUntilFindInSec10Sec(bmpSrc)
    ToolNotFindPicUntilFindInSec10Sec = ToolNotFindPicUntilFindInSec(bmpSrc, 10)
End Function

//在120秒内尝试查找图片
Function ToolNotFindPicUntilFindInSec120Sec(bmpSrc)
    ToolNotFindPicUntilFindInSec120Sec = ToolNotFindPicUntilFindInSec(bmpSrc, 120)
End Function

//确定在时间内，找不到一次就退出
Function ToolNotFindPicUntilFindInSec(bmpSrc, secend)
    result = ToolFindPic(bmpSrc)
    If result Then 
        Delay 1000//用作当前方法的延时时间
        secend = secend - 1
        If secend <> 0 Then 
            ToolNotFindPicUntilFindInSec = ToolNotFindPicUntilFindInSec(bmpSrc, secend)
        End If
    Else 
        ToolNotFindPicUntilFindInSec = True
    End If
End Function

//在10秒内在给定矩形内查找图片
Function ToolFindPicByRectWhile10Sec(bmpSrc,xStart,yStart,xEnd,yEnd)
    ToolFindPicByRectWhile10Sec = ToolFindPicByRectWhileSec(bmpSrc,xStart,yStart,xEnd,yEnd,10)
End Function

//在给定时间内在给定矩形内查找图片
Function ToolFindPicByRectWhileSec(bmpSrc,xStart,yStart,xEnd,yEnd,secend)
    result = ToolFindPicClickByRect(bmpSrc,xStart,yStart,xEnd,yEnd)
    If result = false Then 
        secend = secend - 1
        If secend <> 0 Then 
            Delay 1000
            ToolFindPicByRectWhileSec = ToolFindPicByRectWhileSec(bmpSrc,xStart,yStart,xEnd,yEnd,secend)
        End If
    Else 
        ToolFindPicByRectWhileSec = True
    End If
End Function

//根据对应时间尝试查找图片,这个方法只给测试用，性能很差
Function ToolFindPicWhileSecOnlyFor(bmpSrc, secend)
    result = ToolFindPic(bmpSrc)
    If result = false Then 
        secend = secend - 1
        If secend <> 0 Then 
            Delay 1
            ToolFindPicWhileSecOnlyFor = ToolFindPicWhileSecOnlyFor(bmpSrc, secend)
        End If
    Else 
        ToolFindPicWhileSecOnlyFor = True
    End If
End Function

//拖动工具
Function ToolDragMove(formX, formY, toX, toY)
    setpX = 0
    setpY = 0
    allSetp = 0
    offsetX = formX - toX
    offsetY = formY - toY
    Call ae_obj.MoveTo(formX, formY)
    Delay 5
    Call ae_obj.LeftDown()
    If offsetX > offsetY Then 
        allSetp = offsetX
    Else 
        allSetp = offsetY
    End If
    For allSetp
        If (setpX < offsetX) Then 
            If (formX > toX) Then 
                finalX= formX - setpX 
            Else 
                finalX= formX + setpX 
            End If
        End If
        If (setpY < offsetY) Then 
            If (formY > toY) Then 
                finalY= formY - setpY
            Else 
                finalY= formY + setpY
            End If
        End If
        Call ae_obj.MoveTo(finalX, finalY)
        setpX = setpX + 1
        setpY = setpY + 1
        Delay 1
    Next
    Delay 5
    Call ae_obj.LeftUp()
    Delay 5
End Function

Function LogD(text)
    TracePrint text
End Function

Function LogI(text)
    TracePrint text
    主窗体.日志框.Text = text & vbcrlf & 主窗体.日志框.Text
End Function

Function LogE(text)
    TracePrint text
    主窗体.日志框.Text = text & vbcrlf & 主窗体.日志框.Text
End Function

//释放对象
Sub OnScriptExit()
    Set ae_obj = Nothing
    LogStop
End Sub

Function TestAEPlugin()
    result = ae_obj.Capture(0, 0, 2000, 2000, "screen.bmp")
    If (result = 1) Then
        RunApp "E:\Program Files (x86)\按键精灵\按键精灵2014\Resource\screen.bmp"
    End If
End Function

Function TestGotoSereach()
    gotoRightSideCount = 5
    gotoLeftSideCount = 5
    Do While True
        Call GotoRightSide()
    Loop
End Function

Function 测试组队
    ToolSetCheckBox ("觉醒业火轮")
    ToolSetCheckBox ("觉醒风转轮")
    ToolSetCheckBox ("觉醒水灵轮")
    ToolSetCheckBox ("觉醒天雷轮")
    ToolSetCheckBox ("御魂")
    index = 1
    For 10
        ToolSetCheckBox ("第"&index&"层")
        index = index +1
    Next
End Function

Event 主窗体.自动剧情错误最大次数滑块.Slide
    主窗体.自动剧情错误最大次数LB.Caption = 主窗体.自动剧情错误最大次数滑块.Value
End Event
Event 主窗体.LoadOver
    主窗体.日志框.Text = ""
    主窗体.自动剧情错误最大次数LB.Caption = 主窗体.自动剧情错误最大次数滑块.Value
    Call setStoryFailCount(0)
    Call LogD("窗体内容加载完毕")
End Event
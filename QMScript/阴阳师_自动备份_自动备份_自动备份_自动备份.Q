[General]
SyntaxVersion=2
BeginHotkey=121
BeginHotkeyMod=0
PauseHotkey=19
PauseHotkeyMod=0
StopHotkey=123
StopHotkeyMod=0
RunOnce=1
EnableWindow=
MacroID=ac940ed2-e3d6-4c56-aba5-130490286f61
Description=阴阳师_自动备份_自动备份_自动备份_自动备份
Enable=1
AutoRun=0
[Repeat]
Type=0
Number=1
[SetupUI]
Type=1
QUI=主窗体
[Relative]
SetupOCXFile=
[Comment]

[UIPackage]
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


[Script]
Dim Hwnd//窗口句柄
Dim XY
Dim FILE_PATH
FILE_PATH = "C:\阴阳师脚本\"
LogStart FILE_PATH+"my.log"

PutAttachment "C:\阴阳师脚本","AE.dll"
Private Declare Function AeStartup Lib "C:\阴阳师脚本\AE.dll" () As Long//免注册功能
If (AeStartup() = 0) Then
    Call MsgBox("AE免注册初始化失败！", vbCritical, "VBdemo")
    EndScript
End If
Set ae_obj = CreateObject("AE.AeSoft")
Delay 500
hwnd = ae_obj.GetMousePointWindow()
result = ae_obj.BindWindow(hwnd, "ogl1", "windows3", "windows", 0)
If (result = 1) Then 
    call LogD("绑定成功，句柄为："&hwnd)
Else 
    Call MsgBox("绑定错误", vbCritical, "VBdemo")
    Set ae_obj = Nothing
    EndScript
End If
Delay 500
ae_obj.SetPath ("E:\Program Files (x86)\按键精灵\按键精灵2014\Resource")


//Call ToolFindPicWhile10Sec("探索10")

Do 
    StoryFailCount = 0
    Call StoryMission()
    Call PVETeamMession()
    Call MonsterMission()
Loop While true



//Call FindNPCToFight()
//Call FindBossBox()

//Call TestAEPlugin()
//Call 测试组队()


//剧情任务
Function StoryMission()
    If (主窗体.自动剧情副本.Value = False or 主窗体.自动剧情错误最大次数滑块.Value < StoryFailCount)Then 
        Call setStoryFailCount(0)
        Exit Function
    End If
    LogI("剧情副本，开始")
    StoryMission = False
    secend = 5 * 60
    loopStoryMission = False
    Do While loopStoryMission = False
        secend = secend - 1
        ToolFindPicClick("剧情-跳过")
        ToolFindPicClick("剧情-对话")
        ToolFindPicClick("剧情-快进")
        ToolFindPicClick("剧情-眼")
        If (isMainSence() = false) Then 
            Call ToolFindPicClick("剧情-问号")
        End If
        ToolFindPicClick("可攻击怪物标志")
        ToolFindPicClick("可攻击怪物标志2")
        result = ToolFindPicClick("战斗准备")
        If result = true Then 
            If (FindFightEnd()) Then //进入战斗
            	
            Else //战斗失败
                If (主窗体.自动剧情错误最大次数滑块.Value < StoryFailCount) Then 
                    LogI("剧情战斗失败，超过重试次数"&主窗体.自动剧情错误最大次数滑块.Value)
                    Call setStoryFailCount(0)
                    Exit Function
                Else 
                    Call setStoryFailCount(StoryFailCount + 1)
                    LogI("剧情战斗失败，当前失败次数"&StoryFailCount)
                End If
            End If
        End If
        result = ToolFindPicClick("剧情-终止")
        If result = true Then 
            LogI("剧情终止，退出剧情任务")
            loopStoryMission = True
            StoryMission =True
        End If
        If secend = 0 Then 
            LogE("超时，剧情终止，退出剧情任务")
            LogE("超时，剧情终止，退出剧情任务")
            LogE("超时，剧情终止，退出剧情任务")
            loopStoryMission = True
            StoryMission = False
        End If
        Delay 500
        Call GotoRightSide()
        //        Call ToolMoveToClick(100,100)//避免新NPC出现卡住
    Loop  
End Function

//PVE的关卡进入
Function PVETeamMession()
    If (主窗体.自动组队副本.Value = false)Then 
        Exit Function
    End If
    LogI("组队副本，开始")
    ToolSetCheckBox("主界面-卷轴")
    ToolFindPicWhile10Sec("主界面-组队")
    Delay 500
    If ToolFindPic("组队-" & (主窗体.组队副本关卡.ListIndex +1) & "-未勾选") = False Then 
        Call ToolDragMove(230, 400, 230, 140)
        Delay 500
    End If
    ToolSetCheckBox("组队-"&主窗体.组队副本关卡.ListIndex+1)
    ToolSetCheckBox("第" & 主窗体.组队副本层数.ListIndex+1 & "层")
    ToolFindPicWhile10Sec ("创建队伍")
    Rem 创建
    ToolFindPicWhile10Sec ("创建")
    Rem 等待队友
    If (主窗体.自动组队副本.Value = false)Then
        Log("自动组队副本开关被关闭，退出组队副本") 
        Exit Function
    End If
    if ToolNotFindPicUntilFindInSec120Sec("邀请") = false Then
        PVETeamMession = false
        LogE("无法等到队友")
        Exit Function
    End If
    
    Delay 1000//等待开始按钮变正常

    if ToolFindPicClickWithOutFind("开始战斗-已勾选") = false Then
        PVETeamMession = false
        LogE("无法找到开始战斗按钮")
        Exit Function
    End If
    
    //    If (result) Then FIXME 缺少组队超时的处理。如果搜索不到邀请也搜索不到开始战斗，则认为超时。
    Do
        Do
            result = ToolFindPicWhile20Sec("战斗准备")
        Loop While result
        resultForZuduiFight = FindFightEnd()
        If (resultForZuduiFight) Then 
            LogI("继续与上次队友组队")
            ToolFindPicWhile10Sec("确定")
            Delay 5000//等待队伍重新创建
            Goto 等待队友
        End If
        Delay 500
    Loop While resultForZuduiFight = false
    //    Else 
    //        LogE("错误，组队等待超时")
    //        LogE("错误，组队等待超时")
    //        Log ("错误，组队等待超时")
    //        Goto 创建
    //    End If
End Function

//自动探索副本
Function MonsterMission()
    If (主窗体.自动探索副本.Value = false)Then 
        Exit Function
    End If
    LogI("探索副本，开始")
    Call ToolMoveToClick(522,120)
    For 100
        result = ToolFindPicWhile10Sec("怪物-关卡-"&(主窗体.目标探索关卡.ListIndex+1))
        If result Then 
            Delay 3000
            result = ToolFindPicWhile10Sec("经验-探索")
            If result = true Then 
                If FindNPCToFight() Then
                    If 主窗体.探索副本是否优先剧情副本.Value Then 
                        LogI("当前是否有剧情副本")
                        If ToolFindPicByRectWhile10Sec("怪物-地图-返回(新)|怪物-地图-返回(新)2|怪物-地图-返回(新)|怪物-地图-返回(新)3|怪物-地图-返回(新)|怪物-地图-返回(新)4|怪物-地图-返回(新)5", 55, 5, 90, 40) Then 
                            LogI("有剧情副本，退出到主界面。等待自动副本开始")
                            Exit Function
                        Else 
                            LogI("没有，继续探索副本")
                        End If
                    End If
                End If
            End If
        End If
    Next
End Function

//搜寻可战斗的NPC
Function FindNPCToFight()
    loopForFindNPCToFight = False
    notCheckResult = False
    isCheckResult = False
    gotoRightSideCount = 5
    gotoLeftSideCount = 0
    
    LogI("开始搜索可战斗的怪物")
    Delay 5000
    Call ToolSetCheckBox("战斗锁定出战")
    
    Do While loopForFindNPCToFight = False//只有打完BOSS才会跳出，否则死循环
        resultForFoundBoss = ToolFindPicClick("可攻击BOSS标志")
        If resultForFoundBoss = true Then 
            LogI("找到BOSS")
            fightBossResult = FindFightEnd()//战斗
        End If
        resultForFoundNPC = ToolFindPicClick("可攻击怪物标志")
        If resultForFoundNPC = true Then 
            LogI("找到小怪")
            fightNPCResult = FindFightEnd()//战斗
            LogI("攻击小怪成功")
        ElseIf fightBossResult Then
            LogD("loopForFindNPCToFight:" & loopForFindNPCToFight)
            If FindBossBox() Then //找BOSS宝箱
                FindNPCToFight = True
                Exit Function
            End If
            Exit Do
        End If
        If resultForFoundBoss = False And resultForFoundNPC = False Then 
            LogI("没有搜索到小怪和BOSS，向右移动")
            Call GotoRightSide()//向右移动
        End If
        Delay 3000
    Loop
End Function

//查找BOSS宝箱
Function FindBossBox()
    FindBossBox = False//至少找到过一次（隐含逻辑是这个副本将会结束）
    Do
        result = ToolFindPicWhile20Sec("经验-结束宝箱")
        If result = true Then
            LogI("搜索到宝箱") 
            Delay 1500
            LogI("开启宝箱，点击左上角退出宝箱界面")
            Call ToolMoveToClick(70, 70)
            FindBossBox = True
            Delay 1500
        Else 
            LogI("没有找到宝箱")
        End If
    Loop While result = True
End Function

//向右移动，如果网游次数超过10次，则向左移动
Function GotoRightSide()
	Logi("拖动屏幕，搜索怪物")
    If (gotoRightSideCount > 0) Then 
        Call ToolDragMove(900,400,100,400)
        gotoRightSideCount = gotoRightSideCount - 1
    Elseif(gotoLeftSideCount > 0)
        Call ToolDragMove(100,400,900,400)
        gotoLeftSideCount = gotoLeftSideCount - 1
    Else 
        gotoLeftSideCount = 5
        gotoRightSideCount = 5
    End If
	Logi("拖动屏幕结束")
    Delay 5000
End Function

//等待战斗结束
Function FindFightEnd()
    LogI("进入战斗")
    loopFindFightEndRepeatCount = 5 * 60
    loopFindFightEnd = False
    
    Call ToolSetCheckBox("战斗模式自动")
    
    Do While loopFindFightEnd = False
        loopFindFightEndRepeatCount = loopFindFightEndRepeatCount - 1
        loopFindFightEnd = ToolFindPicClick("战斗结束-胜利1")
        If loopFindFightEnd = true  Then 
            LogI("战斗胜利")
            Delay 3000
            ToolFindPicWhile10Sec("战斗结束-胜利2")
            Delay 3000
            ToolFindPicWhile10Sec("战斗结束-胜利3")
            FindFightEnd = True
        Else 
            loopFindFightEnd = ToolFindPicClick("战斗结束-失败")
            If loopFindFightEnd = true Then 
                LogI("战斗失败")
                FindFightEnd = False
            End If
            If loopFindFightEndRepeatCount = 0 Then 
                loopFindFightEnd = True
                FindFightEnd = True
                LogE("战斗结束，但是因为超时！")
                LogE("战斗结束，但是因为超时！")
                LogE("战斗结束，但是因为超时！")
                LogE("战斗结束，但是因为超时！")
            End If
        End If
        Delay 1000
    Loop  
End Function

Function isMainSence()
    isMainSence = ToolFindPic("主界面-卷轴-已勾选|主界面-卷轴-未勾选")
End Function

Function setStoryFailCount(value)
    StoryFailCount = value
    主窗体.当前剧情战斗失败次数.Caption = StoryFailCount
End Function
















//设置选中框，尝试10次，成功设置返回true
Function ToolSetCheckBox(bpmSrc)
    notCheckResult = False
    isCheckResult = False
    ToolSetCheckBox = False
    repeatCount = 10
    Do While (repeatCount <> 0)
        repeatCount = repeatCount  - 1
        ToolFindPicClick (bpmSrc & "-未勾选")//先找到未勾选然后直接点
        Delay 500
        isCheckResult = ToolFindPic(bpmSrc&"-已勾选")//再获取是否已勾选状态
        notCheckResult = ToolFindPicClick(bpmSrc & "-未勾选")//最后在获取是不是未勾选
        If notCheckResult = False And isCheckResult = True Then 
            repeatCount = 0
            ToolSetCheckBox = True
        End If
    Loop
End Function

//查找图片工具
Function ToolFindPicClick(bmpSrc)
    If ToolFindPic(bmpSrc) Then 
        ToolFindPicClick = ToolPicClick()
    Else 
        ToolFindPicClick = False
    End If
End Function

//查找图片
Function ToolFindPic(bmpSrc)
    Call ae_obj.FindPic(0, 0, 1088, 700, bmpSrc + ".bmp", "000000", 0.7, 0, intX, intY)
    ToolFindPic = intX > 0 And intY > 0
    If intX > 0 And intY > 0 Then 
        //        TracePrint("找到了：" & bmpSrc & " X:" & intX & " Y:" & intY)
        LogD("找到了：" & bmpSrc & " X:" & intX & " Y:" & intY)
    Else 
        //        TracePrint("没找到：" & bmpSrc)
        LogD("没找到：" & bmpSrc)
    End If
End Function

//在一个矩形内查找图片
Function ToolFindPicClickByRect(bmpSrc,xStart,yStart,xEnd,yEnd)
    Call ae_obj.FindPic(xStart, yStart, xEnd, yEnd, bmpSrc + ".bmp", "050505", 0.7, 0, intX, intY)
    If intX > 0 And intY > 0 Then 
        ToolFindPicClickByRect = ToolPicClick()
        LogD("找到了：" & bmpSrc & " X:" & intX & " Y:" & intY)
    Else 
        LogD("没找到：" & bmpSrc)
    End If
End Function

//移动后点击
Function ToolPicClick()
    Delay 50
    Call ae_obj.MoveTo(intX, intY)
    Delay 50
    call ae_obj.LeftClick()
    ToolPicClick = True
    Delay 1000
End Function

//移动并点击XY
Function ToolMoveToClick(X, Y)
    Call ae_obj.MoveTo(X, Y)
    Call ae_obj.LeftClick()
End Function

//最长等待20秒找到图片并点击后，在5秒内图片消失
Function ToolFindPicClickWithOutFind(bmpSrc)
    result = ToolFindPicWhile20Sec(bmpSrc)
    If(result = false) Then
        LogD("没有找到"&bmpSrc)
        ToolFindPicClickWithOutFind = False
    Else
        LogD("找到"&bmpSrc&",检测点击后5秒内是否消失")
        ToolFindPicClickWithOutFind = ToolNotFindPicUntilFindInSec5Sec(bmpSrc)
    End If
End Function

//查找图片并点击，保持10秒尝试
Function ToolFindPicWhile10Sec(bmpSrc)
    ToolFindPicWhile10Sec = ToolFindPicWhileSec(bmpSrc, 10)
End Function

//查找图片并点击，保持20秒尝试
Function ToolFindPicWhile20Sec(bmpSrc)
    ToolFindPicWhile20Sec = ToolFindPicWhileSec(bmpSrc, 20)
End Function


//查找图片并点击，保持120秒尝试
Function ToolFindPicWhile120Sec(bmpSrc)
    ToolFindPicWhile120Sec = ToolFindPicWhileSec(bmpSrc, 120)
End Function


//查找图片并点击，保持secend秒尝试
Function ToolFindPicWhileSec(bmpSrc, secend)
    ToolFindPicWhileSec = False
    result = ToolFindPicClick(bmpSrc)
    If result = false Then 
        Delay 1000//用作当前方法的延时时间
        secend = secend - 1
        If secend <> 0 Then 
            ToolFindPicWhileSec = ToolFindPicWhileSec(bmpSrc, secend)
        End If
    Else 
        ToolFindPicWhileSec = True
        LogD("成功找到了"&bmpSrc&" 剩余时间:"&secend&"秒")
    End If
End Function

//在10秒内尝试查找图片
Function ToolNotFindPicWhile5Sec(bmpSrc)
    ToolNotFindPicWhile5Sec = ToolNotFindPicWhileSec(bmpSrc, 5)
End Function

//在20秒内尝试查找图片
Function ToolNotFindPicWhile10Sec(bmpSrc)
    ToolNotFindPicWhile10Sec = ToolNotFindPicWhileSec(bmpSrc, 10)
End Function

//在120秒内尝试查找图片
Function ToolNotFindPicWhile120Sec(bmpSrc)
    ToolNotFindPicWhile120Sec = ToolNotFindPicWhileSec(bmpSrc, 120)
End Function

//确定在时间内，一直找不到该图片
Function ToolNotFindPicWhileSec(bmpSrc, secend)
    result = ToolFindPic(bmpSrc)
    If (result) Then 
        ToolNotFindPicWhileSec = false//找到了，认为方法失败
    Else 
        ToolNotFindPicWhileSec = True//没找到，认为方法成功
    End If
    If result = false Then 
        Delay 1000//用作当前方法的延时时间
        secend = secend - 1
        If secend <> 0 Then 
            ToolNotFindPicWhileSec = ToolNotFindPicWhileSec(bmpSrc, secend)
        End If
    Else 
        ToolNotFindPicWhileSec = ToolNotFindPicWhileSec(bmpSrc, secend)
    End If
End Function

//在10秒内尝试查找图片
Function ToolNotFindPicUntilFindInSec5Sec(bmpSrc)
    ToolNotFindPicUntilFindInSec5Sec = ToolNotFindPicUntilFindInSec(bmpSrc, 5)
End Function

//在20秒内尝试查找图片
Function ToolNotFindPicUntilFindInSec10Sec(bmpSrc)
    ToolNotFindPicUntilFindInSec10Sec = ToolNotFindPicUntilFindInSec(bmpSrc, 10)
End Function

//在120秒内尝试查找图片
Function ToolNotFindPicUntilFindInSec120Sec(bmpSrc)
    ToolNotFindPicUntilFindInSec120Sec = ToolNotFindPicUntilFindInSec(bmpSrc, 120)
End Function

//确定在时间内，找不到一次就退出
Function ToolNotFindPicUntilFindInSec(bmpSrc, secend)
    result = ToolFindPic(bmpSrc)
    If result Then 
        Delay 1000//用作当前方法的延时时间
        secend = secend - 1
        If secend <> 0 Then 
            ToolNotFindPicUntilFindInSec = ToolNotFindPicUntilFindInSec(bmpSrc, secend)
        End If
    Else 
        ToolNotFindPicUntilFindInSec = True
    End If
End Function

//在10秒内在给定矩形内查找图片
Function ToolFindPicByRectWhile10Sec(bmpSrc,xStart,yStart,xEnd,yEnd)
    ToolFindPicByRectWhile10Sec = ToolFindPicByRectWhileSec(bmpSrc,xStart,yStart,xEnd,yEnd,10)
End Function

//在给定时间内在给定矩形内查找图片
Function ToolFindPicByRectWhileSec(bmpSrc,xStart,yStart,xEnd,yEnd,secend)
    result = ToolFindPicClickByRect(bmpSrc,xStart,yStart,xEnd,yEnd)
    If result = false Then 
        secend = secend - 1
        If secend <> 0 Then 
            Delay 1000
            ToolFindPicByRectWhileSec = ToolFindPicByRectWhileSec(bmpSrc,xStart,yStart,xEnd,yEnd,secend)
        End If
    Else 
        ToolFindPicByRectWhileSec = True
    End If
End Function

//根据对应时间尝试查找图片,这个方法只给测试用，性能很差
Function ToolFindPicWhileSecOnlyFor(bmpSrc, secend)
    result = ToolFindPic(bmpSrc)
    If result = false Then 
        secend = secend - 1
        If secend <> 0 Then 
            Delay 1
            ToolFindPicWhileSecOnlyFor = ToolFindPicWhileSecOnlyFor(bmpSrc, secend)
        End If
    Else 
        ToolFindPicWhileSecOnlyFor = True
    End If
End Function

//拖动工具
Function ToolDragMove(formX, formY, toX, toY)
    setpX = 0
    setpY = 0
    allSetp = 0
    offsetX = formX - toX
    offsetY = formY - toY
    Call ae_obj.MoveTo(formX, formY)
    Delay 5
    Call ae_obj.LeftDown()
    If offsetX > offsetY Then 
        allSetp = offsetX
    Else 
        allSetp = offsetY
    End If
    For allSetp
        If (setpX < offsetX) Then 
            If (formX > toX) Then 
                finalX= formX - setpX 
            Else 
                finalX= formX + setpX 
            End If
        End If
        If (setpY < offsetY) Then 
            If (formY > toY) Then 
                finalY= formY - setpY
            Else 
                finalY= formY + setpY
            End If
        End If
        Call ae_obj.MoveTo(finalX, finalY)
        setpX = setpX + 1
        setpY = setpY + 1
        Delay 1
    Next
    Delay 5
    Call ae_obj.LeftUp()
    Delay 5
End Function

Function LogD(text)
    TracePrint text
End Function

Function LogI(text)
    TracePrint text
    主窗体.日志框.Text = text & vbcrlf & 主窗体.日志框.Text
End Function

Function LogE(text)
    TracePrint text
    主窗体.日志框.Text = text & vbcrlf & 主窗体.日志框.Text
End Function

//释放对象
Sub OnScriptExit()
    Set ae_obj = Nothing
    LogStop
End Sub

Function TestAEPlugin()
    result = ae_obj.Capture(0, 0, 2000, 2000, "screen.bmp")
    If (result = 1) Then
        RunApp "E:\Program Files (x86)\按键精灵\按键精灵2014\Resource\screen.bmp"
    End If
End Function

Function TestGotoSereach()
    gotoRightSideCount = 5
    gotoLeftSideCount = 5
    Do While True
        Call GotoRightSide()
    Loop
End Function

Function 测试组队
    ToolSetCheckBox ("觉醒业火轮")
    ToolSetCheckBox ("觉醒风转轮")
    ToolSetCheckBox ("觉醒水灵轮")
    ToolSetCheckBox ("觉醒天雷轮")
    ToolSetCheckBox ("御魂")
    index = 1
    For 10
        ToolSetCheckBox ("第"&index&"层")
        index = index +1
    Next
End Function

Event 主窗体.自动剧情错误最大次数滑块.Slide
    主窗体.自动剧情错误最大次数LB.Caption = 主窗体.自动剧情错误最大次数滑块.Value
End Event
Event 主窗体.LoadOver
    主窗体.日志框.Text = ""
    主窗体.自动剧情错误最大次数LB.Caption = 主窗体.自动剧情错误最大次数滑块.Value
    Call setStoryFailCount(0)
    Call LogD("窗体内容加载完毕")
End Event
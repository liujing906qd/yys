[General]
SyntaxVersion=2
BeginHotkey=121
BeginHotkeyMod=0
PauseHotkey=19
PauseHotkeyMod=0
StopHotkey=123
StopHotkeyMod=0
RunOnce=1
EnableWindow=
MacroID=ca1aef41-2838-41fe-88d3-d83ddba4350a
Description=阴阳师_自动备份_自动备份_自动备份_自动备份
Enable=1
AutoRun=0
[Repeat]
Type=0
Number=1
[SetupUI]
Type=1
QUI=主窗体
[Relative]
SetupOCXFile=
[Comment]

[UIPackage]
UEsDBBQAAgAIAPAMQ0l0YK4IYRYAAAgqAQAJABEAVUlQYWNrYWdlVVQNAAfstvFX7LbxV+y28VftXQd4FlXWPhNagFClNymCSJHeQSSRaqihiQgGCBAICSQgxbq7rv62dXt1C5tdYZFVwATEGKIQWkIJobkua1lWWayoCLgs8J8z8w0ZQrJ+585JDp/k+pznfpKZ+85t5973vXfulAMn5O2v9e7K9Y3eg0LhNigHFy9VhoqefwtDs9z/qen8fzm0i5cuXXL/+RG0S2UhZMIFtPJYZ93RqK4roFVCq4wWjlYFrRpaVbQItOpO1UMNtFpoN6DVRquDVg+tLlp9tIZoDdAaoTVGa4J2I1pTtGZozdFaorVAa4XWGu0mtDZobdFuRrsFrT1aO7QOaLeidUTrhNYFrTNaV7QeaN3QeqLNQeuN1gutD1p/tL5o/dAGoA202zbA7WiRaIPQotAGo92BNgRtGNpQtOFod6KNQItGG4U2Em002li0MWjj0MajxaBNQJuMNhFtEtpdaHejTUGbijYN7R606WixaPeizUCbhTYTLQ5tLtpstPhAv0rAeB7afLQFaEloiWgL0ZLRFqGloC1BW4x2H9oytKVoy9HuR1uB9gDaQ2gPoj2M9l2079jPn4T/Lcb6GIzpLsY0lwMn1MMW47Yl6xuu7dx41YWDTfIt8hl2wdhlNtyuR9MQDpbl4v+imGtq7n3exnXxvX+LwtqL9vEEVTz4Fb4B3429fxuP5b0Qa34UtogFdgvghdoQZuPXCvjdYO8rH4ipjV1PNiDQ/wcGfEBpYE65hst5SFLyAh/dD46cTVu3533z+y3wF/ze7zfkf3XgdM7z5vczumyJ3G/qdwr8X9gV871g68ydV9KoE4ujYILhM1RH/1cVnHlKsPhhHv83EUfaFDTTJ6hpkP9yHvxxiBqLM4DRWA4JzLHX9f8RgTSDxS/vwR+P+MvsmYNx/Vvc/Ffw1H8Uzj4S0JINn6SOAX5FT/4L8COxHmba8ywmvj1frsEo/0qF6n+mz/Kn+Xk4Az8cnDm8N0zATvEXbWdqECop458pusztkhwZ0zwmNjGleUxccvzsEsJv/cI0X/dPQc+TjP4nzmYT/ED+t26gTwXb/ip72n809j1+r7uy/dcMpBcsfpUi+38MPsdcLAfeaNgA+7/LgYPFr+rBH4Sz/4X2GJCMlojPwBuF6mH+K4PDy4PFj/DgD8G8J/rzP+zxj/xV/8v5T8DRdw4+A5V7oon/Z+NXv6L+Y7H8F+MzUDlE2vXgjgQFbaP40NZg/KnhwY+003f6XzB4RbQ/qw4UaG7B3FPTg+/Xf/idf/oNwxMXLlkcmbTM9P5dh49syfrCHD/U+ct4bPmL7bmvSeuz/Q+7/9XytL8xiL8M0RNsFYsfqhvg176i/5P+08WH/7Ms4hOkTzYsrr+Vgv7TGoL3/zRehQd+a/A/8leS/I905WaM/NcFUf5nNQdHtw4Wvx7I8j/S2Osz8OuDLv/zrhcJ8D92+2sAsvyP1jdaMcq/IcjyP1pDacLAbwRX8z/T4Hf8J9/ZAj3iXYb8Mwx0QzllfL/8U4D/sftfY5DlfzcF+nSw+E1Alv/ROmVbBn5TkOV/tFbakoHfDHT5H43XmvyvOXjnn7E4/qfA0gAP44baBvgtPPgjYQmWAPHPaLRE9hyE9E9qT+0Z9d/Sg68d/PIfv/y1XfpcX/c3Xjne1/1+x6/xsTOikhIXJyclmN0/ym73C7AXJBjrD9z238rT/oYh3n3G6ofj/9oBT/+4qZD/m4l9MKUU+W9rDz6NOsk2ckJAfSp5/9cGCvPfrsbtz7v/oVMx15Q0/+3PrP+bwdGAnfZf+vyX5gqS/Jf2P3WH4P3/LZ76P7By/6dZq839T6jrX36DlP45GQeCpgaF4bf8JPSPnsz+1w5k9Q/avdWR0f7bg6j+Acr6B3v87QCy+gepp30Y5d8RZPUP2uvZj4F/KxToHxr8txPI8t++gTwFi98Z5Ob/oa5/lIPwPZm5Z19Zv35L+NGTGw/aP7ac2HmSfgSB73f+rr3/S0D/sGgPdSSj/XUBWf2D9n4PYOB3BV39g57X1T+GIzaVeYohfgTmn/IzkJF/mis2DfyOsdfeHB8cV0r6Rw/wjr80++WsuF8ZGiF+b3D28AeL3/Mq/BTjJ2hikP9e4OV/i3HWk2DMQCIM8HvDtaP/NPF5v1/9h+YBEUcPbXzJ9fnk0COys9Z/SMPC5jcdblQnff3OdXTF4cyNm3JWrTuWti/nAl1Z071t8/PZxzJP7j4W5qbnjirg/oM7utDQ1MD9a87OTZ8f3L5/l3fEiXCv3HA85wJdXc99vrRP9n159NO0Lwk9OpKgKkYPihwcTR068LNbmDcFen7r8t+6FtzRhX5Wwadw2z/NguIDCmzs5f0w3xyaG7S/PkX0v2GITTrwXKYvNtFf+l7R/wr8n6H+xcbvB1fOv50yd9TfWcwRoRn6f/d9pmDxaexpGyCOditMfdXOSlHNLGNt1sn/NceJSlowI8nH/pvCPY0byvQHv/M/0v+6Gd9P+h/tZyAGM7Q4H1vC+t944OkPNF/V3P9Cc+WIwG8J/Y/eSYxm9P8okN3/MopZ/neArP4zDJz3N4PFHwzy+19iGPglof9MZuAPAVn9h96THcvAHwqy+g+9jzuCgT8MdPWf4SCr/4wL1Gmw+CM8+PQ+8hNov0L7nQF+2f4bf/pTRaiY/lZ+xuGtGG1aaUe7LtpR7ht2tO+kHW3NPLy1JJ5fYv8Lve8+gdH+7gRZ/YfSG8PAjwZd/YfGa0H9h41P43WHwG8N/We0p/w19h+MAdn9B5OAN/8ZC7r7D8aB3Psf2vtn/D5/dOyMuAQf9xfWf7j3a/PX4dj6yAOatT6z/ScxUHj/SXfj5/fuP5lazDUu72x+uuTev5gLwY8/1OIrXPZ/pc8/aax2578S/JPOsIll5H8iyPJPOjtnHgN/EsjyT5pDT2HgTwbd9y/oXKKFIBO2ZaXty9y+fkt+RtaanNe27M14j+TsI2l5ebkHcs/a8nZe1u6D21w/mXkuL29larUq1arkfp1/aNeJzedfOfzqtg0Z+z9KP07XpGdnrEtdm7U7/9DmtAMr92/d9kF6tqtL0l2F8bXfX6R3iWg/V/cwp1y5QZu/aOw/uRtk9QdqAbMZ/W8qyOoPNGuezsC/B3T1h2kgqz/MCdRpsPjTQfT9C7v9xTPw7wVZ/knpxTHwY0GXf9J43f8a8T/a52doh6i5cTPn+1g/K7zUzA0a79/MBO/8x+l3KdgLqQ9yn8Fk/XXWFf1/CeIlofeJhxVm8382fhwU5j89fPR/y6J5B53lWNx6vct7SpL/PMjwf9SXNdffaLySXH+j9prCyP9c0D1/LN6DH+rr5379n98gwR/IH9HZrCaDQITP55fgv3S+bAKj/c8Def77AAN/vqfcpPjP/Qz8BJDlPwsDbSdY/AUgy3/ozOFFDPxE0OU/SSDLf5YHyjRY/IUg+/75wwH/ESz+Iijb/y8VQn3/mAT/pZ67lNH+kkGX/9Jcrf/l/jfX9oDzjVY/Hf15ScCnBIu/GK4e/8YZ7X41419LQHf/+X3g5V+lzz+Xgvz68yOM+l8GsuvP3Pwvh2/P+q+EfsJ43euqEOr8aYytudAJKOT/zN6/4ba/FVBY/+hp/Pze9d9Hi7mmNPSPnzD6P3EFTf2DuJKk/vEkOHsIg8V/EHT1j4dAdv33h+B8TyVY/IdBnv/+mIH/iKf+r7fvf5TZlZa1ZsdpdwzUGH/86md0lui94HDa+w3u134P8tuy/v8jhv/5DsjqX49h/AMG/ndBVv96GuPHGfjfA13961GQ1b+eDeQpWPzvg6z+9TOMf8rAfwxk1///D+NnGPiPg67+Qc/r6h9l+pm/EPL8WUD/eirQp4Ntf0+Arv71JOjqX0+Brv71NMjrXz9n1P8zoKt//QC857+Wvv7xLBTWP3oZ91/SP+h92nfQfl3MNaWhfzzPqH/iy5r7338Ezhn8FCT0jz9g/HtG/n8MsvvfV2K8moH/Ew++3/dfij6aJPj7Q10/7ezzfu396xL6128w/iWj/f0UdN9/+Jmn3Wjsf/85yPLf5zD+E6P8fwGy/PePGP+Wgf9L0OW/vwJZ/vvnQJrB4v8a5Pe/r2Lg/8aDfwKc8eAMmslnbKuCbijbv+4vSOgfdG5EKqP9PQe6+gf5Ks3vT/wOdPe//x5097//AQrzn94+6r9g/XdtMdeUBv95hdH+ab6uyX9ovK4o5D/88gf7fvPPD4Q8f0jbl7p2b+7LZ4hDZaeuTO2ctm/L3pydGzL2v31kB/5px2tneqTtK/5+v/xBgv9uwHg9o/2ngiz/fRnjVxn4fwLZ9f+/YryGgf9n0OU/NM9rE/itwX9WgSz/eRHjjYzyXw2y/CcN45cY+H8BXf6zxpN/v/rBOXD0rFOWM65wg/b32693/iDBfzdh/AKj/b8A8vx3MwN/Lciu/67DOJ2B/1fQ5T/kLzX5z0ugy3/WgS7/WQ+F+U8fH/VvWTSe7EUrbgPz/+I/2kGEP5h/vjvk+YP3QPq0z9IzufdL8d8chv8jvqDJf4kvSH5/LRvjbYz8p4Es/9mO8R4GfjrI8p8sjF9j4G8EXf6zCQrm3xr85xWQ5T+vY7yLUf6bQe79H7/8gc7OovUHWpNPNbhfSscyDaHOHyT47w6M32C0v1dBl/9mgOz6326MMxn5fw3k+U8uAz8TZPkPHUy9k4G/BXT5D41XmvznddDlP2/AtfP9J7/BL39wz45xPoHDD6HOHzT471YozH+7GO+jivCs/+UVc01prP8dY/g/4gqa/CcbCr5/LcF/jmB8mJH/7SDLf45i/DYDfwfI8p8DGO9j4O8EXf6zy1P/fv2fNn+gfbxPg3Om/XMG92v73+vx/N/dIMt/8zF+i9H/ckB2/e9NjA8y8HNBl//sAVn+83eM9zPyvxfk+c8/GPj7QJb/HML4bwz8/aDLf2iedK28/6cdYhLiZ8Ulm99f3Dczg71fmz9o8N8DoMt/80F3/e8gXM1/TJewiP+QnlUVG8I/i7mmNPgPJ//kL13dVoD/sPEP2+3GCRL859/g7KMPFv8IyPKfk8D7/tRRkOU/xzF+l5H/N0Ge/5wC3e9vcsr/byA7//0Xxh8z8v8WXDv6n1/+R2cZ0Pu81AZN3l8JV86/Nv+T4D8fYvw+o/39HXT5zzEQ5T/wGcbvMfL/D5DlP18Cz/+/DbL85wOMv2Dk/x3Q5T/vQgH/GYm5Nj480vYffPz3PPkfiWN/oj9861OMP2GU/z89+H75X2Vl/+V3HNPmX37106jdj/m6f6J98seSUj3/5Dh453/xtv8dYnO/RfaTkBcKdibaBNv/aab/+5cHn0af+ADrjEWLt/1R8IH450cYf87of++Dd/7vln/pff/1gyLxI2FoKZ1/cgKu5r+mr4B51//OFXNNafDfSlbw9U98UfP815Pg+f6FwPnJR09uPHi9np/sN/9+g1/+JKF/XMT4AsP/fQi65/9+BLL6R3nLOT8hWPyPQV7/qMjwP5+A/PdvKjDwPwVZ/eM/GIcx8D8D2fU/ckLnGfV/CnT57+ee/Lvfn6JvIqwwwK8GuqHs+zP+gsT6bzl8iLOM9v8FyJ7/Whnxwxn9/0uQ1T/+S/XAwD8NuvrHVyD7/RsC/ZpR/2dA9/zPs6B7/uc50D3/82u4dvT/kD8/N2nBjCQ//CnAHTa/mbXa5H6//l/q/NcqDP/3H9A9//U86J7/+l+4Wv/oZux/LIv8eQ8s/+rFNIaS1j8aWzz9jbiipv5xEWS/f1MH838Do/1fAtn1/7rM8ien4eJrfHOkmVX23RlTkw6hfv6+X/1rLDjn19CZJKuM+r9u8Mt/JfSvGtiIIhj+z7Lk9a9Glu7+nxsZ+GGWrP5VE9NrwMAvZ8nqX/UwvVoMfNJLNfWvCpbs/veGmF41Rv4rWrL6R1NMrwkDv5Ilq3/UxvTqM/DDLV39g/QiV/8YjthU5imG+Cb8n7iSO9+PQfSEQB80UWBM9h9XteT4v1/9swJU2fJV3oH89IxTW4/YPzedOLpm03n7Z+6Lb5x8/ZT9c8/Hrx/dnF3+4NcZH4JkCHX9we/zS/F/TvuLsGT5fzMm/6lWyP/MhCXY/0tv/0V1D/5wRCcPaIZupv/VsK7WH7ob+7+C/RetlPSHzsz6p/mSpv5AcyVJ/eEWTK8tY/yt7a1/If1yw/GcCyb3h/r+D7/BL3+lvQx0ftJgyznXlhsk9Kd2zP53gyW7/+ImTK8Fo/3XKQH+2UmZf3Zn4NcV5p+tMb2ODPx6wvyzPabXhoFfX5l/NhDmn7diei0Z+W/owa+h7P9Cff9GZaiY/lZ+xobjGG28aEe7LthRbrYd7Xvfjna8Y0frcu1oy3Y7ynlxw3Hl/EvoD12xtLow2l8jYf3hZkyvAwO/sbL+0ERZfyC9aFDgt4b+cKMl//1RDn5zYf7ZjTn/aaHMP1tacud/hrr+4ff8uPT1O9fR+Q/ec5g592vzHw39oVUR+kMPY/9n2f35LrTeSvoD5fsOxvhDfEXz/Dear9cJ/JbQH27D9AYw8t/Gkt3/MBDTG8LAv1mYf/bB9Hoy8Ntauue/kV4kpZuE+vdv64c5+zH7hjnrQtxQC3SDX/6kcf5FO2H9oS+mF8nof+2F9YfbMb1+DPwOyvpDR2H9IQrT68XI/62W/Plvgxn4nYT5Z3/iUwz8zsr8s4uHf/oN1/v5cSLfr+lmfn8onv/W1dI9/62bpXv+W/ci+E9Pw/oj/uNij1DkPxMZ/q+HMv+hubrk93/GYHqjGfnvJcx/xmJ6kxn4vT342uunhbUT7jnU2vxhteXwh2Zhzr46fv3pBgn+eyfmexij/fVR5r/EF2oHfmvwn37C/Cca0xvPKP/+HvwLeM/3MKZThB5F+z7a42hPgHO23pPgnK/+FNozaM+Cc97eD8HZN0/fbaL9ByX1fkJZKNkgwX/HYXsayWh/A5T5723C/HcCpjeckf+BJcB/JzHwb/fgX+/nJ2gHv+cvud/vyNm56fOD2/fvovkU5ywiCf1jFNZWDKP9DVLWPyIt3e9/RSnz3zuU+e/gIvhvL8P6p/3HQzG9JLSp38B/OzdeVWL8dz6j/Q9R3n9M5SV5/vkMTC+Wkf9hlu75X8OF1//mYnpTGPkfUQL8Zx4D/07P+m+o7792x73Mc3l53LFPIvjVD2j9lL6HTd+E22Fwf22fzy/Ff+MZ7S9amP9Ow/RmM/BHCq//zcL0pjPwRynzn9HC/GcOpnc3I/9jhN9/XYDpJTDwxwqv/92L6cUx8Mcpz39jBNf/ys7fC+0gcf7bTCyEexjtf7yle/7bBEv3/LeJlu75b5NKYP91IqP+J1u653/dZeme/zWlCP7b27j9Faz/JhfjjFzeWxT/DfX93yL7L7qb3x/q/ElK/3iI0f/vVl7/nyq8/r8M01vKyP89wuv/yzG9Rxj404T1jxRMbyEDf7ry+i/N111/q7H+GyvMfxdjeg8wyn+GB3/Xic3nD+blbU3PdtWT1LWHvtib+/KZ9MwjZzNPbPtgZWrev/PX7F2bsz5rzY7Thb91oL3/gr5ln4bWKsxMP7lB2f9+G77/tgLb0xJG+5uprH/MEtY/HsT0FjHyH1cC678PM/BnC+sf92F69zPw5yjrH3OV1//ildf/5lly338rC6EdNNZ/51uy589z8aVDKOP/P1BLAQIXCxQAAgAIAPAMQ0l0YK4IYRYAAAgqAQAJAAkAAAAAAAAAAAAAgAAAAABVSVBhY2thZ2VVVAUAB+y28VdQSwUGAAAAAAEAAQBAAAAAmRYAAAAA


[Script]
Dim Hwnd//窗口句柄
Dim XY
Dim FILE_PATH
FILE_PATH = "C:\阴阳师脚本\"
LogStart FILE_PATH+"my.log"

PutAttachment "C:\阴阳师脚本","AE.dll"
Private Declare Function AeStartup Lib "C:\阴阳师脚本\AE.dll" () As Long//免注册功能
If (AeStartup() = 0) Then
    Call MsgBox("AE免注册初始化失败！", vbCritical, "VBdemo")
    EndScript
End If
Set ae_obj = CreateObject("AE.AeSoft")
Delay 500
hwnd = ae_obj.GetMousePointWindow()
result = ae_obj.BindWindow(hwnd, "ogl1", "windows3", "windows", 0)
If (result = 1) Then 
    call log("绑定成功，句柄为："&hwnd)
Else 
    Call MsgBox("绑定错误", vbCritical, "VBdemo")
    Set ae_obj = Nothing
    EndScript
End If
Delay 500
ae_obj.SetPath ("E:\Program Files (x86)\按键精灵\按键精灵2014\Resource")


//Call ToolFindPicWhile10Sec("探索10")

StoryFailCount = 0
Call StoryMission()
Call PVETeamMession()
Call MonsterMission()


//Call MonsterMission()
//Call StoryMission()

//Call FindNPCToFight()
//Call FindBossBox()

//Call TestAEPlugin()
//Call 测试组队()


//PVE的关卡进入
Function PVETeamMession()
    If (主窗体.自动组队副本.Value =false)Then 
        Exit Function
    End If
    Log("组队副本，开始")
    ToolSetCheckBox("主界面-卷轴")
    ToolFindPicWhile10Sec("主界面-组队")
    Delay 500
    If ToolFindPic("组队-" & 主窗体.组队副本关卡.ListIndex +1 & "-未勾选") = False Then 
        Call ToolDragMove(230, 400, 230, 140)
        Delay 500
    End If
    ToolSetCheckBox("组队-"&主窗体.组队副本关卡.ListIndex+1)
    ToolSetCheckBox("第" & 主窗体.组队副本层数.ListIndex+1 & "层")
    ToolFindPicWhile10Sec ("创建队伍")
    Rem 创建
    ToolFindPicWhile10Sec ("创建")
    Do
        ToolFindPicWhile120Sec("开始战斗-已勾选")
        Delay 5000
        result = ToolFindPicWhile20Sec("战斗准备")
    loop while result
    If (result) Then 
        Call PVEFight()
    Else 
        Log("错误，组队等待超时")
        Log("错误，组队等待超时")
        Log ("错误，组队等待超时")
        Goto 创建
    End If
End Function

//自动探索副本
Function MonsterMission()
    If (主窗体.自动探索副本.Value = false)Then 
        Exit Function
    End If
    Log("探索副本，开始")
    Call ToolMoveToClick(522,120)
    For 100
        result = ToolFindPicWhile10Sec("怪物-关卡-"&(主窗体.目标探索关卡.ListIndex+1))
        If result Then 
            Delay 3000
            result = ToolFindPicWhile10Sec("经验-探索")
            If result = true Then 
                If FindNPCToFight() Then
                    If 主窗体.探索副本是否优先剧情副本.Value Then 
                        Log("当前是否有剧情副本")
                        If ToolFindPicByRectWhile10Sec("怪物-地图-返回(新)|怪物-地图-返回(新)2|怪物-地图-返回(新)|怪物-地图-返回(新)3|怪物-地图-返回(新)|怪物-地图-返回(新)4|怪物-地图-返回(新)5", 55, 5, 90, 40) Then 
                            Log("有剧情副本，退出到主界面。等待自动副本开始")
                            Exit Function
                        Else 
                            Log("没有，继续探索副本")
                        End If
                    End If
                End If
            End If
        End If
    Next
End Function

Function setStoryFailCount(value)
    StoryFailCount = value
    主窗体.当前剧情战斗失败次数.Caption = StoryFailCount
End Function

//剧情任务
Function StoryMission()
    Log ("主窗体.自动剧情副本.Value:" & 主窗体.自动剧情副本.Value)
    Log("主窗体.自动剧情错误最大次数滑块.Value:"&主窗体.自动剧情错误最大次数滑块.Value)
    Log("StoryFailCount:"&StoryFailCount)
    If (主窗体.自动剧情副本.Value = False or 主窗体.自动剧情错误最大次数滑块.Value < StoryFailCount)Then 
        Call setStoryFailCount(0)
        Exit Function
    End If
    Log("剧情副本，开始")
    StoryMission = False
    secend = 5 * 60
    loopStoryMission = False
    Do While loopStoryMission = False
        secend = secend - 1
        ToolFindPicClick("剧情-跳过")
        ToolFindPicClick("剧情-对话")
        ToolFindPicClick("剧情-快进")
        ToolFindPicClick("剧情-眼")
        If (isMainSence() = false) Then 
            Call ToolFindPicClick("剧情-问号")
        End If
        ToolFindPicClick("可攻击怪物标志")
        ToolFindPicClick("可攻击怪物标志2")
        result = ToolFindPicClick("战斗准备")
        If result = true Then 
            If (FindFightEnd()) Then //进入战斗
            	
            Else //战斗失败
                If (主窗体.自动剧情错误最大次数滑块.Value < StoryFailCount) Then 
                    Log("剧情战斗失败，超过重试次数"&主窗体.自动剧情错误最大次数滑块.Value)
                    Call setStoryFailCount(0)
                    Exit Function
                Else 
                    Call setStoryFailCount(StoryFailCount + 1)
                    Log("剧情战斗失败，当前失败次数"&StoryFailCount)
                End If
            End If
        End If
        result = ToolFindPicClick("剧情-终止")
        If result = true Then 
            Log("剧情终止，退出剧情任务")
            loopStoryMission = True
            StoryMission =True
        End If
        If secend = 0 Then 
            Log("超时，剧情终止，退出剧情任务")
            Log("超时，剧情终止，退出剧情任务")
            Log("超时，剧情终止，退出剧情任务")
            loopStoryMission = True
            StoryMission = False
        End If
        Delay 500
        Call GotoRightSide()
        //        Call ToolMoveToClick(100,100)//避免新NPC出现卡住
    Loop  
End Function

Function isMainSence()
    isMainSence = ToolFindPic("主界面-卷轴-已勾选|主界面-卷轴-未勾选")
End Function

//PVE的战斗
Function PVEFight()
    Do
        resultForZuduiFight = FindFightEnd()
        If (resultForZuduiFight) Then 
            Log("继续与上次队友组队")
            ToolFindPicWhile10Sec ("确定")
            call PVEFight()
        End If
        Delay 500
    Loop While resultForZuduiFight = false
End Function

//搜寻可战斗的NPC
Function FindNPCToFight()
    loopForFindNPCToFight = False
    notCheckResult = False
    isCheckResult = False
    gotoRightSideCount = 5
    gotoLeftSideCount = 0
    
    Log("开始搜索可战斗的怪物")
    Delay 5000
    Call ToolSetCheckBox("战斗锁定出战")
    
    Do While loopForFindNPCToFight = False//只有打完BOSS才会跳出，否则死循环
        resultForFoundBoss = ToolFindPicClick("可攻击BOSS标志")
        If resultForFoundBoss = true Then 
            Log("找到BOSS")
            fightBossResult = FindFightEnd()//战斗
        End If
        resultForFoundNPC = ToolFindPicClick("可攻击怪物标志")
        If resultForFoundNPC = true Then 
            Log("找到小怪")
            fightNPCResult = FindFightEnd()//战斗
            Call Log("攻击小怪成功")
        ElseIf fightBossResult Then
            Log ("loopForFindNPCToFight:" & loopForFindNPCToFight)
            Delay 3000//等待宝箱到位
            If FindBossBox() Then //找BOSS宝箱
                FindNPCToFight = True
                Exit Function
            End If
            Exit Do
        End If
        If resultForFoundBoss = False And resultForFoundNPC = False Then 
            Call Log("没有搜索到小怪和BOSS，向右移动")
            Call GotoRightSide()//向右移动
        End If
        Delay 3000
    Loop
End Function

//查找BOSS宝箱
Function FindBossBox()
    FindBossBox = False//至少找到过一次（隐含逻辑是这个副本将会结束）
    Do
        result = ToolFindPicClick("经验-结束宝箱")
        If result = true Then
            Log("搜索到宝箱") 
            Delay 1500
            Log("开启宝箱，点击左上角退出宝箱界面")
            Call ToolMoveToClick(70, 70)
            FindBossBox = True
            Delay 1500
        Else 
            Log ("没有找到宝箱")
        End If
    Loop While result = True
End Function

//向右移动，如果网游次数超过10次，则向左移动
Function GotoRightSide()
    If (gotoRightSideCount > 0) Then 
        Call ToolDragMove(900,400,100,400)
        gotoRightSideCount = gotoRightSideCount - 1
    Elseif(gotoLeftSideCount > 0)
        Call ToolDragMove(100,400,900,400)
        gotoLeftSideCount = gotoLeftSideCount - 1
    Else 
        gotoLeftSideCount = 5
        gotoRightSideCount = 5
    End If
End Function

//等待战斗结束
Function FindFightEnd()
    Log("进入战斗")
    loopFindFightEndRepeatCount = 5 * 60
    loopFindFightEnd = False
    
    Call ToolSetCheckBox("战斗模式自动")
    
    Do While loopFindFightEnd = False
        loopFindFightEndRepeatCount = loopFindFightEndRepeatCount - 1
        loopFindFightEnd = ToolFindPicClick("战斗结束-胜利1")
        If loopFindFightEnd = true  Then 
            Log("战斗胜利")
            Delay 3000
            ToolFindPicWhile10Sec("战斗结束-胜利2")
            Delay 3000
            ToolFindPicWhile10Sec("战斗结束-胜利3")
            FindFightEnd = True
        Else 
            loopFindFightEnd = ToolFindPicClick("战斗结束-失败")
            If loopFindFightEnd = true Then 
                Log("战斗失败")
                FindFightEnd = False
            End If
            If loopFindFightEndRepeatCount = 0 Then 
                loopFindFightEnd = True
                FindFightEnd = True
                Log("战斗结束，但是因为超时！")
                Log("战斗结束，但是因为超时！")
                Log("战斗结束，但是因为超时！")
                Log("战斗结束，但是因为超时！")
            End If
        End If
        Delay 1000
    Loop  
End Function

















//设置选中框，尝试10次，成功设置返回true
Function ToolSetCheckBox(bpmSrc)
    notCheckResult = False
    isCheckResult = False
    ToolSetCheckBox = False
    repeatCount = 10
    Do While (repeatCount <> 0)
        repeatCount = repeatCount  - 1
        ToolFindPicClick (bpmSrc & "-未勾选")//先找到未勾选然后直接点
        Delay 500
        isCheckResult = ToolFindPic(bpmSrc&"-已勾选")//再获取是否已勾选状态
        notCheckResult = ToolFindPicClick(bpmSrc & "-未勾选")//最后在获取是不是未勾选
        If notCheckResult = False And isCheckResult = True Then 
            repeatCount = 0
            ToolSetCheckBox = True
        End If
    Loop
End Function

//查找图片工具
Function ToolFindPicClick(bmpSrc)
    If ToolFindPic(bmpSrc) Then 
        ToolFindPicClick = ToolPicClick()
    Else 
        ToolFindPicClick = False
    End If
End Function

//查找图片
Function ToolFindPic(bmpSrc)
    Call ae_obj.FindPic(0, 0, 1088, 700, bmpSrc + ".bmp", "050505", 0.7, 0, intX, intY)
    ToolFindPic = intX > 0 And intY > 0
    If intX > 0 And intY > 0 Then 
        //        TracePrint("找到了：" & bmpSrc & " X:" & intX & " Y:" & intY)
        Log("找到了：" & bmpSrc & " X:" & intX & " Y:" & intY)
    Else 
        //        TracePrint("没找到：" & bmpSrc)
        Log("没找到：" & bmpSrc)
    End If
End Function

//在一个矩形内查找图片
Function ToolFindPicClickByRect(bmpSrc,xStart,yStart,xEnd,yEnd)
    Call ae_obj.FindPic(xStart, yStart, xEnd, yEnd, bmpSrc + ".bmp", "050505", 0.7, 0, intX, intY)
    If intX > 0 And intY > 0 Then 
        ToolFindPicClickByRect = ToolPicClick()
        Log("找到了：" & bmpSrc & " X:" & intX & " Y:" & intY)
    Else 
        Log("没找到：" & bmpSrc)
    End If
End Function

//移动后点击
Function ToolPicClick()
    Delay 50
    Call ae_obj.MoveTo(intX, intY)
    Delay 50
    call ae_obj.LeftClick()
    ToolPicClick = True
    Delay 1000
End Function

//移动并点击XY
Function ToolMoveToClick(X, Y)
    Call ae_obj.MoveTo(X, Y)
    Call ae_obj.LeftClick()
End Function

//在10秒内尝试查找图片
Function ToolFindPicWhile10Sec(bmpSrc)
    ToolFindPicWhile10Sec = ToolFindPicWhileSec(bmpSrc, 10)
End Function

//在20秒内尝试查找图片
Function ToolFindPicWhile20Sec(bmpSrc)
    ToolFindPicWhile30Sec = ToolFindPicWhileSec(bmpSrc, 20)
End Function


//在10秒内尝试查找图片
Function ToolFindPicWhile120Sec(bmpSrc)
    ToolFindPicWhile120Sec = ToolFindPicWhileSec(bmpSrc, 120)
End Function


//根据对应时间尝试查找图片
Function ToolFindPicWhileSec(bmpSrc, secend)
    result = ToolFindPicClick(bmpSrc)
    If result = false Then 
        secend = secend - 1
        If secend <> 0 Then 
            ToolFindPicWhileSec = ToolFindPicWhileSec(bmpSrc, secend)
        End If
    Else 
        ToolFindPicWhileSec = True
    End If
End Function

//在10秒内尝试查找图片
Function ToolFindPicByRectWhile10Sec(bmpSrc,xStart,yStart,xEnd,yEnd)
    ToolFindPicByRectWhile10Sec = ToolFindPicByRectWhileSec(bmpSrc,xStart,yStart,xEnd,yEnd,10)
End Function

//根据对应时间尝试查找图片，在矩形内
Function ToolFindPicByRectWhileSec(bmpSrc,xStart,yStart,xEnd,yEnd,secend)
    result = ToolFindPicClickByRect(bmpSrc,xStart,yStart,xEnd,yEnd)
    If result = false Then 
        secend = secend - 1
        If secend <> 0 Then 
            Delay 1000
            ToolFindPicByRectWhileSec = ToolFindPicByRectWhileSec(bmpSrc,xStart,yStart,xEnd,yEnd,secend)
        End If
    Else 
        ToolFindPicByRectWhileSec = True
    End If
End Function

//根据对应时间尝试查找图片,这个方法只给测试用，性能很差
Function ToolFindPicWhileSecOnlyFor(bmpSrc, secend)
    result = ToolFindPic(bmpSrc)
    If result = false Then 
        secend = secend - 1
        If secend <> 0 Then 
            Delay 1
            ToolFindPicWhileSecOnlyFor = ToolFindPicWhileSecOnlyFor(bmpSrc, secend)
        End If
    Else 
        ToolFindPicWhileSecOnlyFor = True
    End If
End Function

//拖动工具
Function ToolDragMove(formX, formY, toX, toY)
    setpX = 0
    setpY = 0
    allSetp = 0
    offsetX = formX - toX
    offsetY = formY - toY
    Call ae_obj.MoveTo(formX, formY)
    Delay 5
    Call ae_obj.LeftDown()
    If offsetX > offsetY Then 
        allSetp = offsetX
    Else 
        allSetp = offsetY
    End If
    For allSetp
        If (setpX < offsetX) Then 
            If (formX > toX) Then 
                finalX= formX - setpX 
            Else 
                finalX= formX + setpX 
            End If
        End If
        If (setpY < offsetY) Then 
            If (formY > toY) Then 
                finalY= formY - setpY
            Else 
                finalY= formY + setpY
            End If
        End If
        Call ae_obj.MoveTo(finalX, finalY)
        setpX = setpX + 1
        setpY = setpY + 1
        Delay 1
    Next
    Delay 5
    Call ae_obj.LeftUp()
    Delay 5
End Function

Function Log(text)
    TracePrint text
    主窗体.日志框.Text = text & vbcrlf & 主窗体.日志框.Text
End Function

//释放对象
Sub OnScriptExit()
    Set ae_obj = Nothing
    LogStop
End Sub

Function TestAEPlugin()
    result = ae_obj.Capture(0, 0, 2000, 2000, "screen.bmp")
    If (result = 1) Then
        RunApp "E:\Program Files (x86)\按键精灵\按键精灵2014\Resource\screen.bmp"
    End If
End Function

Function TestGotoSereach()
    gotoRightSideCount = 5
    gotoLeftSideCount = 5
    Do While True
        Call GotoRightSide()
    Loop
End Function

Function 测试组队
    ToolSetCheckBox ("觉醒业火轮")
    ToolSetCheckBox ("觉醒风转轮")
    ToolSetCheckBox ("觉醒水灵轮")
    ToolSetCheckBox ("觉醒天雷轮")
    ToolSetCheckBox ("御魂")
    index = 1
    For 10
        ToolSetCheckBox ("第"&index&"层")
        index = index +1
    Next
End Function

Event 主窗体.自动剧情错误最大次数滑块.Slide
    主窗体.自动剧情错误最大次数LB.Caption = 主窗体.自动剧情错误最大次数滑块.Value
End Event
Event 主窗体.LoadOver
    主窗体.日志框.Text = ""
    主窗体.自动剧情错误最大次数LB.Caption = 主窗体.自动剧情错误最大次数滑块.Value
    Call setStoryFailCount(0)
    Call Log("窗体内容加载完毕")
End Event

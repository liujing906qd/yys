[General]
SyntaxVersion=2
BeginHotkey=121
BeginHotkeyMod=0
PauseHotkey=19
PauseHotkeyMod=0
StopHotkey=123
StopHotkeyMod=0
RunOnce=1
EnableWindow=
MacroID=ac940ed2-e3d6-4c56-aba5-130490286f61
Description=阴阳师_自动备份_自动备份_自动备份_自动备份
Enable=1
AutoRun=0
[Repeat]
Type=0
Number=1
[SetupUI]
Type=1
QUI=主窗体
[Relative]
SetupOCXFile=
[Comment]

[UIPackage]
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


[Script]
Dim Hwnd//窗口句柄
Dim XY
Dim FILE_PATH
FILE_PATH = "C:\阴阳师脚本\"
LogStart FILE_PATH+"my.log"

PutAttachment "C:\阴阳师脚本","AE.dll"
Private Declare Function AeStartup Lib "C:\阴阳师脚本\AE.dll" () As Long//免注册功能
If (AeStartup() = 0) Then
    Call MsgBox("AE免注册初始化失败！", vbCritical, "VBdemo")
    EndScript
End If
Set ae_obj = CreateObject("AE.AeSoft")
Delay 500
hwnd = ae_obj.GetMousePointWindow()
result = ae_obj.BindWindow(hwnd, "ogl1", "windows3", "windows", 0)
If (result = 1) Then 
    call log("绑定成功，句柄为："&hwnd)
Else 
    Call MsgBox("绑定错误", vbCritical, "VBdemo")
    Set ae_obj = Nothing
    EndScript
End If
Delay 500
ae_obj.SetPath ("E:\Program Files (x86)\按键精灵\按键精灵2014\Resource")


//Call ToolFindPicWhile10Sec("探索10")

StoryFailCount = 0
Call StoryMission()
Call PVETeamMession()
Call MonsterMission()





//Call MonsterMission()
//Call StoryMission()

//Call FindNPCToFight()
//Call FindBossBox()

//Call TestAEPlugin()
//Call 测试组队()


//PVE的关卡进入
Function PVETeamMession()
    If (主窗体.自动组队副本.Value =false)Then 
        Exit Function
    End If
    Log("组队副本，开始")
    ToolSetCheckBox("主界面-卷轴")
    ToolFindPicWhile10Sec("主界面-组队")
    Delay 500
    If ToolFindPic("组队-" & 主窗体.组队副本关卡.ListIndex +1 & "-未勾选") = False Then 
        Call ToolDragMove(230, 400, 230, 140)
        Delay 500
    End If
    ToolSetCheckBox("组队-"&主窗体.组队副本关卡.ListIndex+1)
    ToolSetCheckBox("第" & 主窗体.组队副本层数.ListIndex+1 & "层")
    ToolFindPicWhile10Sec ("创建队伍")
    Rem 创建
    ToolFindPicWhile10Sec ("创建")
    Rem 等待队友
    Do
        result = ToolFindPic("邀请")
        Delay 500
    Loop While result
    Delay 1000//等待开始按钮变正常

    if ToolFindPicClickWithOutFind("开始战斗-已勾选") = false Then
        PVETeamMession = false
    End If
    
//    If (result) Then FIXME 缺少组队超时的处理。如果搜索不到邀请也搜索不到开始战斗，则认为超时。
        Do
            Do
                result = ToolFindPicWhile20Sec("战斗准备")
            Loop While result
            resultForZuduiFight = FindFightEnd()
            If (resultForZuduiFight) Then 
                Log("继续与上次队友组队")
                ToolFindPicWhile10Sec ("确定")
                Goto 等待队友
            End If
            Delay 500
        Loop While resultForZuduiFight = false
//    Else 
//        Log("错误，组队等待超时")
//        Log("错误，组队等待超时")
//        Log ("错误，组队等待超时")
//        Goto 创建
//    End If
End Function


Function ToolFindPicClickWithOutFind(bmpSrc)
    result = ToolFindPicWhile10Sec(bmpSrc)
    If(result = false) Then
        ToolFindPicClickWithOutFind = False
    Else
        Do 
            result = ToolFindPicClick(bmpSrc)
        Loop While result
        ToolFindPicClickWithOutFind = True
    End If
End Function

//自动探索副本
Function MonsterMission()
    If (主窗体.自动探索副本.Value = false)Then 
        Exit Function
    End If
    Log("探索副本，开始")
    Call ToolMoveToClick(522,120)
    For 100
        result = ToolFindPicWhile10Sec("怪物-关卡-"&(主窗体.目标探索关卡.ListIndex+1))
        If result Then 
            Delay 3000
            result = ToolFindPicWhile10Sec("经验-探索")
            If result = true Then 
                If FindNPCToFight() Then
                    If 主窗体.探索副本是否优先剧情副本.Value Then 
                        Log("当前是否有剧情副本")
                        If ToolFindPicByRectWhile10Sec("怪物-地图-返回(新)|怪物-地图-返回(新)2|怪物-地图-返回(新)|怪物-地图-返回(新)3|怪物-地图-返回(新)|怪物-地图-返回(新)4|怪物-地图-返回(新)5", 55, 5, 90, 40) Then 
                            Log("有剧情副本，退出到主界面。等待自动副本开始")
                            Exit Function
                        Else 
                            Log("没有，继续探索副本")
                        End If
                    End If
                End If
            End If
        End If
    Next
End Function

Function setStoryFailCount(value)
    StoryFailCount = value
    主窗体.当前剧情战斗失败次数.Caption = StoryFailCount
End Function

//剧情任务
Function StoryMission()
    Log ("主窗体.自动剧情副本.Value:" & 主窗体.自动剧情副本.Value)
    Log("主窗体.自动剧情错误最大次数滑块.Value:"&主窗体.自动剧情错误最大次数滑块.Value)
    Log("StoryFailCount:"&StoryFailCount)
    If (主窗体.自动剧情副本.Value = False or 主窗体.自动剧情错误最大次数滑块.Value < StoryFailCount)Then 
        Call setStoryFailCount(0)
        Exit Function
    End If
    Log("剧情副本，开始")
    StoryMission = False
    secend = 5 * 60
    loopStoryMission = False
    Do While loopStoryMission = False
        secend = secend - 1
        ToolFindPicClick("剧情-跳过")
        ToolFindPicClick("剧情-对话")
        ToolFindPicClick("剧情-快进")
        ToolFindPicClick("剧情-眼")
        If (isMainSence() = false) Then 
            Call ToolFindPicClick("剧情-问号")
        End If
        ToolFindPicClick("可攻击怪物标志")
        ToolFindPicClick("可攻击怪物标志2")
        result = ToolFindPicClick("战斗准备")
        If result = true Then 
            If (FindFightEnd()) Then //进入战斗
            	
            Else //战斗失败
                If (主窗体.自动剧情错误最大次数滑块.Value < StoryFailCount) Then 
                    Log("剧情战斗失败，超过重试次数"&主窗体.自动剧情错误最大次数滑块.Value)
                    Call setStoryFailCount(0)
                    Exit Function
                Else 
                    Call setStoryFailCount(StoryFailCount + 1)
                    Log("剧情战斗失败，当前失败次数"&StoryFailCount)
                End If
            End If
        End If
        result = ToolFindPicClick("剧情-终止")
        If result = true Then 
            Log("剧情终止，退出剧情任务")
            loopStoryMission = True
            StoryMission =True
        End If
        If secend = 0 Then 
            Log("超时，剧情终止，退出剧情任务")
            Log("超时，剧情终止，退出剧情任务")
            Log("超时，剧情终止，退出剧情任务")
            loopStoryMission = True
            StoryMission = False
        End If
        Delay 500
        Call GotoRightSide()
        //        Call ToolMoveToClick(100,100)//避免新NPC出现卡住
    Loop  
End Function

Function isMainSence()
    isMainSence = ToolFindPic("主界面-卷轴-已勾选|主界面-卷轴-未勾选")
End Function

//搜寻可战斗的NPC
Function FindNPCToFight()
    loopForFindNPCToFight = False
    notCheckResult = False
    isCheckResult = False
    gotoRightSideCount = 5
    gotoLeftSideCount = 0
    
    Log("开始搜索可战斗的怪物")
    Delay 5000
    Call ToolSetCheckBox("战斗锁定出战")
    
    Do While loopForFindNPCToFight = False//只有打完BOSS才会跳出，否则死循环
        resultForFoundBoss = ToolFindPicClick("可攻击BOSS标志")
        If resultForFoundBoss = true Then 
            Log("找到BOSS")
            fightBossResult = FindFightEnd()//战斗
        End If
        resultForFoundNPC = ToolFindPicClick("可攻击怪物标志")
        If resultForFoundNPC = true Then 
            Log("找到小怪")
            fightNPCResult = FindFightEnd()//战斗
            Call Log("攻击小怪成功")
        ElseIf fightBossResult Then
            Log ("loopForFindNPCToFight:" & loopForFindNPCToFight)
            Delay 3000//等待宝箱到位
            If FindBossBox() Then //找BOSS宝箱
                FindNPCToFight = True
                Exit Function
            End If
            Exit Do
        End If
        If resultForFoundBoss = False And resultForFoundNPC = False Then 
            Call Log("没有搜索到小怪和BOSS，向右移动")
            Call GotoRightSide()//向右移动
        End If
        Delay 3000
    Loop
End Function

//查找BOSS宝箱
Function FindBossBox()
    FindBossBox = False//至少找到过一次（隐含逻辑是这个副本将会结束）
    Do
        result = ToolFindPicClick("经验-结束宝箱")
        If result = true Then
            Log("搜索到宝箱") 
            Delay 1500
            Log("开启宝箱，点击左上角退出宝箱界面")
            Call ToolMoveToClick(70, 70)
            FindBossBox = True
            Delay 1500
        Else 
            Log ("没有找到宝箱")
        End If
    Loop While result = True
End Function

//向右移动，如果网游次数超过10次，则向左移动
Function GotoRightSide()
    If (gotoRightSideCount > 0) Then 
        Call ToolDragMove(900,400,100,400)
        gotoRightSideCount = gotoRightSideCount - 1
    Elseif(gotoLeftSideCount > 0)
        Call ToolDragMove(100,400,900,400)
        gotoLeftSideCount = gotoLeftSideCount - 1
    Else 
        gotoLeftSideCount = 5
        gotoRightSideCount = 5
    End If
End Function

//等待战斗结束
Function FindFightEnd()
    Log("进入战斗")
    loopFindFightEndRepeatCount = 5 * 60
    loopFindFightEnd = False
    
    Call ToolSetCheckBox("战斗模式自动")
    
    Do While loopFindFightEnd = False
        loopFindFightEndRepeatCount = loopFindFightEndRepeatCount - 1
        loopFindFightEnd = ToolFindPicClick("战斗结束-胜利1")
        If loopFindFightEnd = true  Then 
            Log("战斗胜利")
            Delay 3000
            ToolFindPicWhile10Sec("战斗结束-胜利2")
            Delay 3000
            ToolFindPicWhile10Sec("战斗结束-胜利3")
            FindFightEnd = True
        Else 
            loopFindFightEnd = ToolFindPicClick("战斗结束-失败")
            If loopFindFightEnd = true Then 
                Log("战斗失败")
                FindFightEnd = False
            End If
            If loopFindFightEndRepeatCount = 0 Then 
                loopFindFightEnd = True
                FindFightEnd = True
                Log("战斗结束，但是因为超时！")
                Log("战斗结束，但是因为超时！")
                Log("战斗结束，但是因为超时！")
                Log("战斗结束，但是因为超时！")
            End If
        End If
        Delay 1000
    Loop  
End Function

















//设置选中框，尝试10次，成功设置返回true
Function ToolSetCheckBox(bpmSrc)
    notCheckResult = False
    isCheckResult = False
    ToolSetCheckBox = False
    repeatCount = 10
    Do While (repeatCount <> 0)
        repeatCount = repeatCount  - 1
        ToolFindPicClick (bpmSrc & "-未勾选")//先找到未勾选然后直接点
        Delay 500
        isCheckResult = ToolFindPic(bpmSrc&"-已勾选")//再获取是否已勾选状态
        notCheckResult = ToolFindPicClick(bpmSrc & "-未勾选")//最后在获取是不是未勾选
        If notCheckResult = False And isCheckResult = True Then 
            repeatCount = 0
            ToolSetCheckBox = True
        End If
    Loop
End Function

//查找图片工具
Function ToolFindPicClick(bmpSrc)
    If ToolFindPic(bmpSrc) Then 
        ToolFindPicClick = ToolPicClick()
    Else 
        ToolFindPicClick = False
    End If
End Function

//查找图片
Function ToolFindPic(bmpSrc)
    Call ae_obj.FindPic(0, 0, 1088, 700, bmpSrc + ".bmp", "050505", 0.7, 0, intX, intY)
    ToolFindPic = intX > 0 And intY > 0
    If intX > 0 And intY > 0 Then 
        //        TracePrint("找到了：" & bmpSrc & " X:" & intX & " Y:" & intY)
        Log("找到了：" & bmpSrc & " X:" & intX & " Y:" & intY)
    Else 
        //        TracePrint("没找到：" & bmpSrc)
        Log("没找到：" & bmpSrc)
    End If
End Function

//在一个矩形内查找图片
Function ToolFindPicClickByRect(bmpSrc,xStart,yStart,xEnd,yEnd)
    Call ae_obj.FindPic(xStart, yStart, xEnd, yEnd, bmpSrc + ".bmp", "050505", 0.7, 0, intX, intY)
    If intX > 0 And intY > 0 Then 
        ToolFindPicClickByRect = ToolPicClick()
        Log("找到了：" & bmpSrc & " X:" & intX & " Y:" & intY)
    Else 
        Log("没找到：" & bmpSrc)
    End If
End Function

//移动后点击
Function ToolPicClick()
    Delay 50
    Call ae_obj.MoveTo(intX, intY)
    Delay 50
    call ae_obj.LeftClick()
    ToolPicClick = True
    Delay 1000
End Function

//移动并点击XY
Function ToolMoveToClick(X, Y)
    Call ae_obj.MoveTo(X, Y)
    Call ae_obj.LeftClick()
End Function

//在10秒内尝试查找图片
Function ToolFindPicWhile10Sec(bmpSrc)
    ToolFindPicWhile10Sec = ToolFindPicWhileSec(bmpSrc, 10)
End Function

//在20秒内尝试查找图片
Function ToolFindPicWhile20Sec(bmpSrc)
    ToolFindPicWhile30Sec = ToolFindPicWhileSec(bmpSrc, 20)
End Function


//在10秒内尝试查找图片
Function ToolFindPicWhile120Sec(bmpSrc)
    ToolFindPicWhile120Sec = ToolFindPicWhileSec(bmpSrc, 120)
End Function


//根据对应时间尝试查找图片
Function ToolFindPicWhileSec(bmpSrc, secend)
    result = ToolFindPicClick(bmpSrc)
    If result = false Then 
        Delay 1000//用作当前方法的延时时间
        secend = secend - 1
        If secend <> 0 Then 
            ToolFindPicWhileSec = ToolFindPicWhileSec(bmpSrc, secend)
        End If
    Else 
        ToolFindPicWhileSec = True
    End If
End Function

//在10秒内尝试查找图片
Function ToolFindPicByRectWhile10Sec(bmpSrc,xStart,yStart,xEnd,yEnd)
    ToolFindPicByRectWhile10Sec = ToolFindPicByRectWhileSec(bmpSrc,xStart,yStart,xEnd,yEnd,10)
End Function

//根据对应时间尝试查找图片，在矩形内
Function ToolFindPicByRectWhileSec(bmpSrc,xStart,yStart,xEnd,yEnd,secend)
    result = ToolFindPicClickByRect(bmpSrc,xStart,yStart,xEnd,yEnd)
    If result = false Then 
        secend = secend - 1
        If secend <> 0 Then 
            Delay 1000
            ToolFindPicByRectWhileSec = ToolFindPicByRectWhileSec(bmpSrc,xStart,yStart,xEnd,yEnd,secend)
        End If
    Else 
        ToolFindPicByRectWhileSec = True
    End If
End Function

//根据对应时间尝试查找图片,这个方法只给测试用，性能很差
Function ToolFindPicWhileSecOnlyFor(bmpSrc, secend)
    result = ToolFindPic(bmpSrc)
    If result = false Then 
        secend = secend - 1
        If secend <> 0 Then 
            Delay 1
            ToolFindPicWhileSecOnlyFor = ToolFindPicWhileSecOnlyFor(bmpSrc, secend)
        End If
    Else 
        ToolFindPicWhileSecOnlyFor = True
    End If
End Function

//拖动工具
Function ToolDragMove(formX, formY, toX, toY)
    setpX = 0
    setpY = 0
    allSetp = 0
    offsetX = formX - toX
    offsetY = formY - toY
    Call ae_obj.MoveTo(formX, formY)
    Delay 5
    Call ae_obj.LeftDown()
    If offsetX > offsetY Then 
        allSetp = offsetX
    Else 
        allSetp = offsetY
    End If
    For allSetp
        If (setpX < offsetX) Then 
            If (formX > toX) Then 
                finalX= formX - setpX 
            Else 
                finalX= formX + setpX 
            End If
        End If
        If (setpY < offsetY) Then 
            If (formY > toY) Then 
                finalY= formY - setpY
            Else 
                finalY= formY + setpY
            End If
        End If
        Call ae_obj.MoveTo(finalX, finalY)
        setpX = setpX + 1
        setpY = setpY + 1
        Delay 1
    Next
    Delay 5
    Call ae_obj.LeftUp()
    Delay 5
End Function

Function Log(text)
    TracePrint text
    主窗体.日志框.Text = text & vbcrlf & 主窗体.日志框.Text
End Function

//释放对象
Sub OnScriptExit()
    Set ae_obj = Nothing
    LogStop
End Sub

Function TestAEPlugin()
    result = ae_obj.Capture(0, 0, 2000, 2000, "screen.bmp")
    If (result = 1) Then
        RunApp "E:\Program Files (x86)\按键精灵\按键精灵2014\Resource\screen.bmp"
    End If
End Function

Function TestGotoSereach()
    gotoRightSideCount = 5
    gotoLeftSideCount = 5
    Do While True
        Call GotoRightSide()
    Loop
End Function

Function 测试组队
    ToolSetCheckBox ("觉醒业火轮")
    ToolSetCheckBox ("觉醒风转轮")
    ToolSetCheckBox ("觉醒水灵轮")
    ToolSetCheckBox ("觉醒天雷轮")
    ToolSetCheckBox ("御魂")
    index = 1
    For 10
        ToolSetCheckBox ("第"&index&"层")
        index = index +1
    Next
End Function

Event 主窗体.自动剧情错误最大次数滑块.Slide
    主窗体.自动剧情错误最大次数LB.Caption = 主窗体.自动剧情错误最大次数滑块.Value
End Event
Event 主窗体.LoadOver
    主窗体.日志框.Text = ""
    主窗体.自动剧情错误最大次数LB.Caption = 主窗体.自动剧情错误最大次数滑块.Value
    Call setStoryFailCount(0)
    Call Log("窗体内容加载完毕")
End Event

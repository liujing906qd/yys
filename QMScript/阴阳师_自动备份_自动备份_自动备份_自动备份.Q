[General]
SyntaxVersion=2
BeginHotkey=121
BeginHotkeyMod=0
PauseHotkey=0
PauseHotkeyMod=0
StopHotkey=123
StopHotkeyMod=0
RunOnce=1
EnableWindow=
MacroID=ca1aef41-2838-41fe-88d3-d83ddba4350a
Description=阴阳师_自动备份_自动备份_自动备份_自动备份
Enable=1
AutoRun=0
[Repeat]
Type=1
Number=1
[SetupUI]
Type=1
QUI=主窗体
[Relative]
SetupOCXFile=
[Comment]

[UIPackage]
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


[Script]
Dim Hwnd//窗口句柄
Dim XY
Dim FILE_PATH
FILE_PATH = "C:\阴阳师脚本\"
LogStart FILE_PATH+"my.log"

PutAttachment "C:\阴阳师脚本","AE.dll"
Private Declare Function AeStartup Lib "C:\阴阳师脚本\AE.dll" () As Long//免注册功能
If (AeStartup() = 0) Then
    Call MsgBox("AE免注册初始化失败！", vbCritical, "VBdemo")
    EndScript
End If
Set ae_obj = CreateObject("AE.AeSoft")
Delay 500
hwnd = ae_obj.GetMousePointWindow()
result = ae_obj.BindWindow(hwnd, "ogl1", "windows3", "windows", 0)
If (result = 1) Then 
    call log("绑定成功，句柄为："&hwnd)
Else 
    Call MsgBox("绑定错误", vbCritical, "VBdemo")
    Set ae_obj = Nothing
    EndScript
End If
Delay 500
ae_obj.SetPath ("E:\Program Files (x86)\按键精灵\按键精灵2014\Resource")


//If (主窗体.自动剧情副本.Value And 主窗体.自动剧情错误次数.Value + 1 <= StoryFailCount )Then 
//    Call StoryMission()
//End If
//
//If (主窗体.自动探索副本.Value)Then 
//    Call MonsterMission()
//End If
//
//If (主窗体.自动组队副本.Value)Then 
//    Call PVETeamMession()
//End If


//Call MonsterMission()
//Call StoryMission()

//Call FindNPCToFight()
//Call FindBossBox()

//Call TestAEPlugin()
//Call 测试组队()

//PVE的关卡进入
Function PVETeamMession()
    ToolSetCheckBox("主界面-卷轴")
    ToolFindPicWhile10Sec("主界面-组队")
    Delay 500
    If ToolFindPic("御魂-未勾选") = False Then 
        Call ToolDragMove(230, 400, 230, 140)
        Delay 500
    End If
    ToolSetCheckBox("御魂")
    ToolSetCheckBox("第2层")
    ToolFindPicWhile10Sec ("创建队伍")
    Rem 创建
    ToolFindPicWhile10Sec ("创建")
    result = ToolFindPicWhile120Sec("开始战斗-已勾选")
    If (result) Then 
        Call PVEFight()
    Else 
        Log("错误，组队等待超时")
        Log("错误，组队等待超时")
        Log ("错误，组队等待超时")
        Goto 创建
    End If
End Function

//PVE的战斗
Function PVEFight()
    Do
        ToolFindPicWhile20Sec("战斗准备")
        resultForZuduiFight = FindFightEnd()
        If (resultForZuduiFight) Then 
            ToolFindPicWhile10Sec ("确定")
            call PVEFight()
        End If
        Delay 500
    Loop While resultForZuduiFight = false
End Function

//自动探索副本
Function MonsterMission()
    Call ToolMoveToClick(522,120)
        For 100
            result = ToolFindPicWhile10Sec("怪物-关卡-"&(主窗体.目标探索关卡.ListIndex+1))
            If result Then 
                Delay 3000
                result = ToolFindPicWhile10Sec("经验-探索")
                If result = true Then 
                    If FindNPCToFight() Then 
                    	Call ToolFindPicByRectWhile10Sec("怪物-地图-返回(新)|怪物-地图-返回(新)2|怪物-地图-返回(新)|怪物-地图-返回(新)3|怪物-地图-返回(新)|怪物-地图-返回(新)4|怪物-地图-返回(新)5",55,5,90,40)
                    End If
                End If
            End If
        Next
End Function


//剧情任务
Function StoryMission()
    Log("开始剧情副本")
    主窗体.当前战斗失败次数.Caption = 0
    StoryMission = False
    secend = 5 * 60
    loopStoryMission = False
    Do While loopStoryMission = False
        secend = secend - 1
        ToolFindPicClick("剧情-跳过")
        ToolFindPicClick("剧情-对话")
        ToolFindPicClick("剧情-快进")
        ToolFindPicClick("剧情-眼")
        ToolFindPicClick("剧情-问号")
        ToolFindPicClick("可攻击怪物标志")
        ToolFindPicClick("可攻击怪物标志2")
        result = ToolFindPicClick("战斗准备")
        If result = true Then 
            If (FindFightEnd()) Then //进入战斗
            	
            Else 
                主窗体.当前战斗失败次数.Caption = StoryFailCount
                If (主窗体.自动剧情错误次数.Value + 1 <= StoryFailCount) Then 
                    Exit Function
                End If
            End If
        End If
        result = ToolFindPicClick("剧情-终止")
        If result = true Then 
            Log("剧情终止，退出剧情任务")
            loopStoryMission = True
            StoryMission =True
        End If
        If secend = 0 Then 
            Log("超时，剧情终止，退出剧情任务")
            Log("超时，剧情终止，退出剧情任务")
            Log("超时，剧情终止，退出剧情任务")
            loopStoryMission = True
            StoryMission = False
        End If
        Delay 500
        Call GotoRightSide()
        //        Call ToolMoveToClick(100,100)//避免新NPC出现卡住
    Loop  
End Function

//搜寻可战斗的NPC
Function FindNPCToFight()
    loopForFindNPCToFight = False
    notCheckResult = False
    isCheckResult = False
    gotoRightSideCount = 5
    gotoLeftSideCount = 0
    
    Call ToolSetCheckBox("战斗锁定出战")
    
    Do While loopForFindNPCToFight = False
        resultForFoundBoss = ToolFindPicClick("可攻击BOSS标志")
        If resultForFoundBoss = true Then 
            fightBossResult = FindFightEnd()//战斗
        End If
        resultForFoundNPC = ToolFindPicClick("可攻击怪物标志")
        If resultForFoundNPC = true Then 
            fightNPCResult = FindFightEnd()//战斗
            Call Log("攻击小怪成功后，判断当前页面是否还有小怪或者BOSS")
            If (fightNPCResult And (resultForFoundBoss = False OR resultForFoundNPC = False)) Then 
                Call Log("没有，则向右移动")
                Call GotoRightSide()//向右移动
                If FindBossBox() Then //找BOSS宝箱
                    Exit Function
                End If
            End If
        ElseIf fightBossResult Then
            Call Log("BOSS战结束后，检查当前是否有宝箱")
            
            If FindBossBox() Then //找BOSS宝箱
                Exit Function
            End If
        End If
        If resultForFoundBoss = False And resultForFoundNPC = False Then 
            Call Log("没有搜索到小怪和BOSS，向右移动")
            Call GotoRightSide()//向右移动
        End If
        If FindBossBox() Then //找BOSS宝箱
            Exit Function
        End If
        Delay 3000
    Loop
    FindNPCToFight = result
End Function

//查找BOSS宝箱
Function FindBossBox()
    FindBossBox = False//至少找到过一次（隐含逻辑是这个副本将会结束）
    Do
        result = ToolFindPicClick("经验-结束宝箱")
        If result = true Then 
            Delay 1500
            Log("开启宝箱，点击左上角退出宝箱界面")
            Call ToolMoveToClick(70, 70)
            FindBossBox = True
            Delay 1500
        Else 
            Log ("没有找到宝箱")
        End If
    Loop While result = True
End Function

//向右移动，如果网游次数超过10次，则向左移动
Function GotoRightSide()
    Log(gotoRightSideCount)
    If (gotoRightSideCount > 0) Then 
        Call ToolDragMove(900,400,100,400)
        gotoRightSideCount = gotoRightSideCount - 1
    Elseif(gotoLeftSideCount > 0)
        Call ToolDragMove(100,400,900,400)
        gotoLeftSideCount = gotoLeftSideCount - 1
    Else 
        gotoLeftSideCount = 5
        gotoRightSideCount = 5
    End If
End Function

//等待战斗结束
Function FindFightEnd()
    Log("进入战斗")
    loopFindFightEndRepeatCount = 5 * 60
    loopFindFightEnd = False
    
    Call ToolSetCheckBox("战斗模式自动")
    
    Do While loopFindFightEnd = False
        loopFindFightEndRepeatCount = loopFindFightEndRepeatCount - 1
        loopFindFightEnd = ToolFindPicClick("战斗结束-胜利1")
        If loopFindFightEnd = true  Then 
            Log("战斗胜利")
            Delay 3000
            ToolFindPicWhile10Sec("战斗结束-胜利2")
            Delay 3000
            ToolFindPicWhile10Sec("战斗结束-胜利3")
            FindFightEnd = True
        Else 
            loopFindFightEnd = ToolFindPicClick("战斗结束-失败")
            If loopFindFightEnd = true Then 
                Log("战斗失败")
                FindFightEnd = False
            End If
            If loopFindFightEndRepeatCount = 0 Then 
                loopFindFightEnd = True
                FindFightEnd = True
                Log("战斗结束，但是因为超时！")
                Log("战斗结束，但是因为超时！")
                Log("战斗结束，但是因为超时！")
                Log("战斗结束，但是因为超时！")
            End If
        End If
        Delay 1000
    Loop  
End Function

















//设置选中框，尝试10次，成功设置返回true
Function ToolSetCheckBox(bpmSrc)
    notCheckResult = False
    isCheckResult = False
    ToolSetCheckBox = False
    repeatCount = 10
    Do While (repeatCount <> 0)
        repeatCount = repeatCount  - 1
        ToolFindPicClick (bpmSrc & "-未勾选")//先找到未勾选然后直接点
        Delay 500
        isCheckResult = ToolFindPic(bpmSrc&"-已勾选")//再获取是否已勾选状态
        notCheckResult = ToolFindPicClick(bpmSrc & "-未勾选")//最后在获取是不是未勾选
        If notCheckResult = False And isCheckResult = True Then 
            repeatCount = 0
            ToolSetCheckBox = True
        End If
    Loop
End Function

//查找图片工具
Function ToolFindPicClick(bmpSrc)
    If ToolFindPic(bmpSrc) Then 
        ToolFindPicClick = ToolPicClick(bmpSrc)
    Else 
        ToolFindPicClick = False
    End If
End Function

Function ToolFindPic(bmpSrc)
    Call ae_obj.FindPic(0, 0, 1088, 700, bmpSrc + ".bmp", "050505", 0.7, 0, intX, intY)
    ToolFindPic = intX > 0 And intY > 0
    If intX > 0 And intY > 0 Then 
        //        TracePrint("找到了：" & bmpSrc & " X:" & intX & " Y:" & intY)
        Log("找到了：" & bmpSrc & " X:" & intX & " Y:" & intY)
    Else 
        //        TracePrint("没找到：" & bmpSrc)
        Log("没找到：" & bmpSrc)
    End If
End Function

Function ToolFindPicClickByRect(bmpSrc,xStart,yStart,xEnd,yEnd)
    Call ae_obj.FindPic(xStart, yStart, xEnd, yEnd, bmpSrc + ".bmp", "050505", 0.7, 0, intX, intY)
    If intX > 0 And intY > 0 Then 
        ToolFindPicClickByRect = ToolPicClick(bmpSrc)
        Log("找到了：" & bmpSrc & " X:" & intX & " Y:" & intY)
    Else 
        Log("没找到：" & bmpSrc)
    End If
End Function

Function ToolPicClick(bmpSrc)
    Delay 50
    Call ae_obj.MoveTo(intX, intY)
    Delay 50
    call ae_obj.LeftClick()
    ToolPicClick = True
    Delay 1000
End Function

//移动并点击XY
Function ToolMoveToClick(X, Y)
    Call ae_obj.MoveTo(X, Y)
    Call ae_obj.LeftClick()
End Function

//在10秒内尝试查找图片
Function ToolFindPicWhile10Sec(bmpSrc)
    ToolFindPicWhile10Sec = ToolFindPicWhileSec(bmpSrc, 10)
End Function

//在20秒内尝试查找图片
Function ToolFindPicWhile20Sec(bmpSrc)
    ToolFindPicWhile30Sec = ToolFindPicWhileSec(bmpSrc, 20)
End Function


//在10秒内尝试查找图片
Function ToolFindPicWhile120Sec(bmpSrc)
    ToolFindPicWhile120Sec = ToolFindPicWhileSec(bmpSrc, 120)
End Function


//根据对应时间尝试查找图片
Function ToolFindPicWhileSec(bmpSrc, secend)
    result = ToolFindPicClick(bmpSrc)
    If result = false Then 
        secend = secend - 1
        If secend <> 0 Then 
            Delay 1000
            ToolFindPicWhileSec = ToolFindPicWhileSec(bmpSrc, secend)
        End If
    Else 
        ToolFindPicWhileSec = True
    End If
End Function

//在10秒内尝试查找图片
Function ToolFindPicByRectWhile10Sec(bmpSrc,xStart,yStart,xEnd,yEnd)
    ToolFindPicByRectWhile10Sec = ToolFindPicByRectWhileSec(bmpSrc,xStart,yStart,xEnd,yEnd,10)
End Function

//根据对应时间尝试查找图片，在矩形内
Function ToolFindPicByRectWhileSec(bmpSrc,xStart,yStart,xEnd,yEnd,secend)
    result = ToolFindPicClickByRect(bmpSrc,xStart,yStart,xEnd,yEnd)
    If result = false Then 
        secend = secend - 1
        If secend <> 0 Then 
            Delay 1000
            ToolFindPicByRectWhileSec = ToolFindPicByRectWhileSec(bmpSrc,xStart,yStart,xEnd,yEnd,secend)
        End If
    Else 
        ToolFindPicByRectWhileSec = True
    End If
End Function

//根据对应时间尝试查找图片,这个方法只给测试用，性能很差
Function ToolFindPicWhileSecOnlyFor(bmpSrc, secend)
    result = ToolFindPic(bmpSrc)
    If result = false Then 
        secend = secend - 1
        If secend <> 0 Then 
            Delay 1
            ToolFindPicWhileSecOnlyFor = ToolFindPicWhileSecOnlyFor(bmpSrc, secend)
        End If
    Else 
        ToolFindPicWhileSecOnlyFor = True
    End If
End Function

Function ToolDragMove(formX, formY, toX, toY)
    setpX = 0
    setpY = 0
    allSetp = 0
    offsetX = formX - toX
    offsetY = formY - toY
    Call ae_obj.MoveTo(formX, formY)
    Delay 5
    Call ae_obj.LeftDown()
    If offsetX > offsetY Then 
        allSetp = offsetX
    Else 
        allSetp = offsetY
    End If
    For allSetp
        If (setpX < offsetX) Then 
            If (formX > toX) Then 
                finalX= formX - setpX 
            Else 
                finalX= formX + setpX 
            End If
        End If
        If (setpY < offsetY) Then 
            If (formY > toY) Then 
                finalY= formY - setpY
            Else 
                finalY= formY + setpY
            End If
        End If
        Call ae_obj.MoveTo(finalX, finalY)
        setpX = setpX + 1
        setpY = setpY + 1
        Delay 1
    Next
    Delay 5
    Call ae_obj.LeftUp()
    Delay 5
End Function

Function Log(text)
    TracePrint text
    主窗体.日志框.Text = text & vbcrlf & 主窗体.日志框.Text
End Function

//释放对象
Sub OnScriptExit()
    Set ae_obj = Nothing
    LogStop
End Sub

Function TestAEPlugin()
    result = ae_obj.Capture(0, 0, 2000, 2000, "screen.bmp")
    If (result = 1) Then
        RunApp "E:\Program Files (x86)\按键精灵\按键精灵2014\Resource\screen.bmp"
    End If
End Function

Function TestGotoSereach()
    gotoRightSideCount = 5
    gotoLeftSideCount = 5
    Do While True
        Call GotoRightSide()
    Loop
End Function

Function 测试组队
    ToolSetCheckBox ("觉醒业火轮")
    ToolSetCheckBox ("觉醒风转轮")
    ToolSetCheckBox ("觉醒水灵轮")
    ToolSetCheckBox ("觉醒天雷轮")
    ToolSetCheckBox ("御魂")
    index = 1
    For 10
        ToolSetCheckBox ("第"&index&"层")
        index = index +1
    Next
End Function

Event 主窗体.自动剧情错误次数.Slide
    主窗体.自动剧情错误次数LB.Caption = 主窗体.自动剧情错误次数.Value + 1
End Event
Event 主窗体.LoadOver
    主窗体.自动剧情错误次数LB.Caption = 主窗体.自动剧情错误次数.Value + 1
    Call Log("窗体内容加载完毕")
End Event
